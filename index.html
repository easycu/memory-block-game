<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"><title>ì•”ê¸° í¼ì¦ PRO v13.0</title><style>:root{--p:#2e7d32;--s:#66bb6a;--bg:#e8f5e9;--grid-bg:#a5d6a7;--cell-bg:#c8e6c9;--bonus:#fdd835;--excel:#1b5e20;--text:#1b5e20;--danger:#ef5350;--mask:#f57c00;--mask-active:#29b6f6}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;user-select:none}body{font-family:-apple-system,'Pretendard',sans-serif;background:var(--bg);color:var(--text);width:100vw;height:100dvh;display:flex;flex-direction:column;align-items:center;overflow:hidden}.screen{display:none;width:100%;max-width:450px;padding:env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;height:100%;flex-direction:column;overflow-y:auto}.active{display:flex}@keyframes shake{0%{transform:translate(1px,1px)}10%{transform:translate(-1px,-2px)rotate(-1deg)}50%{transform:translate(-1px,2px)rotate(-1deg)}100%{transform:translate(1px,-2px)rotate(-1deg)}}.shaking{animation:shake .5s}.float-score{position:absolute;color:var(--bonus);font-weight:900;font-size:1.5rem;pointer-events:none;animation:up 1s ease-out forwards;z-index:100}@keyframes up{to{opacity:0;transform:translateY(-50px)scale(1.5)}}.header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;min-height:70px;width:100%;flex-shrink:0}#grid-container{flex:1;display:flex;align-items:center;justify-content:center;width:100%;position:relative;touch-action:none}#grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;background:var(--grid-bg);padding:6px;border-radius:12px;width:100%;aspect-ratio:1/1}.cell{background:var(--cell-bg);border-radius:4px;aspect-ratio:1/1;transition:.2s}.cell.filled{background:var(--p);transform:scale(.95);box-shadow:0 2px 4px rgba(0,0,0,.1)}.cell.bonus-filled{background:var(--bonus);transform:scale(.95)}.cell.clearing{background:var(--s);transform:scale(1.1);filter:brightness(1.2)}.cell.ghost{background:var(--p);opacity:.5;transform:scale(.95);box-shadow:inset 0 0 0 2px rgba(255,255,255,.3)}.cell.ghost-bonus{background:var(--bonus);opacity:.6;transform:scale(.95)}#tray{display:flex;justify-content:center;align-items:center;gap:8px;height:110px;margin-bottom:15px;background:#fff;border-radius:20px;padding:10px;width:100%;box-shadow:0 4px 10px rgba(0,0,0,.05);flex-shrink:0;touch-action:none}.shape-preview{width:75px;height:75px;display:grid;grid-template-columns:repeat(5,1fr);gap:1px;border-radius:10px;padding:4px;background:#fff}.shape-preview.dragging{opacity:0;visibility:hidden}.preview-cell{aspect-ratio:1/1}.preview-cell.filled{background:var(--p);border-radius:1px}.preview-cell.bonus{background:var(--bonus);border-radius:1px}#drag-helper{position:fixed;z-index:1000;display:none;opacity:1;pointer-events:none}#drag-helper .preview-cell.filled{background:rgba(46,125,50,0.1);border:3px solid var(--p);border-radius:4px;transform:scale(0.95);box-sizing:border-box}#drag-helper .preview-cell.bonus{background:rgba(253,216,53,0.2);border:3px solid var(--bonus);border-radius:4px;transform:scale(0.95);box-sizing:border-box}.menu-btn{width:100%;padding:16px;margin:8px 0;border:none;border-radius:15px;color:#fff;font-size:1.1rem;font-weight:bold;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,.1);flex-shrink:0}.btn-game{background:var(--p)}.btn-manage{background:#8d6e63}.word-card{background:#fff;padding:15px;margin-bottom:10px;border-radius:12px;border-left:5px solid var(--p);box-shadow:0 2px 5px rgba(0,0,0,.05);position:relative;white-space:pre-wrap}.word-list-container{flex:1;overflow-y:auto;margin:15px 0;width:100%}#quiz-modal{position:fixed;top:0;left:0;width:100vw;height:100dvh;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(5px)}.modal-inner{background:#fff;padding:20px;border-radius:25px;width:100%;max-width:380px;display:flex;flex-direction:column;align-items:center;max-height:90vh;overflow-y:auto;position:relative}#q-input{width:100%;height:50px;padding:12px;border:2px solid var(--grid-bg);border-radius:12px;font-size:1rem;margin-bottom:10px;resize:none}#q-text{width:100%;background:var(--bg);padding:15px;border-radius:12px;margin-bottom:15px;text-align:left;max-height:100px;overflow-y:auto;font-weight:500;white-space:pre-wrap}#toast-container{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:99999;pointer-events:none;display:flex;justify-content:center;width:100%}.toast{background:rgba(46,125,50,.95);color:#fff;padding:12px 24px;border-radius:30px;font-weight:bold;opacity:0;transform:translateY(20px);transition:.3s}.toast.show{opacity:1;transform:translateY(0)}.toast.error{background:rgba(231,76,60,.95)}.toast.success{background:rgba(67,160,71,.95)}.toast.info{background:rgba(30,136,229,.95)}.file-ops{display:flex;flex-wrap:wrap;gap:12px;width:100%;margin-top:20px}.btn-outline{flex:1;min-width:30%;background:#fff;color:var(--text);border:3px solid #ccc;padding:18px 5px;border-radius:15px;font-size:1.1rem;font-weight:900;text-align:center}.btn-append{background:#e8f5e9;border-color:var(--p);color:var(--p)}#excel-area{display:none;width:100%;background:#fff;padding:10px;border:2px dashed var(--excel);border-radius:10px;margin-bottom:15px}#excel-input{width:100%;height:60px;padding:8px;border:1px solid #ccc;border-radius:5px;font-family:monospace;white-space:pre}#new-q,#new-a{flex:1;height:60px;padding:10px;border:1px solid #ddd;border-radius:8px;resize:none}#img-maker-area{display:none;width:100%;background:#fff;padding:10px;border-radius:15px;margin-bottom:15px;border:2px solid var(--p)}#editor-viewport{width:100%;height:500px;background:#333;overflow:hidden;position:relative;border-radius:10px;touch-action:none;border:2px solid #666;margin:10px 0}#editor-content{transform-origin:0 0;position:absolute;top:0;left:0;width:100%}#editor-img{display:block;width:100%;height:auto;pointer-events:none;user-select:none}#editor-overlay{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10}.mask-box{position:absolute;background:rgba(245,124,0,0.5);border:2px solid var(--mask);cursor:pointer;box-sizing:border-box;touch-action:none}.mask-box.selected{background:rgba(41,182,246,0.5);border:2px solid var(--mask-active);z-index:100}#temp-mask{position:absolute;background:rgba(41,182,246,0.3);border:2px dashed var(--mask-active);z-index:999;pointer-events:none;display:none}.resize-handle{position:absolute;bottom:-15px;right:-15px;width:30px;height:30px;background:var(--mask-active);border-radius:50%;z-index:101;display:none;box-shadow:0 2px 5px rgba(0,0,0,0.3)}.mask-box.selected .resize-handle{display:block}
/* v13.0: í€´ì¦ˆ í™”ë©´ ì¤Œ/ì´ë™ì„ ìœ„í•œ êµ¬ì¡° ë³€ê²½ */
#quiz-viewport {width:100%; height:300px; background:#333; overflow:hidden; position:relative; border-radius:10px; touch-action:none; margin-bottom:10px;}
#quiz-content {transform-origin:0 0; position:absolute; top:0; left:0; width:100%;}
#quiz-img {width:100%; display:block; pointer-events:none; user-select:none;}
.q-mask{position:absolute;background:var(--mask);border:1px solid #fff;opacity:0.9;transition:0.2s;cursor:pointer;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:0.9rem;text-align:center;word-break:break-all;line-height:1.1;overflow:hidden}
.q-mask.solved{background:rgba(255,255,255,0.3);border:2px solid var(--s);color:blue;pointer-events:none;text-shadow:0 0 2px #fff,0 0 2px #fff}.q-mask.active{background:var(--mask-active);border:2px solid #fff;z-index:10;transform:scale(1.05)}.mode-toggle{display:flex;gap:10px;margin:10px 0}.mode-btn{flex:1;padding:15px;border:2px solid #ddd;border-radius:10px;font-weight:900;cursor:pointer;background:#f5f5f5;color:#666;transition:0.2s}.mode-btn.active{background:var(--p);color:white;border-color:var(--p);transform:scale(1.05);box-shadow:0 4px 10px rgba(0,0,0,0.2)}#quiz-close-btn{position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.5rem;color:#999;cursor:pointer;z-index:100}
</style></head><body><div id="drag-helper"></div><div id="toast-container"></div><div id="screen-home" class="screen active"><div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center"><div style="font-size:4.5rem;margin-bottom:15px">ğŸ§©</div><h1 style="color:var(--text)">ì•”ê¸° í¼ì¦ PRO</h1><div style="background:#fff;padding:10px 25px;border-radius:15px;margin:20px 0;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,.05);color:var(--text)">BEST: <span id="high-score-home" style="color:var(--p)">0</span></div></div><div class="home-btns"><button class="menu-btn btn-game" onclick="startGame()">ê²Œì„ ì‹œì‘</button><button class="menu-btn btn-manage" onclick="showScreen('manage')">ë¬¸ì œ ê´€ë¦¬</button></div></div><div id="screen-game" class="screen"><div class="header"><button onclick="confirmExit()" style="padding:8px 15px;border-radius:10px;border:none;background:#fff;font-weight:bold;color:var(--text);box-shadow:0 2px 5px rgba(0,0,0,.1)">ğŸ  í™ˆ</button><div class="score-box"><div style="font-size:.7rem;color:#666;font-weight:bold">BEST <span id="high-score-game">0</span></div><div style="font-weight:900;font-size:1.5rem;color:var(--p)" id="score">0</div></div></div><div id="grid-container"><div id="grid"></div></div><div id="tray"></div><p style="font-size:.75rem;color:#888;text-align:center;margin-bottom:10px">ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì—¬ ì±„ìš°ì„¸ìš”</p></div><div id="screen-manage" class="screen"><h2 style="margin:15px 0;color:var(--text)">ë¬¸ì œ ê´€ë¦¬</h2><div style="background:#fff;padding:15px;border-radius:15px;box-shadow:0 2px 10px rgba(0,0,0,.05)"><div style="display:flex;gap:5px"><textarea id="new-q" placeholder="ë¬¸ì œ"></textarea><textarea id="new-a" placeholder="ì •ë‹µ"></textarea></div><button onclick="addWord()" class="menu-btn btn-game" style="margin:8px 0;padding:12px;font-size:.9rem">í…ìŠ¤íŠ¸ ë¬¸ì œ ì¶”ê°€</button><button class="menu-btn" style="background:#f57c00;margin:8px 0;padding:10px;font-size:.9rem" onclick="toggleImgMaker()">ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¬¸ì œ ë§Œë“¤ê¸°</button><div id="img-maker-area"><input type="text" id="img-fname" placeholder="íŒŒì¼ëª… (ì˜ˆ: page1.jpg)" style="width:100%;padding:12px;margin-bottom:5px;border:2px solid #ccc;border-radius:8px;font-size:1rem"><button id="btn-load-img" onclick="loadEditorImg()" style="padding:10px;width:100%;background:#555;color:white;border:none;border-radius:8px;font-weight:bold;margin-bottom:10px">ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</button><div class="mode-toggle"><button class="mode-btn active" id="btn-mode-move" onclick="setEditorMode('move')">ğŸ–ï¸ ì´ë™/í™•ëŒ€</button><button class="mode-btn" id="btn-mode-draw" onclick="setEditorMode('draw')">âœï¸ ë¹ˆì¹¸ ê·¸ë¦¬ê¸°</button><button class="mode-btn" onclick="undoLastMask()" style="background:#eee;color:#333;font-weight:normal">â†©ï¸ ì·¨ì†Œ</button></div><p style="font-size:0.8rem;color:#666;margin:5px 0;text-align:center">ì´ë™ ëª¨ë“œì—ì„œ í™•ëŒ€í•˜ê³ ,<br>ê·¸ë¦¬ê¸° ëª¨ë“œì—ì„œ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.</p><div id="editor-viewport"><div id="editor-content"><img id="editor-img" src=""><div id="editor-overlay"></div><div id="temp-mask"></div></div></div><button class="menu-btn btn-game" onclick="saveEditorResult()" style="background:var(--s)" id="btn-save-img">ğŸ§ª í…ŒìŠ¤íŠ¸ í›„ ë“±ë¡</button></div><button class="menu-btn" style="background:var(--excel);margin:0 0 10px 0;padding:10px;font-size:.9rem" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</button><div id="excel-area"><p style="font-size:.75rem;color:var(--excel);margin-bottom:5px"><b>ì‚¬ìš©ë²•:</b> ì—‘ì…€ [ë¬¸ì œ] [ì •ë‹µ] ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°</p><textarea id="excel-input" placeholder="Apple	ì‚¬ê³¼"></textarea><button class="menu-btn btn-game" style="margin:0;padding:8px;font-size:.8rem" onclick="parseExcel()">ì¼ê´„ ë“±ë¡</button></div><div class="file-ops"><button class="btn-outline" onclick="exportJSON()">ë‚´ë³´ë‚´ê¸°</button><button class="btn-outline" onclick="triggerFile('import')">ë®ì–´ì“°ê¸°</button><button class="btn-outline btn-append" onclick="triggerFile('append')">í•©ì¹˜ê¸°</button></div><input type="file" id="file-input" style="display:none" onchange="handleFile(event)" accept=".json"></div><div class="word-list-container" id="word-list"></div><button class="menu-btn" style="background:#8d6e63;margin-top:auto" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button></div><div id="quiz-modal"><div class="modal-inner"><button id="quiz-close-btn" onclick="forceCloseQuiz()">âœ•</button><h2 id="q-title" style="color:var(--p);margin-bottom:10px">ë³µìŠµ íƒ€ì„!</h2>
<div class="mode-toggle" id="quiz-mode-toggle" style="display:none; width:100%"><button class="mode-btn active" id="qm-answer" onclick="setQuizMode('answer')">ğŸ‘† ì •ë‹µ ì°ê¸°</button><button class="mode-btn" id="qm-zoom" onclick="setQuizMode('zoom')">ğŸ–ï¸ í™•ëŒ€/ì´ë™</button></div>
<div id="quiz-content-area" style="width:100%;display:flex;flex-direction:column;align-items:center"></div><textarea id="q-input" placeholder="ì •ë‹µ ì…ë ¥ (ë°•ìŠ¤ í„°ì¹˜ í›„ ì…ë ¥)"></textarea><div id="q-feedback" style="margin-bottom:10px;font-weight:bold;font-size:.9rem;text-align:center;min-height:20px"></div><div style="width:100%;display:flex;gap:5px"><button id="q-giveup" class="menu-btn" onclick="giveUpImgQuiz()" style="background:#999;flex:1;padding:12px;display:none">ğŸ³ï¸ ëª¨ë¦„</button><button id="q-submit" class="menu-btn btn-game" onclick="checkQuizAnswer()" style="flex:2;padding:12px">í™•ì¸</button></div><button id="q-next" class="menu-btn btn-manage" style="display:none;margin:0;padding:12px" onclick="nextQuestion()">ë‹¤ìŒ</button></div></div><script>
function showToast(m,t='normal'){const c=document.getElementById('toast-container'),e=document.createElement('div');e.className=`toast ${t}`;e.innerText=m;c.appendChild(e);void e.offsetWidth;e.classList.add('show');setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},2000)}
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioContext=null;
function initAudio(){if(!audioContext)audioContext=new AudioCtx;if(audioContext.state==='suspended')audioContext.resume()}
const snd={click:t=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(300,t+.1);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.01,t+.1);o.connect(g);g.connect(audioContext.destination);o.start(t);o.stop(t+.1)},place:t=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+.1);g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.01,t+.1);o.type='triangle';o.connect(g);g.connect(audioContext.destination);o.start(t);o.stop(t+.15)},clear:t=>{[523.25,659.25,783.99,1046.5].forEach((f,i)=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.value=f;g.gain.setValueAtTime(.1,t+i*.05);g.gain.exponentialRampToValueAtTime(.01,t+i*.05+.3);o.connect(g);g.connect(audioContext.destination);o.start(t+i*.05);o.stop(t+i*.05+.3)})},correct:t=>{[523.25,659.25,783.99].forEach((f,i)=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(.1,t+i*.1);g.gain.linearRampToValueAtTime(0,t+i*.1+.4);o.connect(g);g.connect(audioContext.destination);o.start(t+i*.1);o.stop(t+i*.1+.4)})},wrong:t=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.linearRampToValueAtTime(100,t+.3);g.gain.setValueAtTime(.1,t);g.gain.linearRampToValueAtTime(0,t+.3);o.connect(g);g.connect(audioContext.destination);o.start(t);o.stop(t+.3)}};
function playSound(t){if(audioContext)snd[t](audioContext.currentTime)}
const SHAPES=[[[0,0],[0,1],[1,0],[1,1]],[[0,0],[1,0],[2,0],[3,0],[4,0]],[[0,0],[0,1],[0,2],[0,3],[0,4]],[[0,0],[1,0],[2,0]],[[0,0],[0,1],[0,2]],[[0,0],[1,0],[2,0],[2,1],[2,2]],[[0,0],[0,1],[0,2],[1,2],[2,2]],[[0,0],[1,1],[2,2],[3,3]],[[0,2],[1,2],[2,0],[2,1],[2,2]],[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,0],[0,1],[1,1],[1,2],[2,2]],[[0,0],[1,0],[1,1]],[[0,0],[0,1],[1,0]],[[0,0],[0,1],[0,2],[0,3]],[[0,0],[1,0],[2,0],[3,0]],[[0,0]]];
let score=0,highScore=localStorage.getItem('puzzleBest8x8')||0,grid=Array(64).fill(0),trayShapes=[],vocabulary=JSON.parse(localStorage.getItem('myVocab'))||[{type:'text',q:"ì‹œì‘!",a:"O",wrongCount:0}],fileMode='import',quizDeck=[],isDragging=false,dragShapeIndex=null,ghostIndices=[],masterR=0,masterC=0;
const TOUCH_OFFSET=60;
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('screen-'+id).classList.add('active');window.scrollTo(0,0);updateScores();if(id==='manage')renderWordList()}
function updateScores(){document.getElementById('high-score-home').innerText=highScore;document.getElementById('high-score-game').innerText=highScore;document.getElementById('score').innerText=score}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function fillDeck(){quizDeck=[];for(let i=0;i<vocabulary.length;i++)quizDeck.push(i);shuffle(quizDeck)}
let currentImgMasks=[], activeMaskIdx=-1, isTestMode=false;
function startQuiz(){if(vocabulary.length<1){refillTray(0);return}isTestMode=false;curQuiz=0;quizCorrect=0;let f=[];let w=vocabulary.map((v,i)=>({idx:i,wrong:v.wrongCount})).filter(v=>v.wrong>0).map(v=>v.idx);if(w.length>0)f.push(w[Math.floor(Math.random()*w.length)]);while(f.length<3){if(quizDeck.length===0)fillDeck();const n=quizDeck.pop();if(vocabulary[n]&&!f.includes(n))f.push(n)}shuffle(f);sessionQuizzes=f.map(i=>vocabulary[i]);document.getElementById('quiz-modal').style.display='flex';showQuestion()}
// v13.0 í€´ì¦ˆ ì¤Œ ê´€ë ¨ ë³€ìˆ˜
let quizMode = 'answer'; // 'answer' or 'zoom'
let qScale=1, qpX=0, qpY=0, qLastDist=0, qIsPinching=false, qIsPanning=false, qStartPanX, qStartPanY;
function showQuestion(){
    const q=sessionQuizzes[curQuiz];const area=document.getElementById('quiz-content-area');area.innerHTML='';
    document.getElementById('q-title').innerText=isTestMode?"[í…ŒìŠ¤íŠ¸] ëª¨ë“  ë¹ˆì¹¸ì„ ë§ì¶”ì„¸ìš”":`ê²€í†  (${curQuiz+1}/3)`;
    document.getElementById('q-feedback').innerText="";document.getElementById('q-input').value="";
    document.getElementById('q-submit').style.display="block";document.getElementById('q-next').style.display="none";
    if(q.type==='image'){
        // v13.0 í€´ì¦ˆ ë·°í¬íŠ¸ êµ¬ì¡° ìƒì„±
        document.getElementById('quiz-mode-toggle').style.display = 'flex';
        setQuizMode('answer'); // ì´ˆê¸°í™”
        const vp = document.createElement('div'); vp.id='quiz-viewport';
        const ct = document.createElement('div'); ct.id='quiz-content';
        const img=document.createElement('img');img.id='quiz-img';img.src='./images/'+q.img;
        img.onload=()=>{renderMasks(q.masks,ct)};img.onerror=()=>{area.innerText="ì´ë¯¸ì§€ ì˜¤ë¥˜: "+q.img};
        ct.appendChild(img); vp.appendChild(ct); area.appendChild(vp);
        // í€´ì¦ˆ ì¤Œ ì´ë²¤íŠ¸ ì—°ê²°
        vp.addEventListener('touchstart', handleQuizTouchStart);
        vp.addEventListener('touchmove', handleQuizTouchMove);
        vp.addEventListener('touchend', handleQuizTouchEnd);
        currentImgMasks=q.masks.map(m=>({...m,solved:false}));activeMaskIdx=-1;
        document.getElementById('q-input').placeholder="ì£¼í™©ìƒ‰ ë°•ìŠ¤ë¥¼ ëˆ„ë¥´ê³  ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
        if(!isTestMode) document.getElementById('q-giveup').style.display="block";
        else document.getElementById('q-giveup').style.display="none";
    }else{
        document.getElementById('quiz-mode-toggle').style.display = 'none';
        const txt=document.createElement('div');txt.id='q-text';txt.innerText=q.q||q;area.appendChild(txt);
        document.getElementById('q-input').placeholder="ì •ë‹µ ì…ë ¥";
        document.getElementById('q-giveup').style.display="none";
    }
}
function setQuizMode(m){
    quizMode=m; qScale=1; qpX=0; qpY=0; updateQuizTransform(); // ëª¨ë“œ ì „í™˜ ì‹œ ìœ„ì¹˜ ì´ˆê¸°í™”
    document.getElementById('qm-answer').className = m==='answer'?'mode-btn active':'mode-btn';
    document.getElementById('qm-zoom').className = m==='zoom'?'mode-btn active':'mode-btn';
    const vp=document.getElementById('quiz-viewport');
    if(vp) vp.style.borderColor = m==='zoom' ? 'var(--p)' : '#666';
}
function updateQuizTransform(){
    const ct=document.getElementById('quiz-content'); if(ct) ct.style.transform=`translate(${qpX}px,${qpY}px) scale(${qScale})`;
}
function handleQuizTouchStart(e){
    if(quizMode!=='zoom') return;
    if(e.touches.length===2){qIsPinching=true;qLastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);return}
    qIsPanning=true;qStartPanX=e.touches[0].clientX-qpX;qStartPanY=e.touches[0].clientY-qpY;
}
function handleQuizTouchMove(e){
    if(quizMode!=='zoom') return; e.preventDefault();
    if(qIsPinching&&e.touches.length===2){const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);const delta=dist/qLastDist;qScale=Math.min(Math.max(qScale*delta,1),5);qLastDist=dist;updateQuizTransform();return}
    if(qIsPanning){qpX=e.touches[0].clientX-qStartPanX;qpY=e.touches[0].clientY-qStartPanY;updateQuizTransform()}
}
function handleQuizTouchEnd(e){qIsPinching=false;qIsPanning=false;}
function renderMasks(m,c){
    c.querySelectorAll('.q-mask').forEach(e=>e.remove());
    m.forEach((k,i)=>{
        if(currentImgMasks[i].solved)return;
        const e=document.createElement('div');e.className='q-mask';e.style.left=k.x+'%';e.style.top=k.y+'%';e.style.width=k.w+'%';e.style.height=k.h+'%';e.innerText="?";
        e.onclick=(ev)=>{
            if(quizMode==='zoom') return; // ì¤Œ ëª¨ë“œì¼ ë• í„°ì¹˜ ë¬´ì‹œ
            activateMask(i,e); ev.stopPropagation();
        };
        c.appendChild(e)
    })
}
function activateMask(i,e){
    document.querySelectorAll('.q-mask').forEach(el=>el.classList.remove('active'));e.classList.add('active');activeMaskIdx=i;
    document.getElementById('q-input').focus();document.getElementById('q-input').placeholder="ì´ ë¹ˆì¹¸ì˜ ì •ë‹µì€?";
    // v13.0: ì¤Œ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤ (í™”ë©´ íŠ€ëŠ” ê²ƒ ë°©ì§€)
    if(quizMode==='answer') e.scrollIntoView({behavior:'smooth',block:'center'});
}
function checkQuizAnswer(){
    const q=sessionQuizzes[curQuiz];const i=document.getElementById('q-input').value.trim();const fb=document.getElementById('q-feedback');const cl=s=>s.replace(/\s/g,"").toUpperCase();
    if(q.type==='image'){
        if(activeMaskIdx===-1){showToast("ë¹ˆì¹¸ì„ ì„ íƒí•˜ì„¸ìš”!",'error');return}
        const ans = currentImgMasks[activeMaskIdx].a;
        if(cl(i)===cl(ans)){
            playSound('correct');currentImgMasks[activeMaskIdx].solved=true;
            const el=document.querySelector('.q-mask.active');
            el.classList.add('solved'); el.classList.remove('active');
            el.innerText = ans; fb.innerHTML = `<span style='color:var(--s)'>ì •ë‹µ! ${ans}</span>`; 
            document.getElementById('q-input').value="";
            if(currentImgMasks.every(m=>m.solved)){fb.innerHTML=`<span style='color:var(--s)'>ì™„ë²½í•©ë‹ˆë‹¤! âœ¨</span>`;finishQuestion(true)}
            else {
                const nextIdx = currentImgMasks.findIndex(m => !m.solved);
                if(nextIdx !== -1) {activeMaskIdx = nextIdx; setTimeout(() => {const nextEl = document.querySelectorAll('.q-mask')[nextIdx]; if(nextEl) nextEl.click();}, 300);}
            }
        }else{playSound('wrong');fb.innerHTML=`<span style='color:var(--danger)'>ì˜¤ë‹µì…ë‹ˆë‹¤.</span>`}
    }else{
        const ans=q.a;const isO=(cl(i)==="O"||cl(i)==="X")?(cl(ans).charAt(0)===cl(i)):(cl(i)===cl(ans));
        if(isO){fb.innerHTML=`<span style='color:var(--s)'>ì •ë‹µ! âœ¨<br>${ans}</span>`;finishQuestion(true)}
        else{fb.innerHTML=`<span style='color:var(--danger)'>ì˜¤ë‹µ! âŒ<br>${ans}</span>`;finishQuestion(false)}
    }
}
function giveUpImgQuiz(){
    if(!confirm("ì •ë‹µì„ ë³´ê³  ë„˜ì–´ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const fb=document.getElementById('q-feedback');
    fb.innerHTML = `<span style='color:var(--danger)'>ì •ë‹µ ê³µê°œ!</span>`;
    document.querySelectorAll('.q-mask').forEach((el, idx) => {el.className = 'q-mask solved'; el.innerText = currentImgMasks[idx].a;});
    finishQuestion(false);
}
function forceCloseQuiz() {document.getElementById('quiz-modal').style.display='none';}
function finishQuestion(isCorrect){
    if(isTestMode){if(isCorrect && confirm("í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì´ëŒ€ë¡œ ì €ì¥í• ê¹Œìš”?")){realSaveImgQuiz();} document.getElementById('quiz-modal').style.display='none'; return;}
    if(isCorrect){playSound('correct');quizCorrect++;if(sessionQuizzes[curQuiz].wrongCount>0)sessionQuizzes[curQuiz].wrongCount--}
    else{playSound('wrong');sessionQuizzes[curQuiz].wrongCount=(sessionQuizzes[curQuiz].wrongCount||0)+1}
    localStorage.setItem('myVocab',JSON.stringify(vocabulary));
    document.getElementById('q-submit').style.display="none";
    document.getElementById('q-giveup').style.display="none";
    document.getElementById('q-next').style.display="block";
}
function nextQuestion(){curQuiz++;if(curQuiz<3)showQuestion();else{document.getElementById('quiz-modal').style.display='none';if(quizCorrect>=2)refillTray(quizCorrect);else{showToast("ë¶ˆí•©ê²©!",'error');setTimeout(startQuiz,1000)}}}
// ì—ë””í„° & ìˆ˜ì • ê¸°ëŠ¥
let makerImgLoaded=false,makerMasks=[],editMode='move',selectedMaskIdx=-1, editTargetIdx = -1; // ìˆ˜ì • íƒ€ê²Ÿ
let scale=1,pX=0,pY=0,lastDist=0,isPinching=false,isPanning=false,startPanX,startPanY;
function toggleImgMaker(){const e=document.getElementById('img-maker-area');e.style.display=e.style.display==='none'?'block':'none'; resetEditor();}
function resetEditor(){ editTargetIdx=-1; makerMasks=[]; document.getElementById('img-fname').value=""; document.getElementById('editor-img').src=""; makerImgLoaded=false; document.getElementById('btn-save-img').innerText="ğŸ§ª í…ŒìŠ¤íŠ¸ í›„ ë“±ë¡"; }
function editImgQuiz(idx){
    const v = vocabulary[idx];
    if(v.type !== 'image') return;
    editTargetIdx = idx;
    document.getElementById('img-maker-area').style.display='block';
    document.getElementById('img-fname').value = v.img;
    makerMasks = JSON.parse(JSON.stringify(v.masks)); // ê¹Šì€ ë³µì‚¬
    loadEditorImg(true); // ì´ë¯¸ì§€ ë¡œë“œ
    document.getElementById('btn-save-img').innerText = "ğŸ§ª í…ŒìŠ¤íŠ¸ í›„ ìˆ˜ì •(ë®ì–´ì“°ê¸°)";
    window.scrollTo(0,0);
}
function loadEditorImg(isEdit=false){
    const f=document.getElementById('img-fname').value.trim();if(!f)return showToast("íŒŒì¼ëª… ì…ë ¥",'error');
    const b=document.getElementById('btn-load-img'); b.innerText="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."; b.disabled=true;
    const i=document.getElementById('editor-img');i.src="./images/"+f;
    i.onload=()=>{
        makerImgLoaded=true; scale=1;pX=0;pY=0;updateTransform();renderMakerMasks();
        showToast("ë¡œë“œ ì„±ê³µ",'success'); b.innerText="ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°"; b.disabled=false;
    };
    i.onerror=()=>{showToast("ì‹¤íŒ¨: "+f,'error');makerImgLoaded=false; b.innerText="ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°"; b.disabled=false;}}
function setEditorMode(m){editMode=m;document.getElementById('btn-mode-move').className=m==='move'?'mode-btn active':'mode-btn';document.getElementById('btn-mode-draw').className=m==='draw'?'mode-btn active':'mode-btn';selectedMaskIdx=-1;renderMakerMasks()}
function undoLastMask() {
    if(makerMasks.length === 0) return showToast("ì·¨ì†Œí•  ë‚´ì—­ ì—†ìŒ", 'error');
    makerMasks.pop(); selectedMaskIdx = -1; renderMakerMasks(); showToast("ì‹¤í–‰ ì·¨ì†Œ", 'info');
}
const vp=document.getElementById('editor-viewport');const ct=document.getElementById('editor-content');
vp.addEventListener('touchstart',e=>{
    if(!makerImgLoaded)return;
    if(e.touches.length===2){isPinching=true;lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);return}
    if(editMode==='move'){isPanning=true;startPanX=e.touches[0].clientX-pX;startPanY=e.touches[0].clientY-pY}
    else if(editMode==='draw'){handleDrawStart(e)}
});
vp.addEventListener('touchmove',e=>{
    if(!makerImgLoaded)return;
    if(editMode==='move' || isPinching || isPanning) e.preventDefault(); 
    if(editMode==='draw') e.preventDefault();
    if(isPinching&&e.touches.length===2){const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);const delta=dist/lastDist;scale=Math.min(Math.max(scale*delta,1),5);lastDist=dist;updateTransform();return}
    if(isPanning){pX=e.touches[0].clientX-startPanX;pY=e.touches[0].clientY-startPanY;updateTransform()}
    else if(editMode==='draw'){handleDrawMove(e)}
});
vp.addEventListener('touchend',e=>{isPinching=false;isPanning=false;if(editMode==='draw')handleDrawEnd(e)});
function updateTransform(){ct.style.transform=`translate(${pX}px,${pY}px) scale(${scale})`}
let drawStartX,drawStartY,isResizing=false,isMovingMask=false;
function getRelCoord(e){const r=document.getElementById('editor-img').getBoundingClientRect();const cx=e.touches?e.changedTouches[0].clientX:e.clientX;const cy=e.touches?e.changedTouches[0].clientY:e.clientY;const xPct=((cx-r.left)/r.width)*100;const yPct=((cy-r.top)/r.height)*100;return{x:xPct,y:yPct}}
function handleDrawStart(e){
    const p=getRelCoord(e);
    if(selectedMaskIdx!==-1){
        const m=makerMasks[selectedMaskIdx]; const r=document.getElementById('editor-img').getBoundingClientRect();
        const mx=m.x/100*r.width, my=m.y/100*r.height, mw=m.w/100*r.width, mh=m.h/100*r.height;
        const px=p.x/100*r.width, py=p.y/100*r.height;
        if(px>mx+mw-30 && px<mx+mw+30 && py>my+mh-30 && py<my+mh+30){isResizing=true;return}
        if(px>mx && px<mx+mw && py>my && py<my+mh){isMovingMask=true;drawStartX=p.x;drawStartY=p.y;return}
    }
    if(e.target.classList.contains('mask-box')){const idx=parseInt(e.target.dataset.idx); selectMask(idx); isMovingMask=true; drawStartX=p.x; drawStartY=p.y;} 
    else {selectedMaskIdx=-1; renderMakerMasks(); drawStartX=p.x; drawStartY=p.y; const tm=document.getElementById('temp-mask'); tm.style.display='block'; tm.style.left=drawStartX+'%'; tm.style.top=drawStartY+'%'; tm.style.width='0%'; tm.style.height='0%';}
}
function handleDrawMove(e){
    const p=getRelCoord(e);
    if(isResizing && selectedMaskIdx!==-1){const m=makerMasks[selectedMaskIdx]; m.w=Math.max(1,p.x-m.x); m.h=Math.max(1,p.y-m.y); renderMakerMasks();} 
    else if(isMovingMask && selectedMaskIdx!==-1){const m=makerMasks[selectedMaskIdx]; const dx=p.x-drawStartX; const dy=p.y-drawStartY; m.x+=dx; m.y+=dy; drawStartX=p.x; drawStartY=p.y; renderMakerMasks();} 
    else {const tm=document.getElementById('temp-mask'); const l=Math.min(drawStartX,p.x), t=Math.min(drawStartY,p.y), wd=Math.abs(p.x-drawStartX), ht=Math.abs(p.y-drawStartY); tm.style.left=l+'%'; tm.style.top=t+'%'; tm.style.width=wd+'%'; tm.style.height=ht+'%';}
}
function handleDrawEnd(e){
    document.getElementById('temp-mask').style.display='none';
    if(isResizing||isMovingMask){isResizing=false;isMovingMask=false;return}
    const p=getRelCoord(e);
    if(Math.abs(p.x-drawStartX)>1 && Math.abs(p.y-drawStartY)>1){const a=prompt("ì •ë‹µ ì…ë ¥"); if(a){makerMasks.push({x:Math.min(drawStartX,p.x), y:Math.min(drawStartY,p.y), w:Math.abs(p.x-drawStartX), h:Math.abs(p.y-drawStartY), a:a}); selectMask(makerMasks.length-1);}}
}
function selectMask(i){selectedMaskIdx=i;renderMakerMasks()}
function renderMakerMasks(){
    const ov=document.getElementById('editor-overlay');ov.innerHTML='';
    makerMasks.forEach((m,i)=>{
        const d=document.createElement('div');d.className=selectedMaskIdx===i?'mask-box selected':'mask-box';d.dataset.idx=i;
        d.style.left=m.x+'%';d.style.top=m.y+'%';d.style.width=m.w+'%';d.style.height=m.h+'%';
        if(selectedMaskIdx===i){const h=document.createElement('div');h.className='resize-handle';d.appendChild(h); const del=document.createElement('div');del.innerText='âŒ';del.style.cssText='position:absolute;top:-15px;right:-15px;font-size:12px;background:white;border-radius:50%;cursor:pointer;padding:2px;box-shadow:0 1px 3px rgba(0,0,0,0.3)'; del.onclick=(e)=>{e.stopPropagation();if(confirm("ì‚­ì œ?")){makerMasks.splice(i,1);selectedMaskIdx=-1;renderMakerMasks()}};d.appendChild(del)}
        ov.appendChild(d)
    })
}
function saveEditorResult(){startTestRun();} // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ëˆ„ë¥´ë©´ í…ŒìŠ¤íŠ¸ ëŸ° ì‹œì‘
function startTestRun(){if(!makerImgLoaded||makerMasks.length===0)return showToast("ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”",'error');const f=document.getElementById('img-fname').value.trim();isTestMode=true;curQuiz=0;quizCorrect=0;sessionQuizzes=[{type:'image',img:f,masks:[...makerMasks],wrongCount:0,q:"[í…ŒìŠ¤íŠ¸] "+f}];document.getElementById('quiz-modal').style.display='flex';showQuestion()}
function realSaveImgQuiz(){
    const f=document.getElementById('img-fname').value.trim();
    if(editTargetIdx !== -1) {
        // ìˆ˜ì • ëª¨ë“œ: ë®ì–´ì“°ê¸°
        vocabulary[editTargetIdx] = {type:'image', img:f, masks:[...makerMasks], wrongCount:vocabulary[editTargetIdx].wrongCount, q:"[ì´ë¯¸ì§€] "+f};
        showToast("ìˆ˜ì • ì™„ë£Œ!", 'success');
    } else {
        // ì‹ ê·œ ìƒì„±
        vocabulary.push({type:'image',img:f,masks:[...makerMasks],wrongCount:0,q:"[ì´ë¯¸ì§€] "+f});
        showToast("ë“±ë¡ ì™„ë£Œ!",'success');
    }
    localStorage.setItem('myVocab',JSON.stringify(vocabulary));renderWordList();
    document.getElementById('img-maker-area').style.display='none'; // ë‹«ê¸°
    makerMasks=[];renderMakerMasks();fillDeck();
}
function refillTray(c){trayShapes=[0,1,2].map(()=>[...SHAPES[Math.floor(Math.random()*SHAPES.length)]]);if(c===3){const b=[[0,0]];b.isBonus=true;trayShapes.push(b)}renderTray();checkGameOver()}
function renderTray(){const t=document.getElementById('tray');t.innerHTML="";trayShapes.forEach((s,i)=>{if(!s)return;const d=document.createElement('div');d.className='shape-preview';d.id=`shape-${i}`;d.addEventListener('touchstart',e=>handleStart(e,i),{passive:false});d.addEventListener('touchmove',handleMove,{passive:false});d.addEventListener('touchend',handleEnd,{passive:false});d.addEventListener('mousedown',e=>handleStart(e,i));for(let r=0;r<5;r++)for(let c=0;c<5;c++){const el=document.createElement('div');el.className=s.some(p=>p[0]===r&&p[1]===c)?(s.isBonus?'preview-cell filled bonus':'preview-cell filled'):'preview-cell';el.dataset.r=r;el.dataset.c=c;d.appendChild(el)}t.appendChild(d)})}
function handleStart(e,i){if(e.cancelable)e.preventDefault();isDragging=true;dragShapeIndex=i;const s=trayShapes[i],h=document.getElementById('drag-helper');h.innerHTML="";const cs=document.querySelector('.cell').getBoundingClientRect().width;let minR=5,minC=5,maxR=-1,maxC=-1;s.forEach(p=>{minR=Math.min(minR,p[0]);maxR=Math.max(maxR,p[0]);minC=Math.min(minC,p[1]);maxC=Math.max(maxC,p[1])});const centerC=(minC+maxC)/2;let minDist=999;s.forEach(p=>{if(p[0]===maxR){const dist=Math.abs(p[1]-centerC);if(dist<minDist){minDist=dist;masterR=p[0];masterC=p[1]}}});h.style.display="grid";h.style.gridTemplateRows=`repeat(${maxR-minR+1},${cs}px)`;h.style.gridTemplateColumns=`repeat(${maxC-minC+1},${cs}px)`;h.style.gap="1px";h.style.width=(maxC-minC+1)*cs+(maxC-minC)+'px';h.style.height=(maxR-minR+1)*cs+(maxR-minR)+'px';for(let r=minR;r<=maxR;r++)for(let c=minC;c<=maxC;c++){const el=document.createElement('div');const ip=s.some(p=>p[0]===r&&p[1]===c);el.className=ip?(s.isBonus?'preview-cell filled bonus':'preview-cell filled'):'preview-cell';if(!ip)el.style.visibility="hidden";h.appendChild(el)}moveHelper(e);e.currentTarget.classList.add('dragging');playSound('click');ghostIndices=[]}
function handleMove(e){if(!isDragging)return;if(e.cancelable)e.preventDefault();moveHelper(e);updateGhost(e)}
function handleEnd(e){if(!isDragging)return;isDragging=false;document.getElementById('drag-helper').style.display="none";document.querySelectorAll('.shape-preview').forEach(el=>el.classList.remove('dragging'));if(ghostIndices.length>0)placeBlock(ghostIndices,trayShapes[dragShapeIndex]);else clearGhost();ghostIndices=[];dragShapeIndex=null}
function moveHelper(e){const h=document.getElementById('drag-helper'),cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY,cs=document.querySelector('.cell').getBoundingClientRect().width,s=trayShapes[dragShapeIndex];let minR=5,minC=5;s.forEach(p=>{minR=Math.min(minR,p[0]);minC=Math.min(minC,p[1])});const relX=(masterC-minC)*cs+(cs/2);const relY=(masterR-minR)*cs+(cs/2);h.style.left=(cx-relX)+'px';h.style.top=(cy-TOUCH_OFFSET-relY)+'px'}
function updateGhost(e){clearGhost();ghostIndices=[];const cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY,cs=document.querySelector('.cell').getBoundingClientRect().width,h=document.getElementById('drag-helper');h.style.display='none';const el=document.elementFromPoint(cx,cy-TOUCH_OFFSET);h.style.display='grid';if(!el||!el.classList.contains('cell'))return;const id=parseInt(el.id.split('-')[1]),tr=Math.floor(id/8),tc=id%8,s=trayShapes[dragShapeIndex],sr=tr-masterR,sc=tc-masterC,inds=[];const fit=s.every(p=>{const nr=p[0]+sr,nc=p[1]+sc;if(nr>=0&&nr<8&&nc>=0&&nc<8&&grid[nr*8+nc]===0){inds.push(nr*8+nc);return true}return false});if(fit){ghostIndices=inds;inds.forEach(i=>document.getElementById('cell-'+i).classList.add(s.isBonus?'ghost-bonus':'ghost'))}}
function clearGhost(){document.querySelectorAll('.cell').forEach(c=>{c.classList.remove('ghost');c.classList.remove('ghost-bonus')})}
function placeBlock(i,s){playSound('place');i.forEach(x=>{grid[x]=1;document.getElementById('cell-'+x).className=s.isBonus?'cell bonus-filled':'cell filled'});trayShapes[dragShapeIndex]=null;renderTray();checkLines();if(trayShapes.every(v=>v===null))startQuiz();else checkGameOver()}
function checkLines(){let r=[],c=[];for(let i=0;i<8;i++){if(grid.slice(i*8,i*8+8).every(v=>v===1))r.push(i);let l=[];for(let j=0;j<8;j++)l.push(grid[j*8+i]);if(l.every(v=>v===1))c.push(i)}if(r.length+c.length>0){playSound('clear');const g=document.getElementById('grid');g.classList.remove('shaking');void g.offsetWidth;g.classList.add('shaking');const sc=(r.length+c.length)*10*(r.length+c.length);score+=sc;updateScores();const e=document.createElement('div');e.className='float-score';e.innerText=`+${sc}`;document.getElementById('grid-container').appendChild(e);setTimeout(()=>e.remove(),1000);if(score>highScore){highScore=score;localStorage.setItem('puzzleBest8x8',highScore)}}r.forEach(i=>{for(let k=0;k<8;k++)animateClear(i*8+k)});c.forEach(i=>{for(let k=0;k<8;k++)animateClear(k*8+i)})}
function animateClear(i){grid[i]=0;const e=document.getElementById('cell-'+i);e.classList.add('clearing');setTimeout(()=>e.className='cell',300)}
function checkGameOver(){const ok=trayShapes.some(s=>{if(!s)return false;for(let i=0;i<64;i++){const r=Math.floor(i/8),c=i%8;if(s.every(p=>{const nr=r+p[0],nc=c+p[1];return nr<8&&nc<8&&grid[nr*8+nc]===0}))return true}return false});if(!ok&&!trayShapes.every(v=>v===null)){showToast(`ê²Œì„ ì¢…ë£Œ! ì ìˆ˜: ${score}`,'info');setTimeout(()=>showScreen('home'),2000)}}
function startGame(){initAudio();if(vocabulary.length<1)return showToast("ë¬¸ì œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!",'error');showScreen('game');initGame()}
function initGame(){score=0;grid.fill(0);updateScores();const g=document.getElementById('grid');g.innerHTML="";for(let i=0;i<64;i++){const c=document.createElement('div');c.className='cell';c.id='cell-'+i;g.appendChild(c)}refillTray(0);fillDeck()}
function addWord(){const q=document.getElementById('new-q').value.trim(),a=document.getElementById('new-a').value.trim();if(q&&a){if(isDuplicate(q,a))return showToast("ì¤‘ë³µ!",'error');vocabulary.push({type:'text',q,a,wrongCount:0});localStorage.setItem('myVocab',JSON.stringify(vocabulary));renderWordList();document.getElementById('new-q').value="";document.getElementById('new-a').value="";showToast("ì¶”ê°€ë¨!",'success');fillDeck()}else showToast("ì…ë ¥í•˜ì„¸ìš”",'error')}
function isDuplicate(q,a){const nQ=q.replace(/\s/g,"").toUpperCase(),nA=a.replace(/\s/g,"").toUpperCase();return vocabulary.some(v=>v.type!=='image' && v.q.replace(/\s/g,"").toUpperCase()===nQ&&v.a.replace(/\s/g,"").toUpperCase()===nA)}
function toggleExcel(){const e=document.getElementById('excel-area');e.style.display=e.style.display==='none'?'block':'none'}
function parseExcel(){const r=document.getElementById('excel-input').value;if(!r.trim())return showToast("ì…ë ¥í•˜ì„¸ìš”",'error');const rows=r.split('\n');let c=0;rows.forEach(w=>{const s=w.split('\t');if(s.length>=2){const q=s[0].trim(),a=s[1].trim();if(q&&a&&!isDuplicate(q,a)){vocabulary.push({type:'text',q,a,wrongCount:0});c++}}});localStorage.setItem('myVocab',JSON.stringify(vocabulary));renderWordList();document.getElementById('excel-input').value="";showToast(`${c}ê°œ ì¶”ê°€ë¨`,'success');toggleExcel();fillDeck()}
function renderWordList(){document.getElementById('word-list').innerHTML=vocabulary.map((v,i)=>{
    const content = v.type === 'image' ? `<b>[ì´ë¯¸ì§€] ${v.img}</b><br><small>ë¹ˆì¹¸ ${v.masks.length}ê°œ</small>` : `<b>${v.q}</b><br><small>${v.a}</small>`;
    const editBtn = v.type === 'image' ? `<button onclick="editImgQuiz(${i})" style="position:absolute;right:40px;top:10px;border:none;background:none;font-size:1.2rem;color:#666">âœ</button>` : ''; // v13.0: ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€
    return `<div class="word-card">${content}${v.wrongCount>0?`<span style="color:var(--danger);font-size:0.7rem"><br>ğŸ”¥ë³µìŠµ(${v.wrongCount})</span>`:''}${editBtn}<button onclick="deleteWord(${i})" style="position:absolute;right:10px;top:10px;border:none;background:none;font-size:1.2rem;color:#ccc">âœ•</button></div>`
}).reverse().join('')}
function deleteWord(i){if(confirm("ì‚­ì œ?")){vocabulary.splice(i,1);localStorage.setItem('myVocab',JSON.stringify(vocabulary));renderWordList();fillDeck()}}
function triggerFile(m){fileMode=m;document.getElementById('file-input').click()}
function handleFile(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(fileMode==='append'){let c=0;d.forEach(i=>{
    if(i.type==='image'){vocabulary.push({...i,wrongCount:i.wrongCount||0});c++}
    else if(!isDuplicate(i.q,i.a)){vocabulary.push({...i,type:'text',wrongCount:i.wrongCount||0});c++}
});showToast(`${c}ê°œ ì¶”ê°€`,'info')}else{vocabulary=d.map(v=>({...v,type:v.type||'text',wrongCount:v.wrongCount||0}));showToast("êµì²´ ì™„ë£Œ",'success')}localStorage.setItem('myVocab',JSON.stringify(vocabulary));renderWordList();fillDeck()}catch(err){showToast("ì˜¤ë¥˜",'error')}e.target.value=''};r.readAsText(f)}
function exportJSON(){const b=new Blob([JSON.stringify(vocabulary,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=`quiz_backup.json`;a.click()}
function confirmExit(){if(confirm("ë‚˜ê°ˆê¹Œìš”?"))showScreen('home')}
window.onload=updateScores;window.addEventListener('mousemove',e=>{if(isDragging){moveHelper(e);updateGhost(e)}});window.addEventListener('mouseup',e=>{if(isDragging)handleTouchEnd(e)});
</script></body></html>
