<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì•”ê¸° í¼ì¦ PRO (Mobile Fix)</title>
    <style>
        :root { 
            --p: #3498db; --s: #2ecc71; --bg: #f0f2f5; 
            --preview: #e67e22; --danger: #e74c3c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, 'Pretendard', sans-serif; 
            background: var(--bg); margin: 0; 
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh; height: -webkit-fill-available;
            overflow: hidden; touch-action: none; 
        }
        
        /* í™”ë©´ ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .screen { 
            display: none; width: 100%; max-width: 450px; 
            padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom) 15px; 
            height: 100%; flex-direction: column; 
        }
        .active { display: flex; }
        
        /* ìƒë‹¨ ì ìˆ˜íŒ ì˜ì—­ ê°œì„  */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 5px; min-height: 60px;
        }
        .score-box { text-align: right; line-height: 1.2; }
        
        /* ê²Œì„ ë³´ë“œ: í™”ë©´ ë†’ì´ì— ë”°ë¼ ìë™ ì¶•ì†Œ */
        #grid-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            width: 100%; min-height: 0; /* ì¤‘ìš”: flex ì•ˆì—ì„œ ì¶•ì†Œ ê°€ëŠ¥í•˜ê²Œ í•¨ */
        }
        #grid { 
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; 
            background: #cbd5e0; padding: 6px; border-radius: 12px; 
            width: 100%; max-width: 380px; aspect-ratio: 1 / 1;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .cell { 
            background: #edf2f7; border-radius: 4px; aspect-ratio: 1 / 1; 
            transition: all 0.2s ease;
        }
        .cell.filled { background: var(--p); transform: scale(0.95); }
        .cell.clearing { background: var(--s); transform: scale(1.1); }

        /* í•˜ë‹¨ íŠ¸ë ˆì´ */
        #tray { 
            display: flex; justify-content: space-around; align-items: center; 
            height: 100px; margin: 10px 0 20px 0; background: white; 
            border-radius: 20px; padding: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); 
        }
        .shape-preview { 
            width: 80px; height: 80px; display: grid; 
            grid-template-columns: repeat(4, 1fr); gap: 2px; 
            border-radius: 10px; padding: 6px; box-sizing: border-box;
            transition: transform 0.2s; border: 2px solid transparent;
        }
        .shape-preview.selected { border-color: var(--preview); transform: scale(1.1); background: #fffaf0; }
        .preview-cell.filled { background: var(--p); border-radius: 1.5px; }

        /* ê³µí†µ ë²„íŠ¼ ë° ê´€ë¦¬ì°½ */
        .menu-btn { 
            width: 100%; padding: 16px; margin: 8px 0; border: none; 
            border-radius: 15px; color: white; font-size: 1.1rem; 
            cursor: pointer; font-weight: bold;
        }
        .btn-game { background: var(--p); }
        .btn-manage { background: #9b59b6; }
        
        .word-list-container { flex: 1; overflow-y: auto; margin: 15px 0; }
        .word-card { 
            background: white; padding: 15px; margin-bottom: 10px; 
            border-radius: 12px; position: relative; border-left: 5px solid var(--p);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #quiz-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            align-items: center; justify-content: center; z-index: 2000; padding: 20px; 
        }
        .modal-inner { 
            background: white; padding: 25px; border-radius: 25px; 
            width: 100%; max-width: 400px; text-align: center; 
        }
        .file-ops { display: flex; gap: 8px; margin-top: 10px; }
        .btn-outline { flex: 1; background: white; color: #666; border: 1px solid #ddd; padding: 10px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ§©</div>
            <h1 style="color: #2c3e50; margin: 0; font-size: 1.8rem;">ì•”ê¸° í¼ì¦ PRO</h1>
            <p style="color: #7f8c8d; font-size: 0.9rem;">8x8 ë³´ë“œ ìµœì í™” ë²„ì „</p>
            <div style="background:white; padding:10px 25px; border-radius:15px; margin: 20px 0; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                ìµœê³  ì ìˆ˜: <span id="high-score-home" style="color:var(--p)">0</span>
            </div>
        </div>
        <button class="menu-btn btn-game" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        <button class="menu-btn btn-manage" onclick="showScreen('manage')">ë¬¸ì œ ê´€ë¦¬</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="header">
            <button onclick="confirmExit()" style="padding:8px 15px; border-radius:10px; border:none; background:#e2e8f0; font-weight:bold; font-size: 0.9rem;">ğŸ  í™ˆ</button>
            <div class="score-box">
                <div style="font-size:0.7rem; color:#718096; font-weight: bold;">BEST <span id="high-score-game">0</span></div>
                <div style="font-weight:900; font-size:1.4rem; color:var(--p)" id="score">0</div>
            </div>
        </div>
        <div id="grid-container">
            <div id="grid"></div>
        </div>
        <div id="tray">
            <div id="shape-0" class="shape-preview" onclick="selectShape(0)"></div>
            <div id="shape-1" class="shape-preview" onclick="selectShape(1)"></div>
            <div id="shape-2" class="shape-preview" onclick="selectShape(2)"></div>
        </div>
        <p style="font-size: 0.75rem; color: #94a3b8; text-align: center; margin-bottom: 10px;">ë¸”ë¡ ì„ íƒ í›„ í•œ ì¹¸ì„ ë‘ ë²ˆ ëˆŒëŸ¬ ì„¤ì¹˜</p>
    </div>

    <div id="screen-manage" class="screen">
        <h2 style="margin: 10px 0; font-size: 1.4rem;">ë¬¸ì œ ê´€ë¦¬</h2>
        <div style="background:white; padding:12px; border-radius:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <textarea id="new-q" style="width:100%; height:70px; margin-bottom:8px; padding:10px; border:1px solid #eee; border-radius:8px; resize:none; font-size:0.9rem;" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <textarea id="new-a" style="width:100%; height:50px; margin-bottom:8px; padding:10px; border:1px solid #eee; border-radius:8px; resize:none; font-size:0.9rem;" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button onclick="addWord()" class="menu-btn btn-game" style="margin:0; padding:12px; font-size: 1rem;">ì¶”ê°€í•˜ê¸°</button>
            <div class="file-ops">
                <button class="btn-outline" onclick="exportJSON()">ğŸ“„ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn-outline" onclick="document.getElementById('file-input').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="importJSON(event)" accept=".json">
        </div>
        <div class="word-list-container" id="word-list"></div>
        <button class="menu-btn" style="background:#64748b; margin-top: auto;" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="quiz-modal">
        <div class="modal-inner">
            <h3 id="q-title" style="color:var(--p); margin-top:0;">ë³µìŠµ</h3>
            <div id="q-text" style="background:#f8fafc; padding:15px; border-radius:12px; margin-bottom:15px; text-align:left; line-height:1.5; font-size: 0.95rem; max-height: 150px; overflow-y: auto;"></div>
            <textarea id="q-input" style="width:100%; height:80px; padding:10px; border:2px solid #e2e8f0; border-radius:10px; margin-bottom:10px; font-size:1rem;" placeholder="ì •ë‹µ ì…ë ¥"></textarea>
            <div id="q-feedback" style="margin-bottom:10px; font-weight:bold; font-size: 0.9rem;"></div>
            <button id="q-submit" class="menu-btn btn-game" onclick="checkQuizAnswer()" style="margin:0; padding:12px;">ì œì¶œ</button>
            <button id="q-next" class="menu-btn btn-manage" style="display:none; margin:0; padding:12px;" onclick="nextQuestion()">ë‹¤ìŒ</button>
        </div>
    </div>

<script>
    // --- ì„¤ì • ---
    const GRID_SIZE = 8;
    const TOTAL_CELLS = GRID_SIZE * GRID_SIZE;
    let score = 0;
    let highScore = localStorage.getItem('puzzleBest8x8') || 0;
    let grid = Array(TOTAL_CELLS).fill(0);
    let trayShapes = [null, null, null];
    let selectedShapeIndex = null;
    let lastPreviewIdx = null;

    let vocabulary = JSON.parse(localStorage.getItem('myVocab')) || [
        { q: "ë¯¼ë²• ì œ1ì¡°", a: "ë¯¼ì‚¬ì— ê´€í•˜ì—¬ ë²•ë¥ ì— ê·œì •ì´ ì—†ìœ¼ë©´ ê´€ìŠµë²•ì— ì˜í•˜ê³  ê´€ìŠµë²•ì´ ì—†ìœ¼ë©´ ì¡°ë¦¬ì— ì˜í•œë‹¤." }
    ];

    const shapes = [
        [[0,0], [0,1], [1,0], [1,1]], [[0,0], [1,0], [2,0]], [[0,0], [0,1], [0,2]],
        [[0,0], [1,0], [1,1]], [[0,0], [0,1], [0,2], [0,3]], [[0,0], [1,0], [2,0], [3,0]],
        [[0,1], [1,0], [1,1], [1,2]], [[0,0]], [[0,0], [0,1], [1,0]]
    ];

    // --- í™”ë©´ ë° ë°ì´í„° ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        updateScores();
        if(id === 'manage') renderWordList();
    }

    function updateScores() {
        document.getElementById('high-score-home').innerText = highScore;
        document.getElementById('high-score-game').innerText = highScore;
        document.getElementById('score').innerText = score;
    }

    function exportJSON() {
        if(vocabulary.length === 0) return;
        const blob = new Blob([JSON.stringify(vocabulary, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `quiz_backup.json`;
        a.click();
    }

    function importJSON(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const data = JSON.parse(evt.target.result);
                if(Array.isArray(data)) { 
                    vocabulary = data; 
                    localStorage.setItem('myVocab', JSON.stringify(vocabulary)); 
                    renderWordList(); 
                    alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ"); 
                }
            } catch(err) { alert("í˜•ì‹ ì˜¤ë¥˜"); }
        };
        reader.readAsText(file);
    }

    // --- ê²Œì„ ì½”ì–´ ---
    function startGame() { 
        if(vocabulary.length < 3) { alert("ë¬¸ì œë¥¼ 3ê°œ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”."); showScreen('manage'); return; }
        showScreen('game'); initGame(); 
    }

    function initGame() {
        score = 0; grid.fill(0); updateScores();
        const gridEl = document.getElementById('grid');
        gridEl.innerHTML = "";
        for (let i = 0; i < TOTAL_CELLS; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell'; cell.id = 'cell-' + i;
            cell.onclick = () => handleCellClick(i);
            gridEl.appendChild(cell);
        }
        refillTray();
    }

    function refillTray() {
        trayShapes = [0, 1, 2].map(() => shapes[Math.floor(Math.random() * shapes.length)]);
        renderTray();
        if(!canAnyShapeBePlaced()) { setTimeout(() => { alert("ê²Œì„ ì˜¤ë²„!"); showScreen('home'); }, 500); }
    }

    function renderTray() {
        trayShapes.forEach((shape, i) => {
            const el = document.getElementById(`shape-${i}`);
            el.innerHTML = ""; el.style.opacity = shape ? "1" : "0.1";
            el.className = 'shape-preview' + (selectedShapeIndex === i ? ' selected' : '');
            if (!shape) return;
            for (let r=0; r<4; r++) {
                for (let c=0; c<4; c++) {
                    const div = document.createElement('div');
                    div.className = 'preview-cell' + (shape.some(p => p[0]===r && p[1]===c) ? ' filled' : '');
                    el.appendChild(div);
                }
            }
        });
    }

    function selectShape(i) { if (!trayShapes[i]) return; clearPreview(); selectedShapeIndex = (selectedShapeIndex === i) ? null : i; renderTray(); }

    function handleCellClick(idx) {
        if (selectedShapeIndex === null) return;
        const shape = trayShapes[selectedShapeIndex];
        const r = Math.floor(idx / GRID_SIZE), c = idx % GRID_SIZE;
        let targets = [];
        
        const canPlace = shape.every(p => {
            const nr = r + p[0], nc = c + p[1];
            if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE && grid[nr * GRID_SIZE + nc] === 0) {
                targets.push(nr * GRID_SIZE + nc); return true;
            }
            return false;
        });

        if (!canPlace) { clearPreview(); return; }

        if (lastPreviewIdx === idx) {
            targets.forEach(t => { 
                grid[t] = 1; 
                document.getElementById('cell-' + t).classList.add('filled');
            });
            trayShapes[selectedShapeIndex] = null; selectedShapeIndex = null;
            clearPreview(); renderTray(); checkLines();
            if (trayShapes.every(s => s === null)) { startQuiz(); }
            else if (!canAnyShapeBePlaced()) { setTimeout(() => { alert("ì¢…ë£Œ!"); showScreen('home'); }, 300); }
        } else {
            clearPreview(); lastPreviewIdx = idx;
            targets.forEach(t => { document.getElementById('cell-' + t).style.boxShadow = "inset 0 0 0 4px var(--preview)"; });
        }
    }

    function clearPreview() { document.querySelectorAll('.cell').forEach(c => c.style.boxShadow = "none"); lastPreviewIdx = null; }

    function checkLines() {
        let rC = [], cC = [];
        for (let i=0; i<GRID_SIZE; i++) {
            if (grid.slice(i*GRID_SIZE, i*GRID_SIZE+GRID_SIZE).every(v => v === 1)) rC.push(i);
            let col = []; for (let j=0; j<GRID_SIZE; j++) col.push(grid[j*GRID_SIZE + i]);
            if (col.every(v => v === 1)) cC.push(i);
        }
        rC.forEach(r => { for(let c=0; c<GRID_SIZE; c++) animateClear(r*GRID_SIZE+c); });
        cC.forEach(c => { for(let r=0; r<GRID_SIZE; r++) animateClear(r*GRID_SIZE+c); });
        if (rC.length > 0 || cC.length > 0) {
            score += (rC.length + cC.length) * 10;
            if (score > highScore) { highScore = score; localStorage.setItem('puzzleBest8x8', highScore); }
            updateScores();
        }
    }

    function animateClear(idx) {
        grid[idx] = 0;
        const cell = document.getElementById('cell-' + idx);
        cell.classList.add('clearing');
        setTimeout(() => { cell.classList.remove('filled', 'clearing'); }, 300);
    }

    function canAnyShapeBePlaced() {
        return trayShapes.some((shape) => {
            if (!shape) return false;
            for (let i = 0; i < TOTAL_CELLS; i++) {
                const r = Math.floor(i / GRID_SIZE), c = i % GRID_SIZE;
                if (shape.every(p => {
                    const nr = r + p[0], nc = c + p[1];
                    return nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE && grid[nr * GRID_SIZE + nc] === 0;
                })) return true;
            }
            return false;
        }) || trayShapes.every(s => s === null);
    }

    // --- í€´ì¦ˆ ---
    let curQuiz = 0, quizCorrect = 0, sessionQuizzes = [];
    function startQuiz() {
        curQuiz = 0; quizCorrect = 0;
        sessionQuizzes = [...vocabulary].sort(() => 0.5 - Math.random()).slice(0, 3);
        document.getElementById('quiz-modal').style.display = 'flex';
        showQuestion();
    }

    function showQuestion() {
        const q = sessionQuizzes[curQuiz];
        document.getElementById('q-title').innerText = `ê²€í†  (${curQuiz + 1}/3)`;
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('q-input').value = "";
        document.getElementById('q-input').style.display = "block";
        document.getElementById('q-feedback').innerText = "";
        document.getElementById('q-submit').style.display = "block";
        document.getElementById('q-next').style.display = "none";
    }

    function checkQuizAnswer() {
        const input = document.getElementById('q-input').value.trim().replace(/\s/g, "");
        const ans = sessionQuizzes[curQuiz].a.trim().replace(/\s/g, "");
        if (input === ans) { 
            quizCorrect++; 
            document.getElementById('q-feedback').innerHTML = "<span style='color:var(--s)'>ì •ë‹µì…ë‹ˆë‹¤! âœ¨</span>"; 
        } else { 
            document.getElementById('q-feedback').innerHTML = `<span style='color:var(--danger)'>ì˜¤ë‹µ! ì •ë‹µ:<br><small>${sessionQuizzes[curQuiz].a}</small></span>`; 
        }
        document.getElementById('q-submit').style.display = "none";
        document.getElementById('q-next').style.display = "block";
    }

    function nextQuestion() {
        curQuiz++;
        if (curQuiz < 3) showQuestion();
        else {
            if (quizCorrect >= 2) { refillTray(); document.getElementById('quiz-modal').style.display = 'none'; }
            else { alert("ì¬ë„ì „!"); startQuiz(); }
        }
    }

    function addWord() {
        const q = document.getElementById('new-q').value.trim();
        const a = document.getElementById('new-a').value.trim();
        if(q && a) {
            vocabulary.push({q, a});
            localStorage.setItem('myVocab', JSON.stringify(vocabulary));
            renderWordList();
            document.getElementById('new-q').value = "";
            document.getElementById('new-a').value = "";
        }
    }

    function renderWordList() {
        const list = document.getElementById('word-list');
        list.innerHTML = vocabulary.map((item, idx) => `
            <div class="word-card">
                <div style="font-weight:bold; margin-bottom:5px; font-size: 0.9rem;">${item.q}</div>
                <div style="font-size:0.8rem; color:#666;">${item.a}</div>
                <button onclick="deleteWord(${idx})" style="position:absolute; top:10px; right:10px; border:none; background:none; color:#ccc;">âœ•</button>
            </div>
        `).join('');
    }

    function deleteWord(idx) {
        if(confirm("ì‚­ì œí• ê¹Œìš”?")) {
            vocabulary.splice(idx, 1);
            localStorage.setItem('myVocab', JSON.stringify(vocabulary));
            renderWordList();
        }
    }

    function confirmExit() { if(confirm("ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) showScreen('home'); }

    window.onload = () => { updateScores(); };
</script>
</body>
</html>
