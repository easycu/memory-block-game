<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì•”ê¸° í¼ì¦ PRO v6.0</title>
    <style>
        :root { 
            /* v6.0 í…Œë§ˆ: ì•„ì´ ì»´í¬íŠ¸ ê·¸ë¦° (Eye Comfort Green) */
            --p: #2e7d32;       /* ë©”ì¸ ë¸”ë¡: ì§™ì€ ìˆ²ìƒ‰ (Forest Green) */
            --s: #66bb6a;       /* í´ë¦¬ì–´ íš¨ê³¼: ë°ì€ ì´ˆë¡ */
            --bg: #e8f5e9;      /* ë°°ê²½: ì•„ì£¼ ì˜…ì€ ë¯¼íŠ¸ (Mint Cream) */
            --grid-bg: #a5d6a7; /* ê·¸ë¦¬ë“œ ë°°ê²½: ì‘¥ìƒ‰ */
            --cell-bg: #c8e6c9; /* ë¹ˆ ì¹¸: ì˜…ì€ ì‘¥ìƒ‰ */
            
            --preview: #ffa726; /* í”„ë¦¬ë·° íŠ¸ë ˆì´ ê°•ì¡° (ì˜¤ë Œì§€) */
            --danger: #ef5350;  /* ê²½ê³  (ë¶€ë“œëŸ¬ìš´ ë¹¨ê°•) */
            --bonus: #fdd835;   /* ë³´ë„ˆìŠ¤ (ë…¸ë‘) */
            --excel: #1b5e20;   /* ì—‘ì…€ ë²„íŠ¼ (ì§„í•œ ë…¹ìƒ‰) */
            --text-main: #1b5e20; /* ë©”ì¸ í…ìŠ¤íŠ¸ (ì§„í•œ ë…¹ìƒ‰) */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        
        body { 
            font-family: -apple-system, 'Pretendard', sans-serif; 
            background: var(--bg);
            color: var(--text-main);
            width: 100vw; height: 100dvh;
            display: flex; flex-direction: column; align-items: center; 
            overflow: hidden; touch-action: none; 
        }
        
        .screen { 
            display: none; width: 100%; max-width: 450px; 
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px; 
            height: 100%; flex-direction: column; 
        }
        .active { display: flex; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ ë“± ìœ í‹¸ë¦¬í‹° */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s; }

        .float-score {
            position: absolute; color: var(--bonus); font-weight: 900; font-size: 1.5rem;
            pointer-events: none; animation: floatUp 1s ease-out forwards; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 100;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }

        /* ë ˆì´ì•„ì›ƒ */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; min-height: 70px; width: 100%;
        }
        
        #grid-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            width: 100%; min-height: 0; position: relative;
        }
        #grid { 
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; 
            background: var(--grid-bg); padding: 6px; border-radius: 12px; 
            width: 100%; aspect-ratio: 1 / 1;
            transition: transform 0.1s;
        }
        .cell { background: var(--cell-bg); border-radius: 4px; aspect-ratio: 1 / 1; transition: all 0.2s; }
        .cell.filled { background: var(--p); transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cell.bonus-filled { background: var(--bonus); transform: scale(0.95); box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        .cell.clearing { background: var(--s); transform: scale(1.1); filter: brightness(1.2); }
        
        /* ê³ ìŠ¤íŠ¸ ë¸”ë¡: ìƒ‰ìƒì„ ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ í•˜ì—¬ ê°€ì‹œì„± í™•ë³´ */
        .cell.ghost { background: var(--p); opacity: 0.4; transform: scale(0.95); box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5); }
        .cell.ghost-bonus { background: var(--bonus); opacity: 0.5; transform: scale(0.95); }

        #tray { 
            display: flex; justify-content: center; align-items: center; gap: 8px;
            height: 110px; margin-bottom: 15px; background: white; 
            border-radius: 20px; padding: 10px; width: 100%;
            touch-action: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .shape-preview { width: 75px; height: 75px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; border-radius: 10px; padding: 4px; border: 2px solid transparent; background: #fff; transition: opacity 0.2s, visibility 0.2s; }
        .shape-preview.dragging { opacity: 0; visibility: hidden; } 
        .preview-cell { aspect-ratio: 1/1; }
        .preview-cell.filled { background: var(--p); border-radius: 1px; }
        .preview-cell.bonus { background: var(--bonus); border-radius: 1px; }

        /* v6.0: ë“œë˜ê·¸ í—¬í¼ (ì§„í•œ ìƒ‰ìƒ + ë¶ˆíˆ¬ëª…) */
        #drag-helper {
            position: fixed; pointer-events: none; z-index: 1000;
            display: none; 
            opacity: 1.0; /* íˆ¬ëª…ë„ ì œê±°: ì‹¤ì²´ê° ìˆê²Œ */
            margin: 0; padding: 0;
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.3)); /* ê·¸ë¦¼ì ê°•í™” */
        }
        #drag-helper .preview-cell { background: transparent; } 
        #drag-helper .preview-cell.filled { 
            background: var(--p);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2); /* ì•½ê°„ì˜ ì…ì²´ê° */
        }
        #drag-helper .preview-cell.bonus { 
            background: var(--bonus);
            border-radius: 4px;
        }

        .menu-btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 15px; color: white; font-size: 1.1rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-game { background: var(--p); }
        .btn-manage { background: #8d6e63; } /* ë¸Œë¼ìš´ í†¤ìœ¼ë¡œ ë³€ê²½ (ê·¸ë¦°ê³¼ ì–´ìš¸ë¦¼) */
        
        .word-list-container { flex: 1; overflow-y: auto; margin: 15px 0; width: 100%; }
        .word-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 12px; position: relative; border-left: 5px solid var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        #quiz-modal { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; 
            background: rgba(0,0,0,0.8); display: none; 
            align-items: center; justify-content: center; z-index: 9999; padding: 20px; 
            backdrop-filter: blur(5px); /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ */
        }
        .modal-inner { 
            background: white; padding: 25px; border-radius: 25px; 
            width: 100%; max-width: 360px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #q-input { width: 100%; height: 100px; padding: 12px; border: 2px solid var(--grid-bg); border-radius: 12px; font-size: 1rem; margin-bottom: 15px; resize: none; outline: none; }
        #q-input:focus { border-color: var(--p); }
        #q-text { width: 100%; background: var(--bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; font-size: 0.95rem; line-height: 1.5; max-height: 150px; overflow-y: auto; color: var(--text-main); font-weight: 500; }

        .file-ops { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; margin-top: 10px; }
        .btn-outline { flex: 1; min-width: 45%; background: white; color: var(--text-main); border: 1px solid #ccc; padding: 10px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        .btn-append { background: #e8f5e9; border-color: var(--p); color: var(--p); }
        
        #excel-area { display: none; width: 100%; background: #fff; padding: 10px; border-radius: 10px; border: 2px dashed var(--excel); margin-bottom: 15px; }
        #excel-input { width: 100%; height: 100px; font-family: monospace; white-space: pre; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.8rem; margin-bottom: 5px; }

        #toast-container {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 9999; pointer-events: none; width: 100%; display: flex; justify-content: center;
        }
        .toast {
            background: rgba(46, 125, 50, 0.95); /* í† ìŠ¤íŠ¸ ê¸°ë³¸ìƒ‰ë„ ê·¸ë¦° */
            color: white; padding: 12px 24px;
            border-radius: 30px; font-size: 0.95rem; font-weight: bold;
            opacity: 0; transition: opacity 0.3s, transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform: translateY(20px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center; max-width: 85%;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: rgba(231, 76, 60, 0.95); }
        .toast.success { background: rgba(67, 160, 71, 0.95); }
        .toast.info { background: rgba(30, 136, 229, 0.95); }
    </style>
</head>
<body>
    <div id="drag-helper"></div>
    <div id="toast-container"></div>

    <div id="screen-home" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="font-size: 4.5rem; margin-bottom: 15px;">ğŸ§©</div>
            <h1 style="color: var(--text-main);">ì•”ê¸° í¼ì¦ PRO</h1>
            <div style="background:white; padding:10px 25px; border-radius:15px; margin: 20px 0; font-weight:bold; box-shadow:0 2px 8px rgba(0,0,0,0.05); color: var(--text-main);">
                ìµœê³  ì ìˆ˜: <span id="high-score-home" style="color:var(--p)">0</span>
            </div>
        </div>
        <div class="home-btns">
            <button class="menu-btn btn-game" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
            <button class="menu-btn btn-manage" onclick="showScreen('manage')">ë¬¸ì œ ê´€ë¦¬</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="header">
            <button onclick="confirmExit()" style="padding:8px 15px; border-radius:10px; border:none; background:#fff; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); font-size: 0.9rem; color: var(--text-main);">ğŸ  í™ˆ</button>
            <div class="score-box">
                <div style="font-size:0.7rem; color:#666; font-weight: bold;">BEST <span id="high-score-game">0</span></div>
                <div style="font-weight:900; font-size:1.5rem; color:var(--p)" id="score">0</div>
            </div>
        </div>
        <div id="grid-container"><div id="grid"></div></div>
        <div id="tray"></div>
        <p style="font-size: 0.75rem; color: #888; text-align: center; margin-bottom: 10px;">ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì—¬ ì±„ìš°ì„¸ìš”</p>
    </div>

    <div id="screen-manage" class="screen">
        <h2 style="margin: 15px 0; color: var(--text-main);">ë¬¸ì œ ê´€ë¦¬</h2>
        <div style="background:white; padding:15px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
            <div style="display:flex; gap:5px;">
                <textarea id="new-q" style="flex:1; height:60px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;" placeholder="ë¬¸ì œ"></textarea>
                <textarea id="new-a" style="flex:1; height:60px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;" placeholder="ì •ë‹µ"></textarea>
            </div>
            <button onclick="addWord()" class="menu-btn btn-game" style="margin:8px 0; padding: 12px; font-size: 0.9rem;">í•œ ê°œ ì¶”ê°€</button>
            
            <button class="menu-btn" style="background:var(--excel); margin:0 0 10px 0; padding: 10px; font-size: 0.9rem;" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸° (ì—´ê¸°/ë‹«ê¸°)</button>
            <div id="excel-area">
                <p style="font-size:0.75rem; color:#27ae60; margin-bottom:5px;"><b>ì‚¬ìš©ë²•:</b> ì—‘ì…€ì—ì„œ [ë¬¸ì œ] [ì •ë‹µ] ë‘ ì—´ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                <textarea id="excel-input" placeholder="ì˜ˆì‹œ:&#13;&#10;Apple	ì‚¬ê³¼&#13;&#10;Banana	ë°”ë‚˜ë‚˜"></textarea>
                <button class="menu-btn btn-game" style="margin:0; padding:8px; font-size:0.8rem;" onclick="parseExcel()">ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
            </div>

            <div class="file-ops">
                <button class="btn-outline" onclick="exportJSON()">ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn-outline" onclick="triggerFile('import')">ë®ì–´ì“°ê¸°</button>
                <button class="btn-outline btn-append" onclick="triggerFile('append')">ë°ì´í„° í•©ì¹˜ê¸°</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="handleFile(event)" accept=".json">
        </div>
        <div class="word-list-container" id="word-list"></div>
        <button class="menu-btn" style="background:#8d6e63; margin-top: auto;" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="quiz-modal">
        <div class="modal-inner">
            <h2 id="q-title" style="color:var(--p); margin-bottom:15px;">ë³µìŠµ íƒ€ì„!</h2>
            <div id="q-text"></div>
            <textarea id="q-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <div id="q-feedback" style="margin-bottom:15px; font-weight:bold; font-size: 0.9rem; text-align: center;"></div>
            <button id="q-submit" class="menu-btn btn-game" onclick="checkQuizAnswer()" style="margin:0; padding: 12px;">í™•ì¸</button>
            <button id="q-next" class="menu-btn btn-manage" style="display:none; margin:0; padding: 12px;" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
    </div>

<script>
    // --- ìœ í‹¸ë¦¬í‹°: í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ---
    function showToast(msg, type='normal') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerText = msg;
        container.appendChild(el);
        void el.offsetWidth; el.classList.add('show');
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 2000); 
    }

    // --- ì˜¤ë””ì˜¤ ---
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioContext = null;
    function initAudio() { if (!audioContext) audioContext = new AudioCtx(); if (audioContext.state === 'suspended') audioContext.resume(); }
    const soundTypes = {
        click: (t) => { const o=audioContext.createOscillator(),g=audioContext.createGain(); o.frequency.setValueAtTime(600,t); o.frequency.exponentialRampToValueAtTime(300,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); o.connect(g); g.connect(audioContext.destination); o.start(t); o.stop(t+0.1); },
        place: (t) => { const o=audioContext.createOscillator(),g=audioContext.createGain(); o.frequency.setValueAtTime(200,t); o.frequency.exponentialRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(0.2,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); o.type='triangle'; o.connect(g); g.connect(audioContext.destination); o.start(t); o.stop(t+0.15); },
        clear: (t) => { const notes=[523.25,659.25,783.99,1046.50]; notes.forEach((f,i)=>{ const o=audioContext.createOscillator(),g=audioContext.createGain(); o.frequency.value=f; g.gain.setValueAtTime(0.1,t+i*0.05); g.gain.exponentialRampToValueAtTime(0.01,t+i*0.05+0.3); o.connect(g); g.connect(audioContext.destination); o.start(t+i*0.05); o.stop(t+i*0.05+0.3); }); },
        correct: (t) => { [523.25,659.25,783.99].forEach((f,i)=>{ const o=audioContext.createOscillator(),g=audioContext.createGain(); o.frequency.value=f; o.type='sine'; g.gain.setValueAtTime(0.1,t+i*0.1); g.gain.linearRampToValueAtTime(0,t+i*0.1+0.4); o.connect(g); g.connect(audioContext.destination); o.start(t+i*0.1); o.stop(t+i*0.1+0.4); }); },
        wrong: (t) => { const o=audioContext.createOscillator(),g=audioContext.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(150,t); o.frequency.linearRampToValueAtTime(100,t+0.3); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.3); o.connect(g); g.connect(audioContext.destination); o.start(t); o.stop(t+0.3); }
    };
    function playSound(type) { if(audioContext) soundTypes[type](audioContext.currentTime); }

    // --- ë³€ìˆ˜ ---
    const GRID_SIZE = 8; const TOTAL_CELLS = 64;
    const SHAPES = [ [[0,0],[0,1],[1,0],[1,1]], [[0,0],[1,0],[2,0],[3,0],[4,0]], [[0,0],[0,1],[0,2],[0,3],[0,4]], [[0,0],[1,0],[2,0]], [[0,0],[0,1],[0,2]], [[0,0],[1,0],[2,0],[2,1],[2,2]], [[0,0],[0,1],[0,2],[1,2],[2,2]], [[0,0],[1,1],[2,2],[3,3]], [[0,2],[1,2],[2,0],[2,1],[2,2]], [[0,1],[1,0],[1,1],[1,2],[2,1]], [[0,0],[0,1],[1,1],[1,2],[2,2]], [[0,0],[1,0],[1,1]], [[0,0],[0,1],[1,0]], [[0,0],[0,1],[0,2],[0,3]], [[0,0],[1,0],[2,0],[3,0]], [[0,0]] ];
    let score = 0, highScore = localStorage.getItem('puzzleBest8x8') || 0;
    let grid = Array(TOTAL_CELLS).fill(0), trayShapes = [];
    let vocabulary = JSON.parse(localStorage.getItem('myVocab')) || [{q:"ì•”ê¸° í¼ì¦ ì‹œì‘!", a:"O", wrongCount: 0}];
    let fileMode = 'import';
    let quizDeck = [];
    let isDragging = false, dragShapeIndex = null, ghostIndices = [];
    const TOUCH_OFFSET = 60; let anchorRow = 0, anchorCol = 0;

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('screen-' + id).classList.add('active'); window.scrollTo(0, 0); updateScores(); if(id === 'manage') renderWordList(); }
    function updateScores() { document.getElementById('high-score-home').innerText = highScore; document.getElementById('high-score-game').innerText = highScore; document.getElementById('score').innerText = score; }

    // --- í€´ì¦ˆ ë¡œì§ (í•˜ì´ë¸Œë¦¬ë“œ) ---
    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    function fillQuizDeck() { quizDeck = []; for (let i = 0; i < vocabulary.length; i++) quizDeck.push(i); shuffleArray(quizDeck); }
    function startQuiz() {
        if(vocabulary.length < 1) { refillTray(0); return; }
        curQuiz = 0; quizCorrect = 0;
        let finalIndices = [];
        let wrongCandidates = vocabulary.map((v, i) => ({...v, idx: i})).filter(v => v.wrongCount > 0).map(v => v.idx);
        if (wrongCandidates.length > 0) finalIndices.push(wrongCandidates[Math.floor(Math.random() * wrongCandidates.length)]);
        while (finalIndices.length < 3) {
            if (quizDeck.length === 0) fillQuizDeck();
            const nextIdx = quizDeck.pop();
            if (vocabulary[nextIdx] && !finalIndices.includes(nextIdx)) finalIndices.push(nextIdx);
        }
        shuffleArray(finalIndices);
        sessionQuizzes = finalIndices.map(idx => vocabulary[idx]);
        document.getElementById('quiz-modal').style.display = 'flex';
        showQuestion();
    }
    function showQuestion() { const q = sessionQuizzes[curQuiz]; document.getElementById('q-title').innerText = `ê²€í†  (${curQuiz + 1}/3)`; document.getElementById('q-text').innerText = q.q; document.getElementById('q-input').value = ""; document.getElementById('q-feedback').innerText = ""; document.getElementById('q-submit').style.display = "block"; document.getElementById('q-next').style.display = "none"; }
    function checkQuizAnswer() {
        const raw = document.getElementById('q-input').value.trim(), input = raw.replace(/\s/g, "").toUpperCase();
        const ans = sessionQuizzes[curQuiz].a, realAns = ans.replace(/\s/g, "").toUpperCase();
        const fb = document.getElementById('q-feedback');
        let correct = (input === "O" || input === "X") ? (realAns.charAt(0) === input) : (input === realAns);
        if (correct) { quizCorrect++; playSound('correct'); if(sessionQuizzes[curQuiz].wrongCount > 0) sessionQuizzes[curQuiz].wrongCount--; fb.innerHTML = `<span style='color:var(--s)'>ì •ë‹µ! âœ¨<br>ì •ë‹µ: ${ans}</span>`; }
        else { playSound('wrong'); sessionQuizzes[curQuiz].wrongCount = (sessionQuizzes[curQuiz].wrongCount || 0) + 1; fb.innerHTML = `<span style='color:var(--danger)'>ì˜¤ë‹µ! âŒ<br>ì •ë‹µ: ${ans}</span>`; }
        localStorage.setItem('myVocab', JSON.stringify(vocabulary));
        document.getElementById('q-submit').style.display = "none"; document.getElementById('q-next').style.display = "block";
    }
    function nextQuestion() { curQuiz++; if (curQuiz < 3) showQuestion(); else { document.getElementById('quiz-modal').style.display = 'none'; if (quizCorrect >= 2) refillTray(quizCorrect); else { showToast("ë¶ˆí•©ê²©! ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”.", 'error'); setTimeout(startQuiz, 1000); } } }
    function refillTray(correctCount) { trayShapes = [0,1,2].map(() => [...SHAPES[Math.floor(Math.random()*SHAPES.length)]]); if(correctCount === 3) { const b=[[0,0]]; b.isBonus=true; trayShapes.push(b); } renderTray(); checkGameOver(); }

    // --- ë“œë˜ê·¸ ì‹œìŠ¤í…œ (v5.5 ì¢Œí‘œìœ ì§€) ---
    function renderTray() {
        const trayEl = document.getElementById('tray'); trayEl.innerHTML = "";
        trayShapes.forEach((s, i) => {
            if(s === null) return;
            const div = document.createElement('div'); div.className = 'shape-preview';
            div.addEventListener('touchstart', (e) => handleTouchStart(e, i), {passive: false}); div.addEventListener('touchmove', (e) => handleTouchMove(e), {passive: false}); div.addEventListener('touchend', (e) => handleTouchEnd(e), {passive: false}); div.addEventListener('mousedown', (e) => handleTouchStart(e, i));
            for(let r=0; r<5; r++) for(let c=0; c<5; c++) { const cell = document.createElement('div'); const isPart = s.some(p=>p[0]===r&&p[1]===c); cell.className = isPart ? (s.isBonus ? 'preview-cell filled bonus' : 'preview-cell filled') : 'preview-cell'; div.appendChild(cell); }
            trayEl.appendChild(div);
        });
    }
    function handleTouchStart(e, idx) {
        if(e.cancelable) e.preventDefault(); isDragging = true; dragShapeIndex = idx; const s = trayShapes[idx];
        const helper = document.getElementById('drag-helper'); helper.innerHTML = "";
        const cellSize = document.querySelector('.cell').getBoundingClientRect().width;
        let minR=5, maxR=-1, minC=5, maxC=-1; s.forEach(p => { minR=Math.min(minR,p[0]); maxR=Math.max(maxR,p[0]); minC=Math.min(minC,p[1]); maxC=Math.max(maxC,p[1]); });
        anchorR = maxR; anchorC = Math.round((minC + maxC) / 2);
        const rows = maxR - minR + 1; const cols = maxC - minC + 1;
        helper.style.display = "grid"; helper.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`; helper.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`; helper.style.gap = "1px"; helper.style.width = (cols * cellSize + (cols-1)) + 'px'; helper.style.height = (rows * cellSize + (rows-1)) + 'px';
        for(let r=minR; r<=maxR; r++) for(let c=minC; c<=maxC; c++) { const cell = document.createElement('div'); const isPart = s.some(p=>p[0]===r&&p[1]===c); cell.className = isPart ? (s.isBonus ? 'preview-cell filled bonus' : 'preview-cell filled') : 'preview-cell'; if (!isPart) cell.style.visibility = "hidden"; helper.appendChild(cell); }
        moveHelper(e); e.currentTarget.classList.add('dragging'); playSound('click'); ghostIndices = [];
    }
    function handleTouchMove(e) { if(!isDragging) return; if(e.cancelable) e.preventDefault(); moveHelper(e); updateGhost(e); }
    function handleTouchEnd(e) { if(!isDragging) return; isDragging = false; document.getElementById('drag-helper').style.display = "none"; document.querySelectorAll('.shape-preview').forEach(el => el.classList.remove('dragging')); if(ghostIndices.length > 0) placeBlock(ghostIndices, trayShapes[dragShapeIndex]); else clearGhost(); ghostIndices = []; dragShapeIndex = null; }
    function moveHelper(e) {
        const h = document.getElementById('drag-helper'); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const cs = document.querySelector('.cell').getBoundingClientRect().width; const s = trayShapes[dragShapeIndex];
        let minR=5, minC=5; s.forEach(p => { minR=Math.min(minR,p[0]); minC=Math.min(minC,p[1]); });
        const relR = anchorR - minR; const relC = anchorC - minC;
        h.style.left = (cx - (relC * cs + cs / 2)) + 'px'; h.style.top = (cy - TOUCH_OFFSET - (relR * cs + cs / 2)) + 'px';
    }
    function updateGhost(e) {
        clearGhost(); ghostIndices = [];
        const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const cs = document.querySelector('.cell').getBoundingClientRect().width;
        const h = document.getElementById('drag-helper'); h.style.display = 'none'; const el = document.elementFromPoint(cx, cy - TOUCH_OFFSET - (cs/2)); h.style.display = 'grid';
        if(!el || !el.classList.contains('cell')) return;
        const tid = parseInt(el.id.split('-')[1]); const tr = Math.floor(tid / 8), tc = tid % 8;
        const s = trayShapes[dragShapeIndex]; const sr = tr - anchorR, sc = tc - anchorC;
        let inds = []; const fit = s.every(p => { const nr=p[0]+sr, nc=p[1]+sc; if(nr>=0&&nr<8&&nc>=0&&nc<8&&grid[nr*8+nc]===0) { inds.push(nr*8+nc); return true; } return false; });
        if(fit) { ghostIndices = inds; inds.forEach(i => document.getElementById('cell-'+i).classList.add(s.isBonus?'ghost-bonus':'ghost')); }
    }
    function clearGhost() { document.querySelectorAll('.cell').forEach(c => { c.classList.remove('ghost'); c.classList.remove('ghost-bonus'); }); }
    function placeBlock(inds, s) { playSound('place'); inds.forEach(i => { grid[i] = 1; document.getElementById('cell-'+i).className = s.isBonus ? 'cell bonus-filled' : 'cell filled'; }); trayShapes[dragShapeIndex] = null; renderTray(); checkLines(); if(trayShapes.every(v => v === null)) startQuiz(); else checkGameOver(); }

    function checkLines() {
        let rs=[], cs=[];
        for(let i=0; i<8; i++) { if(grid.slice(i*8, i*8+8).every(v=>v===1)) rs.push(i); let col=[]; for(let j=0; j<8; j++) col.push(grid[j*8+i]); if(col.every(v=>v===1)) cs.push(i); }
        if(rs.length+cs.length>0) { playSound('clear'); document.getElementById('grid').classList.remove('shaking'); void document.getElementById('grid').offsetWidth; document.getElementById('grid').classList.add('shaking'); const gain=(rs.length+cs.length)*10*(rs.length+cs.length); score+=gain; updateScores(); const el=document.createElement('div'); el.className='float-score'; el.innerText=`+${gain}`; document.getElementById('grid-container').appendChild(el); setTimeout(()=>el.remove(),1000); if(score>highScore) { highScore=score; localStorage.setItem('puzzleBest8x8',highScore); } }
        rs.forEach(r => { for(let c=0; c<8; c++) animateClear(r*8+c); }); cs.forEach(c => { for(let r=0; r<8; r++) animateClear(r*8+c); });
    }
    function animateClear(i) { grid[i]=0; const el=document.getElementById('cell-'+i); el.classList.add('clearing'); setTimeout(()=>{ el.className='cell'; }, 300); }
    function checkGameOver() {
        const can = trayShapes.some(s => { if(!s) return false; for(let i=0; i<64; i++) { const r=Math.floor(i/8), c=i%8; if(s.every(p=>{const nr=r+p[0],nc=c+p[1]; return nr<8&&nc<8&&grid[nr*8+nc]===0})) return true; } return false; });
        if(!can && !trayShapes.every(v=>v===null)) { showToast(`ê²Œì„ ì¢…ë£Œ! ì ìˆ˜: ${score}`, 'info'); setTimeout(()=>showScreen('home'), 2000); }
    }
    
    // --- ê´€ë¦¬ ---
    function startGame() { initAudio(); if(vocabulary.length<1) return showToast("ë¬¸ì œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!", 'error'); showScreen('game'); initGame(); }
    function initGame() { score=0; grid.fill(0); updateScores(); const g=document.getElementById('grid'); g.innerHTML=""; for(let i=0;i<64;i++){const c=document.createElement('div');c.className='cell';c.id='cell-'+i;g.appendChild(c);} refillTray(0); fillQuizDeck(); }
    function isDuplicate(q, a) { const nQ=q.replace(/\s/g,"").toUpperCase(), nA=a.replace(/\s/g,"").toUpperCase(); return vocabulary.some(v=>v.q.replace(/\s/g,"").toUpperCase()===nQ && v.a.replace(/\s/g,"").toUpperCase()===nA); }
    function addWord() { const q=document.getElementById('new-q').value.trim(), a=document.getElementById('new-a').value.trim(); if(q&&a) { if(isDuplicate(q,a)) return showToast("ì¤‘ë³µì…ë‹ˆë‹¤!",'error'); vocabulary.push({q,a,wrongCount:0}); localStorage.setItem('myVocab',JSON.stringify(vocabulary)); renderWordList(); document.getElementById('new-q').value=""; document.getElementById('new-a').value=""; showToast("ì¶”ê°€ë¨!",'success'); fillQuizDeck(); } else showToast("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”",'error'); }
    function toggleExcel() { const el=document.getElementById('excel-area'); el.style.display=el.style.display==='none'?'block':'none'; }
    function parseExcel() { const raw=document.getElementById('excel-input').value; if(!raw.trim()) return showToast("ì…ë ¥í•˜ì„¸ìš”",'error'); const rows=raw.split('\n'); let add=0; rows.forEach(r=>{ const c=r.split('\t'); if(c.length>=2){ const q=c[0].trim(),a=c[1].trim(); if(q&&a&&!isDuplicate(q,a)){ vocabulary.push({q,a,wrongCount:0}); add++; } } }); localStorage.setItem('myVocab',JSON.stringify(vocabulary)); renderWordList(); document.getElementById('excel-input').value=""; showToast(`${add}ê°œ ì¶”ê°€ë¨`,'success'); toggleExcel(); fillQuizDeck(); }
    function renderWordList() { document.getElementById('word-list').innerHTML = vocabulary.map((v,i)=>`<div class="word-card"><b>${v.q}</b><br><small>${v.a}</small>${v.wrongCount>0?`<span style="color:var(--danger);font-size:0.7rem;"><br>ğŸ”¥ë³µìŠµ(${v.wrongCount})</span>`:''}<button onclick="deleteWord(${i})" style="position:absolute;right:10px;top:10px;border:none;background:none;font-size:1.2rem;color:#ccc;">âœ•</button></div>`).reverse().join(''); }
    function deleteWord(i) { if(confirm("ì‚­ì œ?")) { vocabulary.splice(i,1); localStorage.setItem('myVocab',JSON.stringify(vocabulary)); renderWordList(); fillQuizDeck(); } }
    function triggerFile(m) { fileMode=m; document.getElementById('file-input').click(); }
    function handleFile(e) { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(evt)=>{ try { const d=JSON.parse(evt.target.result); if(fileMode==='append'){ let a=0; d.forEach(i=>{ if(!isDuplicate(i.q,i.a)){ vocabulary.push({...i,wrongCount:i.wrongCount||0}); a++; } }); showToast(`${a}ê°œ ì¶”ê°€`,'info'); } else { vocabulary=d.map(v=>({...v,wrongCount:v.wrongCount||0})); showToast("êµì²´ ì™„ë£Œ",'success'); } localStorage.setItem('myVocab',JSON.stringify(vocabulary)); renderWordList(); fillQuizDeck(); } catch(e){ showToast("íŒŒì¼ ì˜¤ë¥˜",'error'); } e.target.value=''; }; r.readAsText(f); }
    function exportJSON() { const b=new Blob([JSON.stringify(vocabulary,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=`quiz_backup.json`; a.click(); }
    function confirmExit() { if(confirm("ë‚˜ê°ˆê¹Œìš”?")) showScreen('home'); }
    window.onload = updateScores;
    window.addEventListener('mousemove', (e) => { if(isDragging) { moveHelper(e); updateGhost(e); } });
    window.addEventListener('mouseup', (e) => { if(isDragging) handleTouchEnd(e); });
</script>
</body>
</html>
