<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
<title>ì•”ê¸° í¼ì¦ PRO v16.2 (Restore)</title>
<style>
    :root {
        --p: #2e7d32; --s: #66bb6a; --bg: #e8f5e9;
        --grid-bg: #a5d6a7; --cell-bg: #c8e6c9; --bonus: #fdd835;
        --text: #1b5e20; --danger: #ef5350; --war: #ff9800;
        --excel: #1565c0; --edit: #7b1fa2;
    }

    * {
        box-sizing: border-box; -webkit-tap-highlight-color: transparent;
        margin: 0; padding: 0; user-select: none; -webkit-user-select: none;
    }

    /* ì•„ì´í° ì…ë ¥ ë²„ê·¸ ë°©ì§€ */
    input, textarea, [contenteditable] {
        user-select: text !important; -webkit-user-select: text !important;
    }

    body {
        font-family: -apple-system, 'Pretendard', sans-serif;
        background: var(--bg); color: var(--text);
        width: 100vw; height: 100dvh;
        display: flex; flex-direction: column; overflow: hidden;
    }

    .screen {
        display: none; width: 100%; height: 100%; flex-direction: column;
        padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
        overflow-y: auto;
    }
    .screen.active { display: flex; }

    .header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 0; min-height: 50px; flex-shrink: 0;
    }
    .title { font-size: 1.5rem; font-weight: 900; color: var(--p); }

    .card {
        background: #fff; border-radius: 15px; padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px;
    }

    .btn {
        width: 100%; padding: 15px; border-radius: 12px; border: none;
        font-size: 1rem; font-weight: bold; cursor: pointer; transition: .2s;
        display: flex; align-items: center; justify-content: center;
        gap: 5px; margin-bottom: 10px; color: #fff;
    }
    .btn:active { transform: scale(0.98); }
    .btn-p { background: var(--p); }
    .btn-s { background: var(--s); }
    .btn-d { background: var(--danger); }
    .btn-w { background: var(--war); }
    .btn-e { background: var(--excel); }
    .btn-m { background: var(--edit); }
    .btn-ghost { background: #fff; color: var(--text); border: 2px solid #ddd; }

    .input-box {
        width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px;
        font-size: 1rem; margin-bottom: 10px; resize: none; font-family: inherit;
    }

    /* ê²Œì„ ê´€ë ¨ */
    #game-area {
        flex: 1; display: flex; flex-direction: column;
        align-items: center; justify-content: center; width: 100%;
    }
    #score-board {
        display: flex; justify-content: space-between; width: 100%;
        padding: 0 10px; margin-bottom: 10px; font-weight: bold;
    }
    #grid-container {
        position: relative; touch-action: none; padding: 5px;
        background: #fff; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #grid {
        display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px;
        background: var(--grid-bg); padding: 4px; border-radius: 8px;
        width: 85vw; max-width: 350px; aspect-ratio: 1/1;
    }
    .cell {
        background: var(--cell-bg); border-radius: 2px; width: 100%; height: 100%;
        transition: 0.1s;
    }
    .cell.filled { background: var(--p); box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
    .cell.ghost { background: var(--p); opacity: 0.5; transform: scale(0.95); } /* ê³ ìŠ¤íŠ¸ íš¨ê³¼ ê°•í™” */
    .cell.clearing { background: var(--bonus); transform: scale(1.2); transition: 0.3s; }

    #tray {
        display: flex; justify-content: space-around; align-items: center;
        width: 100%; height: 100px; margin-top: 15px;
    }
    .shape-preview {
        width: 60px; height: 60px; display: grid; gap: 1px;
        align-content: center; justify-content: center; touch-action: none;
    }
    .preview-cell { width: 12px; height: 12px; background: #ccc; border-radius: 2px; }
    .preview-cell.filled { background: var(--p); }

    #drag-helper {
        position: fixed; z-index: 9999; pointer-events: none;
        display: grid; gap: 2px; transform: translate(-50%, -150%); /* ì†ê°€ë½ ìœ„ë¡œ ë„ì›€ */
    }
    #drag-helper .cell { width: 30px; height: 30px; background: var(--p); opacity: 0.9; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    /* íŒì—… ê³µí†µ */
    #quiz-modal, #expl-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 10000;
        display: none; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px;
    }
    #quiz-card, .expl-content {
        background: #fff; width: 100%; max-width: 500px;
        border-radius: 20px; padding: 20px; display: flex; flex-direction: column;
        max-height: 90vh; overflow-y: auto;
    }
    #q-content img { width: 100%; border-radius: 10px; margin-bottom: 10px; }
    #q-text-display { font-size: 1.3rem; font-weight: bold; text-align: center; margin: 20px 0; }
    #game-ans-input {
        width: 100%; padding: 15px; border: 3px solid var(--s);
        border-radius: 12px; font-size: 1.2rem; min-height: 50px;
        margin: 10px 0; outline: none; background: #fff;
    }

    /* ë¦¬ìŠ¤íŠ¸ ë° ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .img-preview-box {
        width: 100%; min-height: 150px; background: #f5f5f5;
        border: 2px dashed #ccc; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden; margin-bottom: 10px; position: relative;
    }
    .img-preview-box img { width: 100%; }
    
    .list-item-wrap {
        display: flex; align-items: center; background: #fff;
        border-bottom: 1px solid #eee; padding: 10px 0;
    }
    .chk-container {
        padding: 0 10px; display: flex; align-items: center; justify-content: center;
    }
    .list-chk {
        width: 20px; height: 20px; accent-color: var(--danger);
    }

    #toast {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
        border-radius: 20px; z-index: 20000; display: none;
    }
</style>
</head>
<body>
<div id="toast">ì•Œë¦¼</div>
<div id="drag-helper"></div> <div id="screen-home" class="screen active">
    <div class="header">
        <div class="title">ì•”ê¸° í¼ì¦ PRO <span id="total-count" style="font-size:0.9rem;color:#666;font-weight:normal">(0)</span></div>
    </div>
    
    <div class="card" style="border:2px solid var(--p); background:#f1f8e9;">
        <h3 style="margin-bottom:10px; color:var(--p); text-align:center;">ğŸ§© ë¸”ë¡ í¼ì¦ í•™ìŠµ</h3>
        
        <label style="display:flex; align-items:center; justify-content:center; gap:5px; margin-bottom:15px; cursor:pointer; padding:10px; background:rgba(255,255,255,0.5); border-radius:10px;">
            <input type="checkbox" id="focus-mode" style="width:20px; height:20px;">
            <span style="font-weight:bold; color:var(--danger); font-size:1rem;">ğŸ”¥ ì˜¤ë‹µ ë§ì€ ë¬¸ì œ ìš°ì„  ì¶œì œ</span>
        </label>

        <button class="btn btn-p" onclick="startGame()" style="font-size:1.2rem; padding:20px;">ğŸ® ê²Œì„ ì‹œì‘</button>
    </div>

    <div class="card">
        <div style="display:flex; gap:10px">
            <button class="btn btn-s" style="flex:1" onclick="openMaker('text')">ğŸ“ í…ìŠ¤íŠ¸ ë¬¸ì œ ì¶”ê°€</button>
            <button class="btn btn-w" style="flex:1" onclick="openMaker('image')">ğŸ“· ì´ë¯¸ì§€ ë¬¸ì œ ì¶”ê°€</button>
        </div>
    </div>

    <div class="card" style="background:var(--bg);box-shadow:none;border:2px dashed #ccc;padding:15px">
        <h3 style="margin-bottom:10px;font-size:1rem;color:#666">ë°ì´í„° ê´€ë¦¬</h3>
        <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;">
            <button class="btn btn-ghost" onclick="exportData()" style="flex:1;font-size:0.8rem">ğŸ“¤ ë°±ì—…</button>
            <button class="btn btn-ghost" onclick="document.getElementById('file-input').click()" style="flex:1;font-size:0.8rem">ğŸ“¥ ë³µêµ¬</button>
            <button class="btn btn-ghost" onclick="resetStats()" style="flex:1;font-size:0.8rem;color:var(--danger);border-color:var(--danger)">ğŸ”„ ì˜¤ë‹µ ì´ˆê¸°í™”</button>
        </div>
        <button id="btn-bulk-del" class="btn btn-d" onclick="deleteSelectedItems()" style="display:none; width:100%; font-size:0.9rem;">ğŸ—‘ï¸ ì„ íƒí•œ ë¬¸ì œ ì¼ê´„ ì‚­ì œ</button>
        <p style="font-size:0.7rem;color:#888;margin-top:5px">* ì´ë¯¸ì§€ í¬í•¨ (ëŒ€ìš©ëŸ‰ ì£¼ì˜)</p>
    </div>

    <div id="list-container" style="padding-bottom:50px"></div>
    <input type="file" id="file-input" style="display:none" onchange="importData(event)" accept=".json">
</div>

<div id="screen-text-maker" class="screen">
    <div class="header">
        <button class="btn btn-ghost" style="width:auto;padding:8px 15px" onclick="showScreen('home')">Back</button>
        <div class="title" style="font-size:1.2rem">í…ìŠ¤íŠ¸ ë¬¸ì œ</div>
    </div>
    <div class="card">
        <textarea id="tm-q" class="input-box" placeholder="ë¬¸ì œ (ì˜ˆ: ì‚¬ê³¼ì˜ ì˜ì–´ ë‹¨ì–´ëŠ”?)" style="height:100px"></textarea>
        <textarea id="tm-a" class="input-box" placeholder="ì •ë‹µ (ì˜ˆ: apple)"></textarea>
        <button id="btn-tm-save" class="btn btn-p" onclick="saveTextItem()">ë“±ë¡í•˜ê¸°</button>
    </div>
    
    <div class="card" id="excel-area" style="border:2px dashed var(--excel)">
        <h3 style="margin-bottom:10px;font-size:1rem;color:var(--excel)">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</h3>
        <textarea id="excel-input" class="input-box" style="height:100px;font-family:monospace;font-size:0.8rem" placeholder="ë¬¸ì œ    ì •ë‹µ&#10;ë¬¸ì œ    ì •ë‹µ&#10;(íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ì—‘ì…€ ë°ì´í„°)"></textarea>
        <button class="btn btn-e" onclick="parseExcel()">ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
    </div>
</div>

<div id="screen-img-maker" class="screen">
    <div class="header">
        <button class="btn btn-ghost" style="width:auto;padding:8px 15px" onclick="showScreen('home')">Back</button>
        <div class="title" style="font-size:1.2rem">ì´ë¯¸ì§€ ë¬¸ì œ</div>
    </div>
    
    <div class="card">
        <p style="font-weight:bold;margin-bottom:5px">1. ë¬¸ì œ ì´ë¯¸ì§€</p>
        <div class="img-preview-box" onclick="document.getElementById('im-q-file').click()">
            <div id="im-q-placeholder" class="img-placeholder">í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ<br>(ìë™ ì••ì¶•ë¨)</div>
            <img id="im-q-preview" style="display:none">
        </div>
        <input type="file" id="im-q-file" style="display:none" accept="image/*" onchange="handleImgInput(this, 'im-q-preview', 'im-q-placeholder')">

        <p style="font-weight:bold;margin-bottom:5px;margin-top:15px">2. ì •ë‹µ</p>
        <textarea id="im-a" class="input-box" placeholder="ì •ë‹µ ì…ë ¥ (ì½¤ë§ˆë¡œ ë³µìˆ˜ ì •ë‹µ ê°€ëŠ¥)"></textarea>

        <p style="font-weight:bold;margin-bottom:5px;margin-top:15px">3. í•´ì„¤ (ì„ íƒ)</p>
        <div class="img-preview-box" style="min-height:80px" onclick="document.getElementById('im-e-file').click()">
            <div id="im-e-placeholder" class="img-placeholder">í•´ì„¤ì§€ ì‚¬ì§„ (ì„ íƒ)</div>
            <img id="im-e-preview" style="display:none">
        </div>
        <input type="file" id="im-e-file" style="display:none" accept="image/*" onchange="handleImgInput(this, 'im-e-preview', 'im-e-placeholder')">
        <textarea id="im-desc" class="input-box" placeholder="í…ìŠ¤íŠ¸ í•´ì„¤ (ì„ íƒ)"></textarea>

        <button id="btn-im-save" class="btn btn-w" onclick="saveImgItem()">ë“±ë¡í•˜ê¸°</button>
    </div>
</div>
<div id="screen-game" class="screen">
    <div class="header">
        <button onclick="confirmExit()" style="padding:8px 15px;border-radius:10px;border:none;background:#fff;font-weight:bold;color:var(--text);box-shadow:0 2px 5px rgba(0,0,0,.1)">ğŸ  í™ˆìœ¼ë¡œ</button>
        <div style="font-size:1.2rem;font-weight:900;color:var(--p)">SCORE: <span id="score">0</span></div>
    </div>

    <div id="game-area">
        <div id="score-board">
            <span style="font-size:0.8rem;color:#888">BEST: <span id="high-score-game">0</span></span>
        </div>
        
        <div id="grid-container">
            <div id="grid"></div> 
        </div>

        <div id="tray"></div>
        <p style="font-size:0.75rem;color:#888;text-align:center;margin-top:10px">ë¸”ë¡ì„ ë‹¤ ì“°ë©´ í€´ì¦ˆê°€ ë‚˜ì˜µë‹ˆë‹¤.<br>(3ë¬¸ì œ ë‹¤ ë§íˆë©´ í™©ê¸ˆë¸”ë¡ íšë“! ğŸŒŸ)</p>
    </div>
</div>

<div id="quiz-modal">
    <div id="quiz-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <h3 style="color:var(--p);margin:0">ğŸ§© ë¸”ë¡ ì¶©ì „ í€´ì¦ˆ!</h3>
            <span id="quiz-progress" style="font-weight:bold; color:#666; font-size:0.9rem;">1 / 3</span>
        </div>

        <div id="quiz-viewport" style="max-height:40vh; margin-bottom:10px; overflow-y:auto;">
            <div id="game-q-content" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        </div>

        <div id="game-ans-input" contenteditable="true" class="input-box" style="min-height:50px; border:3px solid var(--s);"></div>
        
        <div id="game-feedback" style="text-align:center; font-weight:900; font-size:1.2rem; min-height:30px; margin-top:5px;"></div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-d" style="flex:1" onclick="giveUpQuiz()">ğŸ³ï¸ í¬ê¸° (ë¸”ë¡ ì—†ìŒ)</button>
            <button class="btn btn-p" style="flex:2" onclick="checkRefillAnswer()">ì •ë‹µ í™•ì¸</button>
        </div>
    </div>
</div>

<div id="expl-modal">
    <div class="expl-content">
        <h2 style="color:var(--danger);margin-bottom:15px">ì˜¤ë‹µì…ë‹ˆë‹¤!</h2>
        <div style="width:100%;margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:10px">
            <p><b>ì •ë‹µ:</b> <span id="expl-ans" style="color:var(--p);font-weight:bold;font-size:1.2rem"></span></p>
        </div>
        <div id="expl-body" style="width:100%;flex:1;overflow-y:auto;text-align:center"></div>
    </div>
    <div style="display:flex;gap:10px;width:100%">
        <button class="btn btn-p" style="flex:1" onclick="closeExpl(true)">ğŸ¥º ë„˜ì–´ê°€ê¸° (ë‹¤ìŒ ë¬¸ì œ)</button>
    </div>
</div>
<script>
// --- 1. IndexedDB ì—”ì§„ (ë¬´ì œí•œ ìš©ëŸ‰) ---
const DB_NAME = 'MemoryPuzzlePRO_v16_2'; // Restore ë²„ì „
const DB_VER = 1;
let db;

function initDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('items')) {
                db.createObjectStore('items', { keyPath: 'id' });
            }
        };
        req.onsuccess = (e) => {
            db = e.target.result;
            resolve(db);
            loadList(); // ì•± ì‹œì‘ ì‹œ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
        };
        req.onerror = (e) => { reject(e); };
    });
}

function dbPut(item) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(['items'], 'readwrite');
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject();
        tx.objectStore('items').put(item);
    });
}

function dbGetAll() {
    return new Promise((resolve) => {
        const tx = db.transaction(['items'], 'readonly');
        const req = tx.objectStore('items').getAll();
        req.onsuccess = () => resolve(req.result);
    });
}

function dbDelete(id) {
    return new Promise((resolve) => {
        const tx = db.transaction(['items'], 'readwrite');
        tx.oncomplete = () => resolve();
        tx.objectStore('items').delete(id);
    });
}

function dbClear() {
    return new Promise((resolve) => {
        const tx = db.transaction(['items'], 'readwrite');
        tx.oncomplete = () => resolve();
        tx.objectStore('items').clear();
    });
}

// --- 2. ì´ë¯¸ì§€ ì••ì¶• (HDí™”ì§ˆ ìµœì í™”) ---
function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_SIZE = 1280;
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
                else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
        };
    });
}

// --- 3. ì „ì—­ ë³€ìˆ˜ ë° í™”ë©´ ê´€ë¦¬ ---
let currentList = [];
let editingId = null;
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioContext = null;

window.onload = () => { initDB(); };

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none' }, 2000);
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
    if (id === 'home') loadList();
}
</script> ```
*(ì°¸ê³ : ë§ˆì§€ë§‰ì— `</script>`ê°€ ìˆì–´ë„ ë‹¤ìŒ íŒŒíŠ¸ì¸ `<script>`ê°€ ì´ì–´ì§€ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë˜ë‹ˆ ê±±ì • ë§ˆì„¸ìš”!)*

**ë¶™ì—¬ë„£ê¸° ì™„ë£Œ í›„ "ë‹¤ìŒ"ì´ë¼ê³  ë§ì”€í•´ ì£¼ì‹œë©´, ì¼ê´„ ì‚­ì œ ê¸°ëŠ¥ì´ í¬í•¨ëœ [Part 5]ë¥¼ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.**
<script>
// --- 4. ë¬¸ì œ ë“±ë¡/ìˆ˜ì •/ì‚­ì œ ë¡œì§ ---

function openMaker(type, id = null) {
    editingId = id;
    resetForms();

    if (id !== null) {
        // ìˆ˜ì • ëª¨ë“œ
        const item = currentList.find(i => i.id === id);
        if (!item) return;

        if (type === 'text') {
            document.getElementById('tm-q').value = item.q;
            document.getElementById('tm-a').value = item.a;
            document.getElementById('btn-tm-save').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('excel-area').style.display = 'none';
        } else {
            document.getElementById('im-q-preview').src = item.q;
            document.getElementById('im-q-preview').style.display = 'block';
            document.getElementById('im-q-placeholder').style.display = 'none';
            document.getElementById('im-a').value = item.a;
            if (item.explImg) {
                document.getElementById('im-e-preview').src = item.explImg;
                document.getElementById('im-e-preview').style.display = 'block';
                document.getElementById('im-e-placeholder').style.display = 'none';
            }
            document.getElementById('im-desc').value = item.desc || '';
            document.getElementById('btn-im-save').innerText = "ìˆ˜ì • ì™„ë£Œ";
        }
    } else {
        // ì‹ ê·œ ëª¨ë“œ
        document.getElementById('btn-tm-save').innerText = "ë“±ë¡í•˜ê¸°";
        document.getElementById('btn-im-save').innerText = "ë“±ë¡í•˜ê¸°";
        document.getElementById('excel-area').style.display = 'block';
    }
    showScreen(type === 'text' ? 'text-maker' : 'img-maker');
}

function resetForms() {
    document.getElementById('tm-q').value = '';
    document.getElementById('tm-a').value = '';
    document.getElementById('excel-input').value = '';
    document.getElementById('im-q-file').value = '';
    document.getElementById('im-q-preview').src = '';
    document.getElementById('im-q-preview').style.display = 'none';
    document.getElementById('im-q-placeholder').style.display = 'block';
    document.getElementById('im-a').value = '';
    document.getElementById('im-e-file').value = '';
    document.getElementById('im-e-preview').src = '';
    document.getElementById('im-e-preview').style.display = 'none';
    document.getElementById('im-e-placeholder').style.display = 'block';
    document.getElementById('im-desc').value = '';
}

async function saveTextItem() {
    const q = document.getElementById('tm-q').value.trim();
    const a = document.getElementById('tm-a').value.trim();
    if (!q || !a) return showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');

    let wrongCnt = 0;
    if (editingId) {
        const old = currentList.find(i => i.id === editingId);
        if (old) wrongCnt = old.wrong;
    }

    await dbPut({
        id: editingId || Date.now(),
        type: 'text', q: q, a: a, wrong: wrongCnt
    });
    showToast(editingId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡ ì™„ë£Œ');
    showScreen('home');
}

async function parseExcel() {
    const raw = document.getElementById('excel-input').value.trim();
    if (!raw) return showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
    const rows = raw.split('\n');
    let count = 0;
    for (const row of rows) {
        const cols = row.split('\t');
        if (cols.length >= 2) {
            const q = cols[0].trim();
            const a = cols[1].trim();
            if (q && a) {
                await dbPut({
                    id: Date.now() + Math.random(),
                    type: 'text', q: q, a: a, wrong: 0
                });
                count++;
            }
        }
    }
    showToast(`${count}ê°œ ì¼ê´„ ë“±ë¡ ì™„ë£Œ!`);
    showScreen('home');
}

async function handleImgInput(input, imgId, placeId) {
    if (input.files && input.files[0]) {
        showToast('ì´ë¯¸ì§€ ì••ì¶• ì¤‘...');
        const compressed = await compressImage(input.files[0]);
        const img = document.getElementById(imgId);
        img.src = compressed;
        img.style.display = 'block';
        document.getElementById(placeId).style.display = 'none';
        showToast('ì´ë¯¸ì§€ ì¤€ë¹„ ì™„ë£Œ');
    }
}

async function saveImgItem() {
    const qImgSrc = document.getElementById('im-q-preview').src;
    const a = document.getElementById('im-a').value.trim();
    const eImgSrc = document.getElementById('im-e-preview').src;
    const desc = document.getElementById('im-desc').value.trim();

    if (!qImgSrc || document.getElementById('im-q-preview').style.display === 'none') {
        return showToast('ë¬¸ì œ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤');
    }
    if (!a) return showToast('ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”');

    let wrongCnt = 0;
    if (editingId) {
        const old = currentList.find(i => i.id === editingId);
        if (old) wrongCnt = old.wrong;
    }

    await dbPut({
        id: editingId || Date.now(),
        type: 'image',
        q: qImgSrc, a: a,
        explImg: (eImgSrc && document.getElementById('im-e-preview').style.display !== 'none') ? eImgSrc : null,
        desc: desc,
        wrong: wrongCnt
    });
    showToast(editingId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡ ì™„ë£Œ');
    showScreen('home');
}

// ë¦¬ìŠ¤íŠ¸ ë¡œë”© (ì¼ê´„ ì‚­ì œìš© ì²´í¬ë°•ìŠ¤ ì¶”ê°€)
async function loadList() {
    currentList = await dbGetAll();
    document.getElementById('total-count').innerText = `(${currentList.length})`;
    const container = document.getElementById('list-container');
    
    // ì¼ê´„ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€ ì´ˆê¸°í™”
    document.getElementById('btn-bulk-del').style.display = 'none';

    container.innerHTML = currentList.slice().reverse().map(item => {
        let infoHtml = '';
        const wrongBadge = item.wrong > 0 ? `<span style="color:var(--danger);font-size:0.7rem;font-weight:bold;margin-left:5px">ğŸ”¥ì˜¤ë‹µ ${item.wrong}</span>` : '';
        
        if (item.type === 'text') {
            infoHtml = `<span class="item-tag tag-txt" style="background:#eee;padding:2px 5px;border-radius:4px;font-size:0.7rem;margin-right:5px">í…ìŠ¤íŠ¸</span>${wrongBadge}<div class="item-q" style="font-weight:bold;margin-top:5px">${item.q}</div><div class="item-a" style="color:var(--p)">${item.a}</div>`;
        } else {
            infoHtml = `<span class="item-tag tag-img" style="background:#e3f2fd;padding:2px 5px;border-radius:4px;font-size:0.7rem;margin-right:5px">ì´ë¯¸ì§€</span>${wrongBadge}<div class="item-q" style="font-weight:bold;margin-top:5px">ì´ë¯¸ì§€ ë¬¸ì œ</div><div class="item-a" style="color:var(--p)">ë‹µ: ${item.a}</div>`;
        }
        
        return `
        <div class="list-item-wrap">
            <div class="chk-container">
                <input type="checkbox" class="list-chk" value="${item.id}" onchange="toggleBulkBtn()">
            </div>
            <div style="flex:1; padding-left:5px;">${infoHtml}</div>
            <div class="item-btns" style="display:flex; flex-direction:column; gap:5px; padding-right:10px;">
                <button class="btn btn-m" style="width:auto;padding:5px 10px;font-size:0.8rem;margin:0" onclick="openMaker('${item.type}', ${item.id})">ìˆ˜ì •</button>
            </div>
        </div>`;
    }).join('');
}

// ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ 'ì¼ê´„ ì‚­ì œ' ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
function toggleBulkBtn() {
    const chks = document.querySelectorAll('.list-chk:checked');
    const btn = document.getElementById('btn-bulk-del');
    if (chks.length > 0) {
        btn.style.display = 'block';
        btn.innerText = `ğŸ—‘ï¸ ì„ íƒí•œ ${chks.length}ê°œ ë¬¸ì œ ì‚­ì œ`;
    } else {
        btn.style.display = 'none';
    }
}

// ì„ íƒí•œ í•­ëª© ì¼ê´„ ì‚­ì œ
async function deleteSelectedItems() {
    const chks = document.querySelectorAll('.list-chk:checked');
    if (chks.length === 0) return;
    
    if (confirm(`ì„ íƒí•œ ${chks.length}ê°œì˜ ë¬¸ì œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        for (const chk of chks) {
            await dbDelete(parseFloat(chk.value)); // IDëŠ” ìˆ«ìí˜•
        }
        await loadList();
        showToast("ì‚­ì œ ì™„ë£Œ");
    }
}

async function resetStats() {
    if (!confirm('ëª¨ë“  ë¬¸ì œì˜ ì˜¤ë‹µ ê¸°ë¡(ğŸ”¥)ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    for (const item of currentList) {
        item.wrong = 0;
        await dbPut(item);
    }
    loadList();
    showToast('ì˜¤ë‹µ ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ');
}

// --- 5. ë°±ì—…/ë³µêµ¬ ê¸°ëŠ¥ ---
async function exportData() {
    const list = await dbGetAll();
    if (list.length === 0) return showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    showToast('ë°±ì—… íŒŒì¼ ìƒì„± ì¤‘...');
    setTimeout(() => {
        const blob = new Blob([JSON.stringify(list)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `MemoryPuzzle_Backup_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
    }, 100);
}

function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (!confirm("âš ï¸ ì£¼ì˜: [í™•ì¸]ì„ ëˆ„ë¥´ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš°ê³  'ë®ì–´ì“°ê¸°' í•©ë‹ˆë‹¤.\n[ì·¨ì†Œ]ë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ ë°ì´í„° ë’¤ì— 'ì¶”ê°€(í•©ì¹˜ê¸°)' í•©ë‹ˆë‹¤.")) {
        processImport(file, false); // ì·¨ì†Œ -> í•©ì¹˜ê¸°
    } else {
        processImport(file, true); // í™•ì¸ -> ë®ì–´ì“°ê¸°
    }
    e.target.value = '';
}

function processImport(file, isOverwrite) {
    showToast('íŒŒì¼ ì½ëŠ” ì¤‘...');
    const reader = new FileReader();
    reader.onload = async (ev) => {
        try {
            const data = JSON.parse(ev.target.result);
            if (!Array.isArray(data)) throw new Error();
            showToast(`${data.length}ê°œ ë°ì´í„° ì²˜ë¦¬ ì¤‘...`);
            if (isOverwrite) await dbClear();
            for (const item of data) {
                if (!isOverwrite) item.id = Date.now() + Math.random();
                await dbPut(item);
            }
            await loadList();
            showToast('ë³µêµ¬ ì™„ë£Œ!');
        } catch (err) {
            alert('ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
        }
    };
    reader.readAsText(file);
}
</script>
<script>
// --- 6. ë¸”ë¡ í¼ì¦ ê²Œì„ ì—”ì§„ (Restore) ---

// ë¸”ë¡ ëª¨ì–‘ ì •ì˜ (ë§¤ìš´ë§› í¬í•¨ ë³µêµ¬)
const SHAPES = [
    [[0,0],[0,1],[1,0],[1,1]], // O (ë„¤ëª¨)
    [[0,0],[1,0],[2,0],[3,0],[4,0]], // I (5ì¹¸ ì„¸ë¡œ) - ì–´ë ¤ì›€!
    [[0,0],[0,1],[0,2],[0,3],[0,4]], // I (5ì¹¸ ê°€ë¡œ) - ì–´ë ¤ì›€!
    [[0,0],[1,0],[2,0]], // I (3ì¹¸ ì„¸ë¡œ)
    [[0,0],[0,1],[0,2]], // I (3ì¹¸ ê°€ë¡œ)
    [[0,0],[1,0],[2,0],[2,1],[2,2]], // L (3x3)
    [[0,0],[0,1],[0,2],[1,2],[2,2]], // L ë°˜ëŒ€
    [[0,0],[1,1],[2,2],[3,3]], // ëŒ€ê°ì„  (4ì¹¸)
    [[0,2],[1,2],[2,0],[2,1],[2,2]], // T (3x3)
    [[0,1],[1,0],[1,1],[1,2],[2,1]], // ì‹­ìê°€ (+) - ì–´ë ¤ì›€!
    [[0,0],[0,1],[1,1],[1,2],[2,2]]  // Z (3x3)
];

let grid = Array(64).fill(0); // 8x8 ê²©ì
let trayShapes = []; // ëŒ€ê¸° ì¤‘ì¸ ë¸”ë¡ 3ê°œ
let highScore = localStorage.getItem('puzzleBest') || 0;
let isDragging = false;
let dragShapeIndex = null;
let masterR = 0, masterC = 0; // ë“œë˜ê·¸ ì¤‘ì‹¬ì 
let pendingBlock = null; // ë†“ìœ¼ë ¤ê³  í•˜ëŠ” ìœ„ì¹˜
const TOUCH_OFFSET = 80; // ì†ê°€ë½ ê°€ë¦¼ ë°©ì§€

// ê²Œì„ ì‹œì‘
function startGame() {
    if (currentList.length < 1) return showToast("ë¬¸ì œë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!");
    
    score = 0;
    grid.fill(0);
    document.getElementById('score').innerText = 0;
    document.getElementById('high-score-game').innerText = highScore;
    
    // ê²©ì ê·¸ë¦¬ê¸°
    const g = document.getElementById('grid');
    g.innerHTML = "";
    for (let i = 0; i < 64; i++) {
        const c = document.createElement('div');
        c.className = 'cell';
        c.id = 'cell-' + i;
        g.appendChild(c);
    }
    
    // ë¬¸ì œ ì„ê¸° (ì§‘ì¤‘ ê³µëµ or ëœë¤)
    const isFocusMode = document.getElementById('focus-mode').checked;
    if (isFocusMode) {
        quizQueue = [...currentList].sort((a, b) => (b.wrong || 0) - (a.wrong || 0));
        showToast("ğŸ”¥ ì˜¤ë‹µ ì§‘ì¤‘ ëª¨ë“œ í™œì„±í™”!");
    } else {
        quizQueue = [...currentList].sort(() => Math.random() - 0.5);
        showToast("ğŸ² ëœë¤ í•™ìŠµ ëª¨ë“œ ì‹œì‘!");
    }
    
    curQuizIdx = 0;
    refillTray(); // ìµœì´ˆ ë¸”ë¡ ì±„ìš°ê¸°
    showScreen('game');
}

// íŠ¸ë ˆì´ ì±„ìš°ê¸° (í€´ì¦ˆ ì—†ì´ ì±„ì›€ - ê²Œì„ ì‹œì‘ ì‹œ)
function refillTray() {
    trayShapes = [0, 1, 2].map(() => getRandomShape());
    renderTray();
    checkGameOver();
}

// ë¸”ë¡ ëœë¤ ìƒì„± í•¨ìˆ˜
function getRandomShape() {
    // 5% í™•ë¥ ë¡œ 1ì¹¸ì§œë¦¬ í™©ê¸ˆ ë³´ë„ˆìŠ¤ ë¸”ë¡ (ìœ„ê¸° íƒˆì¶œìš©)
    if (Math.random() < 0.05) return { pts: [[0,0]], isBonus: true };
    return { pts: [...SHAPES[Math.floor(Math.random() * SHAPES.length)]], isBonus: false };
}

// íŠ¸ë ˆì´ í™”ë©´ ê·¸ë¦¬ê¸°
function renderTray() {
    const t = document.getElementById('tray');
    t.innerHTML = "";
    trayShapes.forEach((s, i) => {
        if (!s) return;
        const d = document.createElement('div');
        d.className = 'shape-preview';
        
        d.addEventListener('touchstart', e => handleStart(e, i), { passive: false });
        d.addEventListener('mousedown', e => handleStart(e, i));
        
        // ë¸”ë¡ í¬ê¸° ê³„ì‚°
        let minR = 5, minC = 5, maxR = -1, maxC = -1;
        s.pts.forEach(p => {
            minR = Math.min(minR, p[0]); maxR = Math.max(maxR, p[0]);
            minC = Math.min(minC, p[1]); maxC = Math.max(maxC, p[1]);
        });
        d.style.gridTemplateRows = `repeat(${maxR - minR + 1}, 1fr)`;
        d.style.gridTemplateColumns = `repeat(${maxC - minC + 1}, 1fr)`;
        d.style.width = (maxC - minC + 1) * 15 + 'px';
        d.style.height = (maxR - minR + 1) * 15 + 'px';

        s.pts.forEach(p => {
            const el = document.createElement('div');
            el.className = s.isBonus ? 'preview-cell filled bonus' : 'preview-cell filled';
            el.style.gridRow = p[0] - minR + 1;
            el.style.gridColumn = p[1] - minC + 1;
            d.appendChild(el);
        });
        t.appendChild(d);
    });
}

// --- ì«€ë“í•œ ì¡°ì‘ê° (Magnet Snapping) ë¡œì§ ---
function handleStart(e, i) {
    if (e.cancelable && e.type === 'touchstart') e.preventDefault();
    isDragging = true;
    dragShapeIndex = i;
    const s = trayShapes[i].pts;
    
    let minR = 5, minC = 5, maxR = -1, maxC = -1;
    s.forEach(p => {
        minR = Math.min(minR, p[0]); maxR = Math.max(maxR, p[0]);
        minC = Math.min(minC, p[1]); maxC = Math.max(maxC, p[1]);
    });
    masterR = minR; masterC = minC;

    const h = document.getElementById('drag-helper');
    h.innerHTML = "";
    h.style.gridTemplateRows = `repeat(${maxR - minR + 1}, 30px)`;
    h.style.gridTemplateColumns = `repeat(${maxC - minC + 1}, 30px)`;
    s.forEach(p => {
        const el = document.createElement('div');
        el.className = 'cell';
        if (trayShapes[i].isBonus) el.style.background = 'var(--bonus)';
        el.style.gridRow = p[0] - minR + 1;
        el.style.gridColumn = p[1] - minC + 1;
        h.appendChild(el);
    });
    h.style.display = "grid";
    
    moveHelper(e);
    playSound('click');
}

window.addEventListener('touchmove', handleMove, { passive: false });
window.addEventListener('mousemove', handleMove);
window.addEventListener('touchend', handleEnd);
window.addEventListener('mouseup', handleEnd);

function handleMove(e) {
    if (!isDragging) return;
    if (e.cancelable) e.preventDefault();
    moveHelper(e);
    
    // ì¢Œí‘œ ê¸°ë°˜ ë§ˆê·¸ë„¤í‹± ìŠ¤ë‚´í•‘ (v14 ë°©ì‹ ë³µì›)
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    
    // ê²©ìíŒì˜ ìœ„ì¹˜ ì •ë³´ íšë“
    const gridRect = document.getElementById('grid').getBoundingClientRect();
    const cellSize = gridRect.width / 8; // ì…€ í•˜ë‚˜ í¬ê¸° ê³„ì‚°
    
    // ê²©ì ì•ˆì— ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
    if (cx >= gridRect.left && cx <= gridRect.right && 
        cy - TOUCH_OFFSET >= gridRect.top && cy - TOUCH_OFFSET <= gridRect.bottom) {
        
        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì…€ ì¸ë±ìŠ¤ ê³„ì‚° (ìì„ íš¨ê³¼)
        const relativeX = cx - gridRect.left;
        const relativeY = (cy - TOUCH_OFFSET) - gridRect.top;
        
        const col = Math.floor(relativeX / cellSize);
        const row = Math.floor(relativeY / cellSize);
        
        // ë¸”ë¡ì˜ ì¤‘ì‹¬ì (masterR, masterC)ì„ ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜ ì‹œë„
        checkPlacement(row, col);
    } else {
        clearGhost();
    }
}

function moveHelper(e) {
    const h = document.getElementById('drag-helper');
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    h.style.left = cx + 'px';
    h.style.top = (cy - TOUCH_OFFSET) + 'px';
}

function checkPlacement(r, c) {
    const s = trayShapes[dragShapeIndex].pts;
    const inds = [];
    
    // ìœ íš¨ì„± ê²€ì‚¬: ê²©ìë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šê³ , ì´ë¯¸ ì±„ì›Œì§„ ì¹¸ì´ ì•„ë‹ˆì–´ì•¼ í•¨
    const valid = s.every(p => {
        const nr = r + (p[0] - masterR);
        const nc = c + (p[1] - masterC);
        if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && grid[nr * 8 + nc] === 0) {
            inds.push(nr * 8 + nc);
            return true;
        }
        return false;
    });

    // ê³ ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
    document.querySelectorAll('.cell.ghost').forEach(el => el.className = 'cell');
    if (valid) {
        inds.forEach(idx => document.getElementById('cell-' + idx).classList.add('ghost'));
        pendingBlock = inds;
    } else {
        pendingBlock = null;
    }
}

function clearGhost() {
    document.querySelectorAll('.cell.ghost').forEach(c => c.className = 'cell');
    pendingBlock = null;
}

function handleEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    document.getElementById('drag-helper').style.display = "none";
    clearGhost();
    
    // ë¸”ë¡ ë†“ê¸° ì„±ê³µ ì‹œ
    if (pendingBlock) {
        commitBlock();
    } else {
        // ì‹¤íŒ¨ ì‹œ ì œìë¦¬ë¡œ
        playSound('wrong'); 
    }
    
    pendingBlock = null;
    dragShapeIndex = null;
}
</script>
// --- 7. ë¦¬í•„ í€´ì¦ˆ ë° ê²Œì„ ì±„ì  ë¡œì§ ---

let refillStage = 0; // í˜„ì¬ í€´ì¦ˆ ë‹¨ê³„ (0~2)
let refillCorrectCnt = 0; // ë§íŒ ê°œìˆ˜
let perfectBonus = false; // í™©ê¸ˆ ë¸”ë¡ ë³´ë„ˆìŠ¤ ì—¬ë¶€
let currentQuizItem = null; // í˜„ì¬ ë¬¸ì œ

// ë¸”ë¡ í™•ì • (ê²©ìì— ê¸°ë¡)
function commitBlock() {
    if (!pendingBlock || dragShapeIndex === null) return;
    
    playSound('place');
    pendingBlock.forEach(idx => {
        grid[idx] = 1; 
        const c = document.getElementById('cell-' + idx);
        c.className = 'cell filled';
        // ë³´ë„ˆìŠ¤ ë¸”ë¡ì´ì—ˆë‹¤ë©´ ë…¸ë€ìƒ‰ ìœ ì§€
        if (trayShapes[dragShapeIndex].isBonus) c.style.background = 'var(--bonus)';
    });
    
    trayShapes[dragShapeIndex] = null; // ì‚¬ìš©í•œ ë¸”ë¡ ë¹„ìš°ê¸°
    renderTray();
    checkLines(); // ì¤„ ì‚­ì œ ê²€ì‚¬
    
    // ë¸”ë¡ì„ ë‹¤ ì¼ìœ¼ë©´ -> í€´ì¦ˆ ì‹œì‘! (v14 ë°©ì‹)
    if (trayShapes.every(s => s === null)) {
        startRefillQuiz();
    } else {
        checkGameOver();
    }
}

// ë¦¬í•„ í€´ì¦ˆ ì‹œì‘ (3ë¬¸ì œ)
function startRefillQuiz() {
    // í€´ì¦ˆ íê°€ ë¹„ì—ˆê±°ë‚˜ ë¶€ì¡±í•˜ë©´ ë‹¤ì‹œ ì±„ì›€
    if (!quizQueue || quizQueue.length < 3) {
        const isFocusMode = document.getElementById('focus-mode').checked;
        if (isFocusMode) {
            quizQueue = [...currentList].sort((a, b) => (b.wrong || 0) - (a.wrong || 0));
        } else {
            quizQueue = [...currentList].sort(() => Math.random() - 0.5);
        }
        // ê·¸ë˜ë„ ì—†ìœ¼ë©´ (ë¬¸ì œê°€ 3ê°œ ë¯¸ë§Œì¼ ë•Œ) ì¤‘ë³µ í—ˆìš©
        if (quizQueue.length < 3 && currentList.length > 0) {
            while (quizQueue.length < 3) quizQueue.push(currentList[0]);
        }
    }

    refillStage = 0;
    refillCorrectCnt = 0;
    perfectBonus = false;
    showRefillQuestion();
}

// ë¬¸ì œ í‘œì‹œ
function showRefillQuestion() {
    // í ìˆœí™˜
    if (curQuizIdx >= quizQueue.length) curQuizIdx = 0;
    currentQuizItem = quizQueue[curQuizIdx];
    curQuizIdx++;

    const modal = document.getElementById('quiz-modal');
    const content = document.getElementById('game-q-content');
    const input = document.getElementById('game-ans-input');
    const fb = document.getElementById('game-feedback');
    const progress = document.getElementById('quiz-progress');

    // UI ì´ˆê¸°í™”
    content.innerHTML = "";
    input.innerText = "";
    fb.innerText = "";
    progress.innerText = `${refillStage + 1} / 3`;

    if (currentQuizItem.type === 'text') {
        content.innerHTML = `<div id="q-text-display">${currentQuizItem.q}</div>`;
    } else {
        const img = document.createElement('img');
        img.src = currentQuizItem.q;
        content.appendChild(img);
    }

    modal.style.display = 'flex';
    input.focus();
}

// ì •ë‹µ í™•ì¸
async function checkRefillAnswer() {
    const userAns = document.getElementById('game-ans-input').innerText.trim().toUpperCase().replace(/\s/g,'');
    const answers = currentQuizItem.a.toUpperCase().split(',').map(s=>s.trim().replace(/\s/g,''));
    
    const isCorrect = answers.some(ans => {
        if((ans==='O'||ans==='X') && (userAns==='ã…‡'||userAns==='O')) return ans==='O';
        if((ans==='O'||ans==='X') && (userAns==='ã„´'||userAns==='X')) return ans==='X';
        return ans === userAns;
    });

    const fb = document.getElementById('game-feedback');
    
    if (isCorrect) {
        fb.innerText = "ì •ë‹µ! â­•";
        fb.style.color = "var(--p)";
        playSound('correct');
        refillCorrectCnt++;
        
        if (currentQuizItem.wrong > 0) currentQuizItem.wrong--; // ë³µìŠµ ì„±ê³µ ì‹œ ì˜¤ë‹µ ì°¨ê°
        await dbPut(currentQuizItem);

        setTimeout(() => {
            nextRefillStage();
        }, 800);
    } else {
        fb.innerText = "ì˜¤ë‹µ! âŒ";
        fb.style.color = "var(--danger)";
        playSound('wrong');
        
        currentQuizItem.wrong = (currentQuizItem.wrong || 0) + 1; // ì˜¤ë‹µ ì¹´ìš´íŠ¸ ì¦ê°€
        await dbPut(currentQuizItem);

        setTimeout(() => {
            document.getElementById('quiz-modal').style.display = 'none';
            showExpl(currentQuizItem); // í•´ì„¤ ë³´ì—¬ì£¼ê¸°
        }, 800);
    }
}

// ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
function nextRefillStage() {
    refillStage++;
    if (refillStage < 3) {
        showRefillQuestion(); // ë‹¤ìŒ ë¬¸ì œ
    } else {
        // 3ë¬¸ì œ ì¢…ë£Œ
        document.getElementById('quiz-modal').style.display = 'none';
        
        let msg = `${refillCorrectCnt}ë¬¸ì œ ì •ë‹µ!`;
        if (refillCorrectCnt === 3) {
            perfectBonus = true; // 3ë¬¸ì œ ë‹¤ ë§íˆë©´ ë³´ë„ˆìŠ¤ í™œì„±í™”
            msg += " ğŸŒŸí™©ê¸ˆ ë¸”ë¡ íšë“!ğŸŒŸ";
            playSound('correct');
        }
        showToast(msg);
        
        // â˜… [ì¤‘ìš”] ì—¬ê¸°ì„œ ë¦¬í•„ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        // Part 6ì˜ refillTrayë¥¼ ë®ì–´ì“°ê¸° ìœ„í•´ ì•„ë˜ì— ì¬ì •ì˜í•©ë‹ˆë‹¤.
        refillTrayWithBonus(); 
    }
}

// ë³´ë„ˆìŠ¤ë¥¼ ì ìš©í•œ ë¦¬í•„ í•¨ìˆ˜ (Part 6ì˜ í•¨ìˆ˜ ëŒ€ì²´ìš©)
function refillTrayWithBonus() {
    trayShapes = [0, 1, 2].map((_, i) => {
        // í¼í™íŠ¸ ë³´ë„ˆìŠ¤ë©´ ê°€ìš´ë°(1ë²ˆ ì¸ë±ìŠ¤)ì— 1x1 í™©ê¸ˆë¸”ë¡ í™•ì • ì§€ê¸‰
        if (perfectBonus && i === 1) {
            return { pts: [[0,0]], isBonus: true };
        }
        return getRandomShape(); // Part 6ì˜ í•¨ìˆ˜ ì‚¬ìš©
    });
    
    perfectBonus = false; // ë³´ë„ˆìŠ¤ ì‚¬ìš© ì™„ë£Œ
    renderTray(); // í™”ë©´ ê°±ì‹ 
    checkGameOver(); // ê²Œì„ì˜¤ë²„ ì²´í¬
}

// ì—”í„°í‚¤ ì²˜ë¦¬
document.getElementById('game-ans-input').addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
        e.preventDefault();
        checkRefillAnswer();
    }
});

// í¬ê¸° ë²„íŠ¼ (ì˜¤ë‹µ ì²˜ë¦¬)
function giveUpQuiz() {
    // í¬ê¸°í•˜ë©´ í‹€ë¦° ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  í•´ì„¤ì„ ë³´ì—¬ì¤Œ
    document.getElementById('game-feedback').innerText = "í¬ê¸°... âŒ";
    document.getElementById('game-feedback').style.color = "var(--danger)";
    setTimeout(() => {
        document.getElementById('quiz-modal').style.display = 'none';
        showExpl(currentQuizItem);
    }, 500);
}

// í•´ì„¤ íŒì—… ë‹«ê¸° (ë‹¤ìŒ ë¬¸ì œë¡œ)
function closeExpl(isNext) {
    document.getElementById('expl-modal').style.display = 'none';
    if (isNext) {
        // í•´ì„¤ ë³´ê³  'ë„˜ì–´ê°€ê¸°' ëˆ„ë¥´ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ
        nextRefillStage();
    }
}

// ì¤„ ì‚­ì œ ê²€ì‚¬
function checkLines() {
    let lines = [];
    for (let r = 0; r < 8; r++) {
        if (grid.slice(r * 8, r * 8 + 8).every(v => v === 1)) lines.push({type:'r', idx:r});
    }
    for (let c = 0; c < 8; c++) {
        let col = [];
        for (let r = 0; r < 8; r++) col.push(grid[r * 8 + c]);
        if (col.every(v => v === 1)) lines.push({type:'c', idx:c});
    }
    
    if (lines.length > 0) {
        playSound('clear');
        lines.forEach(l => {
            if (l.type === 'r') {
                for (let i = 0; i < 8; i++) animateClear(l.idx * 8 + i);
            } else {
                for (let i = 0; i < 8; i++) animateClear(i * 8 + l.idx);
            }
        });
        
        score += (lines.length * 10) + (lines.length * lines.length * 5);
        document.getElementById('score').innerText = score;
        
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('puzzleBest', highScore);
            document.getElementById('high-score-game').innerText = highScore;
        }
    }
}

function animateClear(idx) {
    grid[idx] = 0;
    const c = document.getElementById('cell-' + idx);
    c.classList.add('clearing');
    setTimeout(() => {
        c.className = 'cell';
        c.style.background = '';
    }, 300);
}

function checkGameOver() {
    const ok = trayShapes.some(s => {
        if (!s) return false;
        for (let i = 0; i < 64; i++) {
            const r = Math.floor(i / 8);
            const c = i % 8;
            const fit = s.pts.every(p => {
                const nr = r + p[0];
                const nc = c + p[1];
                return nr < 8 && nc < 8 && grid[nr * 8 + nc] === 0;
            });
            if (fit) return true;
        }
        return false;
    });

    if (!ok && !trayShapes.every(v => v === null)) {
        showToast(`ê²Œì„ ì˜¤ë²„! ìµœì¢… ì ìˆ˜: ${score}`);
        setTimeout(() => showScreen('home'), 3000);
    }
}

function confirmExit() {
    if (confirm("ê²Œì„ì„ ì¢…ë£Œí•˜ê³  í™ˆìœ¼ë¡œ ê°ˆê¹Œìš”? (ì§„í–‰ ìƒí™©ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)")) showScreen('home');
}

// ì˜¤ë‹µ í•´ì„¤ í‘œì‹œ
function showExpl(item) {
    const modal = document.getElementById('expl-modal');
    const ans = document.getElementById('expl-ans');
    const body = document.getElementById('expl-body');
    
    ans.innerText = item.a;
    body.innerHTML = '';
    
    if (item.explImg) {
        const img = document.createElement('img');
        img.src = item.explImg;
        img.style.width='100%';
        img.style.marginBottom='10px';
        img.style.borderRadius='5px';
        body.appendChild(img);
    }
    if (item.desc) {
        const txt = document.createElement('p');
        txt.innerText = item.desc;
        body.appendChild(txt);
    }
    modal.style.display = 'flex';
}

function playSound(type) {
    if (!audioContext) audioContext = new AudioCtx();
    if (audioContext.state === 'suspended') audioContext.resume();
    
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    osc.connect(gain); gain.connect(audioContext.destination);
    
    const t = audioContext.currentTime;
    
    if (type === 'click') {
        osc.frequency.setValueAtTime(400, t);
        osc.frequency.exponentialRampToValueAtTime(100, t + 0.1);
        gain.gain.setValueAtTime(0.1, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
        osc.start(t); osc.stop(t + 0.1);
    } else if (type === 'place') {
        osc.frequency.setValueAtTime(200, t);
        osc.frequency.linearRampToValueAtTime(50, t + 0.1);
        gain.gain.setValueAtTime(0.1, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.1);
        osc.type = 'triangle';
        osc.start(t); osc.stop(t + 0.1);
    } else if (type === 'clear') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(400, t);
        osc.frequency.linearRampToValueAtTime(800, t + 0.2);
        gain.gain.setValueAtTime(0.1, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.3);
        osc.start(t); osc.stop(t + 0.3);
    } else if (type === 'correct') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, t);
        osc.frequency.linearRampToValueAtTime(880, t + 0.1);
        gain.gain.setValueAtTime(0.1, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.3);
        osc.start(t); osc.stop(t + 0.3);
    } else if (type === 'wrong') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, t);
        osc.frequency.linearRampToValueAtTime(100, t + 0.3);
        gain.gain.setValueAtTime(0.1, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.3);
        osc.start(t); osc.stop(t + 0.3);
    }
}
</script>
</body>
</html>
