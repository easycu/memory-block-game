<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° í¼ì¦ PRO v7.5</title>
<style>
/* --- [1. ê¸°ë³¸ ì„¤ì • ë° ë³€ìˆ˜] --- */
:root{--p:#2e7d32;--s:#66bb6a;--bg:#e8f5e9;--grid-bg:#a5d6a7;--cell-bg:#c8e6c9;--bonus:#fdd835;--excel:#1b5e20;--text:#1b5e20;--danger:#ef5350;--overlay:rgba(0,0,0,0.6)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;user-select:none;touch-action:manipulation}
body{font-family:-apple-system,'Pretendard',sans-serif;background:var(--bg);color:var(--text);width:100vw;height:100dvh;display:flex;flex-direction:column;align-items:center;overflow:hidden;touch-action:none;overscroll-behavior:none}
.screen{display:none;width:100%;max-width:450px;padding:env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;height:100%;flex-direction:column;position:relative}
.active{display:flex}

/* --- [2. ê²Œì„ í™”ë©´ UI] --- */
.header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;min-height:70px;width:100%}
#grid-container{flex:1;display:flex;align-items:center;justify-content:center;width:100%;position:relative}
#grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;background:var(--grid-bg);padding:6px;border-radius:12px;width:100%;aspect-ratio:1/1}
.cell{background:var(--cell-bg);border-radius:4px;aspect-ratio:1/1;transition:.2s}
.cell.filled{background:var(--p);transform:scale(.95);box-shadow:0 2px 4px rgba(0,0,0,.1)}
.cell.bonus-filled{background:var(--bonus);transform:scale(.95)}
.cell.clearing{background:var(--s);transform:scale(1.1);filter:brightness(1.2)}
.cell.ghost{background:var(--p);opacity:.5;transform:scale(.95);box-shadow:inset 0 0 0 2px rgba(255,255,255,.3)}
.cell.ghost-bonus{background:var(--bonus);opacity:.6;transform:scale(.95)}

/* íŠ¸ë ˆì´ ë° ë¸”ë¡ ë¯¸ë¦¬ë³´ê¸° */
#tray{display:flex;justify-content:center;align-items:center;gap:8px;height:110px;margin-bottom:15px;background:#fff;border-radius:20px;padding:10px;width:100%;box-shadow:0 4px 10px rgba(0,0,0,.05)}
.shape-preview{width:75px;height:75px;display:grid;grid-template-columns:repeat(5,1fr);gap:1px;border-radius:10px;padding:4px;background:#fff}
.shape-preview.dragging{opacity:0;visibility:hidden}
.preview-cell{aspect-ratio:1/1}
.preview-cell.filled{background:var(--p);border-radius:1px}
.preview-cell.bonus{background:var(--bonus);border-radius:1px}

/* ë“œë˜ê·¸ í—¬í¼ (ë”°ë¼ë‹¤ë‹ˆëŠ” ë¸”ë¡) */
#drag-helper{position:fixed;z-index:1000;display:none;opacity:1;pointer-events:none}
#drag-helper .preview-cell.filled{background:rgba(46,125,50,0.1);border:3px solid var(--p);border-radius:4px;transform:scale(0.95);box-sizing:border-box}
#drag-helper .preview-cell.bonus{background:rgba(253,216,53,0.2);border:3px solid var(--bonus);border-radius:4px;transform:scale(0.95);box-sizing:border-box}

/* --- [3. ë²„íŠ¼ ë° ê³µí†µ UI] --- */
.menu-btn{width:100%;padding:16px;margin:8px 0;border:none;border-radius:15px;color:#fff;font-size:1.1rem;font-weight:bold;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform 0.1s}
.menu-btn:active{transform:scale(0.98)}
.menu-btn:disabled{background:#ccc !important;cursor:not-allowed;box-shadow:none}
.btn-game{background:var(--p)}
.btn-manage{background:#8d6e63}
.btn-blue{background:#1976d2}
.btn-outline{flex:1;min-width:30%;background:#fff;color:var(--text);border:3px solid #ccc;padding:18px 5px;border-radius:15px;font-size:1.1rem;font-weight:900;text-align:center}

/* --- [4. ê´€ë¦¬ì í™”ë©´ UI] --- */
.mode-select{display:flex;gap:10px;margin-bottom:15px}
.add-box{background:#fff;padding:15px;border-radius:15px;box-shadow:0 2px 10px rgba(0,0,0,.05);display:none}
.add-box.show{display:block}
.preview-area{width:100%;min-height:100px;background:#f5f5f5;border:2px dashed #ccc;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;position:relative;overflow:hidden}
.preview-img{max-width:100%;max-height:200px;object-fit:contain}
.img-placeholder{color:#888;font-size:0.9rem;text-align:center}

/* ë¬¸ì œ ëª©ë¡ ë¦¬ìŠ¤íŠ¸ */
.bulk-bar{display:flex;justify-content:space-between;align-items:center;background:#eee;padding:10px 15px;border-radius:10px;margin-bottom:10px}
.word-card{background:#fff;padding:15px;margin-bottom:10px;border-radius:12px;border-left:5px solid var(--p);box-shadow:0 2px 5px rgba(0,0,0,.05);position:relative;display:flex;align-items:center}
.word-content{flex:1;overflow:hidden}
.thumb-img{width:50px;height:50px;object-fit:cover;border-radius:5px;margin-right:10px;border:1px solid #ddd;background:#f0f0f0}
.chk-box{width:20px;height:20px;margin-right:15px;accent-color:var(--danger)}
.word-list-container{flex:1;overflow-y:auto;margin:15px 0;width:100%}

/* --- [5. ëª¨ë‹¬ UI] --- */
#quiz-modal, #crop-modal, #img-view-modal{position:fixed;top:0;left:0;width:100vw;height:100dvh;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9000;backdrop-filter:blur(5px)}
.modal-inner{background:#fff;padding:25px;border-radius:25px;width:90%;max-width:360px;display:flex;flex-direction:column;align-items:center;max-height:90vh;overflow-y:auto;position:relative}

/* í€´ì¦ˆ ìš”ì†Œ */
#q-display-area{width:100%;margin-bottom:15px;display:flex;flex-direction:column;align-items:center}
.q-img-main{max-width:100%;max-height:250px;object-fit:contain;border-radius:8px;margin-bottom:10px;cursor:zoom-in;border:1px solid #eee}
#q-text-main{width:100%;background:var(--bg);padding:15px;border-radius:12px;text-align:left;font-weight:500;white-space:pre-wrap;max-height:150px;overflow-y:auto}
#q-input{width:100%;height:50px;padding:12px;border:2px solid var(--grid-bg);border-radius:12px;font-size:1rem;margin-bottom:10px;resize:none}

/* ìë¥´ê¸°(Crop) Canvas */
#crop-canvas-container{position:relative;width:100%;max-height:60vh;overflow:hidden;background:#333;margin-bottom:10px;touch-action:none}
#crop-canvas{display:block;margin:0 auto;max-width:100%}

/* í•´ì„¤ ë° ê¸°íƒ€ */
.desc-box{margin-top:10px;padding:10px;background:#fff3e0;border-radius:10px;width:100%;display:none;font-size:0.9rem}
.desc-img{max-width:100%;margin-top:5px;border-radius:5px}

/* ì•Œë¦¼ ë° ì• ë‹ˆë©”ì´ì…˜ */
#toast-container{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:99999;pointer-events:none;display:flex;justify-content:center;width:100%}
.toast{background:rgba(46,125,50,.95);color:#fff;padding:12px 24px;border-radius:30px;font-weight:bold;opacity:0;transform:translateY(20px);transition:.3s}
.toast.show{opacity:1;transform:translateY(0)}
.toast.error{background:rgba(231,76,60,.95)}
.toast.success{background:rgba(67,160,71,.95)}
.toast.info{background:rgba(30,136,229,.95)}
@keyframes shake{0%{transform:translate(1px,1px)}10%{transform:translate(-1px,-2px)rotate(-1deg)}50%{transform:translate(-1px,2px)rotate(-1deg)}100%{transform:translate(1px,-2px)rotate(-1deg)}}
.shaking{animation:shake .5s}
.float-score{position:absolute;color:var(--bonus);font-weight:900;font-size:1.5rem;pointer-events:none;animation:up 1s ease-out forwards;z-index:100}
@keyframes up{to{opacity:0;transform:translateY(-50px)scale(1.5)}}

/* ì—‘ì…€ ë° ì…ë ¥ì°½ */
#excel-area{display:none;width:100%;background:#fff;padding:10px;border:2px dashed var(--excel);border-radius:10px;margin-bottom:15px}
#excel-input{width:100%;height:60px;padding:8px;border:1px solid #ccc;border-radius:5px;font-family:monospace;white-space:pre}
textarea{resize:none}

/* ë¡œë”© ì˜¤ë²„ë ˆì´ */
#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:100000;display:none;justify-content:center;align-items:center;color:#fff;font-weight:bold;flex-direction:column}
.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-bottom:15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>
</div>

<div id="drag-helper"></div>
<div id="toast-container"></div>

<div id="screen-home" class="screen active">
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center">
        <div style="font-size:4.5rem;margin-bottom:15px">ğŸ§©</div>
        <h1 style="color:var(--text)">ì•”ê¸° í¼ì¦ PRO v7.5</h1>
        <div style="background:#fff;padding:10px 25px;border-radius:15px;margin:20px 0;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,.05);color:var(--text)">BEST: <span id="high-score-home" style="color:var(--p)">0</span></div>
    </div>
    <div class="home-btns">
        <button id="btn-start-game" class="menu-btn btn-game" onclick="startGame()" disabled>ê²Œì„ ì‹œì‘ (ë¡œë”© ì¤‘...)</button>
        <button id="btn-review" class="menu-btn" style="background:#ef5350" onclick="startReviewMode()" disabled>ğŸ”¥ ì˜¤ë‹µ ë…¸íŠ¸ (0)</button>
        <button id="btn-manage-home" class="menu-btn btn-manage" onclick="showScreen('manage')" disabled>ë¬¸ì œ ê´€ë¦¬</button>
    </div>
    <div style="font-size:0.7rem;color:#888;margin-top:10px">v7.5 (iOS Fix & UX Patch)</div>
</div>

<div id="screen-game" class="screen">
    <div class="header">
        <button onclick="confirmExit()" style="padding:8px 15px;border-radius:10px;border:none;background:#fff;font-weight:bold;color:var(--text);box-shadow:0 2px 5px rgba(0,0,0,.1)">ğŸ  í™ˆ</button>
        <div class="score-box">
            <div style="font-size:.7rem;color:#666;font-weight:bold">BEST <span id="high-score-game">0</span></div>
            <div style="font-weight:900;font-size:1.5rem;color:var(--p)" id="score">0</div>
        </div>
    </div>
    <div id="grid-container"><div id="grid"></div></div>
    <div id="tray"></div>
    <p style="font-size:.75rem;color:#888;text-align:center;margin-bottom:10px">ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì—¬ ì±„ìš°ì„¸ìš”</p>
</div>

<div id="screen-manage" class="screen">
    <h2 style="margin:15px 0;color:var(--text)">ë¬¸ì œ ê´€ë¦¬</h2>
    
    <div class="mode-select">
        <button class="menu-btn btn-game" style="margin:0;padding:10px;font-size:0.9rem" onclick="toggleAddMode('text')">ğŸ“ í…ìŠ¤íŠ¸ ë¬¸ì œ</button>
        <button class="menu-btn btn-blue" style="margin:0;padding:10px;font-size:0.9rem" onclick="toggleAddMode('image')">ğŸ“· ì´ë¯¸ì§€ ë¬¸ì œ</button>
    </div>

    <div id="add-text-box" class="add-box">
        <div style="display:flex;gap:5px;margin-bottom:5px">
            <textarea id="new-q" placeholder="ë¬¸ì œ (í…ìŠ¤íŠ¸)" style="flex:1;height:60px;padding:10px;border:1px solid #ddd;border-radius:8px"></textarea>
            <textarea id="new-a" placeholder="ì •ë‹µ" style="flex:1;height:60px;padding:10px;border:1px solid #ddd;border-radius:8px"></textarea>
        </div>
        <textarea id="new-desc" placeholder="í•´ì„¤ (ì„ íƒì‚¬í•­)" style="width:100%;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:5px"></textarea>
        <button onclick="addTextWord()" class="menu-btn btn-game" style="margin:5px 0;padding:10px">ë“±ë¡</button>
        
        <button class="menu-btn" style="background:var(--excel);margin:5px 0;padding:10px;font-size:0.9rem" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</button>
        <div id="excel-area">
            <p style="font-size:.75rem;color:var(--excel);margin-bottom:5px"><b>ì‚¬ìš©ë²•:</b> ì—‘ì…€ [ë¬¸ì œ] [ì •ë‹µ] ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°</p>
            <textarea id="excel-input" placeholder="Apple    ì‚¬ê³¼"></textarea>
            <button class="menu-btn btn-game" style="margin:5px 0;padding:8px;font-size:.8rem" onclick="parseExcel()">ì¼ê´„ ë“±ë¡</button>
        </div>
    </div>

    <div id="add-image-box" class="add-box">
        <div class="preview-area" id="p-area-q">
            <div class="img-placeholder">ë¬¸ì œ ì´ë¯¸ì§€ ì—†ìŒ<br>(ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€)</div>
            <button onclick="clearImage('q')" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.5);color:#fff;border:none;border-radius:50%;width:25px;height:25px;display:none;z-index:1">X</button>
            <img id="preview-q-img" class="preview-img" style="display:none">
        </div>
        <button class="menu-btn btn-blue" style="margin:0 0 10px 0;padding:10px" onclick="triggerCamera('question')">ğŸ“· ì´ë¯¸ì§€ ì´¬ì˜/ì„ íƒ</button>
        
        <textarea id="img-q-text" placeholder="ë¬¸ì œ í…ìŠ¤íŠ¸ (ì´ë¯¸ì§€ì™€ í•¨ê»˜ í‘œì‹œ)" style="width:100%;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:5px"></textarea>
        <textarea id="img-a" placeholder="ì •ë‹µ (í•„ìˆ˜)" style="width:100%;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:5px"></textarea>
        
        <div style="border-top:1px dashed #ccc;padding-top:10px;margin-top:5px">
            <div class="preview-area" id="p-area-desc" style="min-height:60px">
                <div class="img-placeholder" style="font-size:0.8rem">í•´ì„¤ ì´ë¯¸ì§€ ì—†ìŒ</div>
                <button onclick="clearImage('desc')" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.5);color:#fff;border:none;border-radius:50%;width:20px;height:20px;display:none;z-index:1">X</button>
                <img id="preview-desc-img" class="preview-img" style="display:none">
            </div>
            <div style="display:flex;gap:5px">
                <textarea id="img-desc-text" placeholder="í•´ì„¤ í…ìŠ¤íŠ¸" style="flex:1;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px"></textarea>
                <button class="menu-btn btn-manage" style="width:auto;margin:0;padding:10px;font-size:0.8rem" onclick="triggerCamera('explanation')">ğŸ“· í•´ì„¤<br>ì´ë¯¸ì§€</button>
            </div>
        </div>
        
        <button onclick="addImageWord()" class="menu-btn btn-game" style="margin-top:10px;padding:12px">ì´ë¯¸ì§€ ë¬¸ì œ ë“±ë¡</button>
    </div>

    <div style="margin-top:15px" class="bulk-bar">
        <label style="font-weight:bold;display:flex;align-items:center"><input type="checkbox" id="chk-all" class="chk-box" onchange="toggleSelectAll()"> ì „ì²´ ì„ íƒ</label>
        <button id="btn-del-sel" onclick="deleteSelected()" style="display:none;background:var(--danger);color:#fff;border:none;padding:8px 15px;border-radius:8px;font-weight:bold">ì‚­ì œ</button>
    </div>

    <div class="word-list-container" id="word-list"></div>
    
    <div class="file-ops">
        <button class="btn-outline" onclick="exportJSON()">ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn-outline" onclick="triggerFile('import')">ë®ì–´ì“°ê¸°</button>
        <button class="btn-outline" style="border-color:var(--p);color:var(--p)" onclick="triggerFile('append')">í•©ì¹˜ê¸°</button>
    </div>
    
    <input type="file" id="json-input" style="display:none" onchange="handleJsonFile(event)" accept=".json">
    <input type="file" id="camera-input" style="display:none" accept="image/*" onchange="handleImageFile(event)">
    <button class="menu-btn" style="background:#8d6e63;margin-top:10px" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
</div>

<div id="quiz-modal">
    <div class="modal-inner">
        <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <button id="q-exit-btn" onclick="quitReview()" style="background:none;border:none;font-size:0.9rem;color:#888;font-weight:bold;cursor:pointer;display:none">ğŸšª ë‚˜ê°€ê¸°</button>
            <h2 id="q-title" style="color:var(--p);font-size:1.3rem;margin:0">ë³µìŠµ íƒ€ì„!</h2>
            <div style="width:50px"></div>
        </div>

        <div id="q-display-area"></div>
        <div id="q-text-main"></div>
        <textarea id="q-input" placeholder="ì •ë‹µ ì…ë ¥"></textarea>
        <div id="q-feedback" style="margin-bottom:15px;font-weight:bold;font-size:.9rem;text-align:center"></div>
        <button id="q-submit" class="menu-btn btn-game" onclick="checkQuizAnswer()" style="margin:0;padding:12px">í™•ì¸</button>
        <button id="q-next" class="menu-btn btn-manage" style="display:none;margin:0;padding:12px" onclick="nextQuestion()">ë‹¤ìŒ</button>
        <div id="q-desc-area" class="desc-box"></div>
    </div>
</div>

<div id="crop-modal">
    <div class="modal-inner" style="background:#222;color:#fff;width:100%;height:100%;max-width:none;max-height:none;border-radius:0;justify-content:center">
        <h3 style="margin-bottom:10px">ì´ë¯¸ì§€ ìë¥´ê¸°</h3>
        <p style="font-size:0.8rem;color:#ccc;margin-bottom:10px">ì¤‘ì•™: ì´ë™ / ëª¨ì„œë¦¬(ğŸ”´): í¬ê¸° ì¡°ì ˆ</p>
        <div id="crop-canvas-container">
            <canvas id="crop-canvas"></canvas>
        </div>
        <div style="display:flex;gap:10px;width:100%;max-width:400px;margin-top:10px">
            <button class="menu-btn" style="background:#555;padding:10px" onclick="rotateImage()">ğŸ”„ íšŒì „</button>
            <button class="menu-btn btn-manage" style="padding:10px" onclick="closeCrop()">ì·¨ì†Œ</button>
            <button class="menu-btn btn-game" style="padding:10px" onclick="applyCrop()">ìë¥´ê¸° ì™„ë£Œ</button>
        </div>
    </div>
</div>

<div id="img-view-modal" onclick="closeImgView()">
    <img id="img-view-target" style="max-width:95%;max-height:95%;object-fit:contain;border-radius:10px">
    <button style="position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.7);color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-weight:bold;font-size:1.5rem">Ã—</button>
</div>
<script>
// ============================================================
// [íŒŒíŠ¸ 3] ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° ë° DB ì—”ì§„ (ìµœì í™” ì ìš©ë¨)
// ============================================================
let db;
const DB_NAME = "PuzzleProDB";
const DB_VERSION = 2; 
let vocabulary = [];
let isDBReady = false;

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
function showToast(m, t='normal'){
    const c = document.getElementById('toast-container');
    const e = document.createElement('div');
    e.className = `toast ${t}`;
    e.innerText = m;
    c.appendChild(e);
    c.style.zIndex = "99999";
    void e.offsetWidth;
    e.classList.add('show');
    setTimeout(()=>{
        e.classList.remove('show');
        setTimeout(()=>e.remove(), 300);
    }, 2000);
}

// ë¡œë”© ì˜¤ë²„ë ˆì´
function showLoading(show){
    document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}

// XSS ë°©ì–´
function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/[&<>"']/g, function(m) {
        return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m];
    });
}

// ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioContext = null;
function initAudio(){ if(!audioContext) audioContext = new AudioCtx(); if(audioContext.state === 'suspended') audioContext.resume(); }
const snd = {
    click: t=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(300,t+.1);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.01,t+.1);o.connect(g);g.connect(audioContext.destination);o.start(t);o.stop(t+.1)},
    place: t=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+.1);g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.01,t+.1);o.type='triangle';o.connect(g);g.connect(audioContext.destination);o.start(t);o.stop(t+.15)},
    clear: t=>{[523.25,659.25,783.99,1046.5].forEach((f,i)=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.value=f;g.gain.setValueAtTime(.1,t+i*.05);g.gain.exponentialRampToValueAtTime(.01,t+i*.05+.3);o.connect(g);g.connect(audioContext.destination);o.start(t+i*.05);o.stop(t+i*.05+.3)})},
    correct: t=>{[523.25,659.25,783.99].forEach((f,i)=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(.1,t+i*.1);g.gain.linearRampToValueAtTime(0,t+i*.1+.4);o.connect(g);g.connect(audioContext.destination);o.start(t+i*.1);o.stop(t+i*.1+.4)})},
    wrong: t=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.linearRampToValueAtTime(100,t+.3);g.gain.setValueAtTime(.1,t);g.gain.linearRampToValueAtTime(0,t+.3);o.connect(g);g.connect(audioContext.destination);o.start(t);o.stop(t+.3)}
};
function playSound(t){ if(audioContext) snd[t](audioContext.currentTime); }


// IndexedDB ì´ˆê¸°í™”
window.onload = function() {
    initDB();
    updateScores();
    window.addEventListener('mouseleave', ()=>{ if(isDragging) handleEnd({preventDefault:()=>{}}); });
};

function initDB() {
    showLoading(true);
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = function(e) {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('vocab')) {
            db.createObjectStore('vocab', { keyPath: 'id', autoIncrement: true });
        }
    };

    request.onsuccess = function(e) {
        db = e.target.result;
        const oldData = localStorage.getItem('myVocab');
        if (oldData) {
            try {
                const parsed = JSON.parse(oldData);
                if (parsed.length > 0) {
                    migrateData(parsed);
                    return;
                }
            } catch(err) { console.error(err); }
            localStorage.removeItem('myVocab');
        }
        loadVocabulary();
    };

    request.onerror = function(e) {
        showLoading(false);
        showToast("DB ì ‘ì† ì˜¤ë¥˜", 'error');
    };
}

function migrateData(data) {
    const transaction = db.transaction(['vocab'], 'readwrite');
    const store = transaction.objectStore('vocab');
    let cnt = 0;
    data.forEach(item => {
        item.type = item.type || 'text';
        delete item.id;
        store.add(item);
        cnt++;
    });
    transaction.oncomplete = function() {
        localStorage.removeItem('myVocab');
        showToast(`ë°ì´í„° ìµœì í™” ì™„ë£Œ (${cnt}ê±´)`, 'success');
        loadVocabulary();
    };
    transaction.onerror = function() {
        showLoading(false);
        showToast("ë°ì´í„° ì´ì‚¬ ì‹¤íŒ¨", 'error');
    }
}

function loadVocabulary() {
    const transaction = db.transaction(['vocab'], 'readonly');
    const store = transaction.objectStore('vocab');
    const request = store.getAll();

    request.onsuccess = function() {
        vocabulary = request.result || [];
        isDBReady = true;
        showLoading(false);
        
        // ë²„íŠ¼ í™œì„±í™”
        const startBtn = document.getElementById('btn-start-game');
        if(startBtn) {
            startBtn.disabled = false;
            startBtn.innerText = "ê²Œì„ ì‹œì‘";
        }
        
        updateReviewBtn();
        const manageBtn = document.getElementById('btn-manage-home');
        if(manageBtn) manageBtn.disabled = false;
        
        if(document.getElementById('screen-manage').classList.contains('active')) {
            renderWordList();
        }
    };
}

function updateReviewBtn() {
    const wrongCnt = vocabulary.filter(v => (v.wrongCount || 0) > 0).length;
    const revBtn = document.getElementById('btn-review');
    if(revBtn) {
        revBtn.innerText = `ğŸ”¥ ì˜¤ë‹µ ë…¸íŠ¸ (${wrongCnt})`;
        revBtn.disabled = wrongCnt === 0;
        revBtn.style.opacity = wrongCnt > 0 ? '1' : '0.6';
    }
}

function saveToDB(item, callback) {
    if(!isDBReady) return;
    const transaction = db.transaction(['vocab'], 'readwrite');
    const store = transaction.objectStore('vocab');
    
    transaction.onabort = function(e) {
        if(e.target.error && e.target.error.name === 'QuotaExceededError') {
            showToast("ìš©ëŸ‰ ë¶€ì¡±! ë¬¸ì œë¥¼ ì‚­ì œí•˜ì„¸ìš”.", 'error');
        }
    };

    const req = store.put(item); 
    req.onsuccess = function() {
        // UI ì¦‰ì‹œ ë°˜ì˜ì„ ìœ„í•œ ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸ (DB ì¬ë¡œë”© ì•„ë‹˜)
        // ì•ˆì „í•˜ê²Œ ì¬ë¡œë”©í•˜ë˜, ëŒ€ëŸ‰ ì‘ì—… ì•„ë‹ˆë¯€ë¡œ OK
        const t = db.transaction(['vocab'], 'readonly');
        t.objectStore('vocab').getAll().onsuccess = function(e) {
            vocabulary = e.target.result || [];
            updateReviewBtn(); 
            if(callback) callback();
        }
    };
}

// [ìµœì í™”ë¨] ëŒ€ëŸ‰ ì‚­ì œ
function deleteFromDB(ids) {
    showLoading(true);
    const transaction = db.transaction(['vocab'], 'readwrite');
    const store = transaction.objectStore('vocab');
    
    ids.forEach(id => {
        store.delete(id);
    });

    transaction.oncomplete = function() {
        const idSet = new Set(ids);
        vocabulary = vocabulary.filter(v => !idSet.has(v.id));
        
        if(document.getElementById('screen-manage').classList.contains('active')) {
            renderWordList();
        }
        updateReviewBtn();
        showLoading(false);
        showToast(`${ids.length}ê°œ ì‚­ì œ ì™„ë£Œ`, 'success');
    };
    
    transaction.onerror = function() {
        showLoading(false);
        showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'error');
    };
}

function overwriteDB(newData) {
    showLoading(true);
    const transaction = db.transaction(['vocab'], 'readwrite');
    const store = transaction.objectStore('vocab');
    
    store.clear().onsuccess = function() {
        newData.forEach(item => {
            delete item.id;
            store.add(item);
        });
    };
    
    transaction.oncomplete = function() {
        loadVocabulary();
        showToast("ë³µêµ¬ ì™„ë£Œ", 'success');
    };
}

// ============================================================
// [íŒŒíŠ¸ 4] ì´ë¯¸ì§€ ì—”ì§„ ë° ê´€ë¦¬ ë¡œì§
// ============================================================
let currentCropBlob = null;
let currentCropType = null;
let cropImg = new Image();
let cropCanvas = document.getElementById('crop-canvas');
let cropCtx = cropCanvas.getContext('2d');
let rotationAngle = 0;
let cropRect = {x:50, y:50, w:150, h:150};
let cropDragMode = 'none';
let dragStart = {x:0, y:0};
let initialRect = {x:0, y:0, w:0, h:0};

// ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
function toggleAddMode(mode) {
    const targetId = mode === 'text' ? 'add-text-box' : 'add-image-box';
    const targetBox = document.getElementById(targetId);
    const isAlreadyOpen = targetBox.classList.contains('show');

    document.querySelectorAll('.add-box').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.mode-select .menu-btn').forEach(btn => btn.style.opacity = '0.5');

    if (!isAlreadyOpen) {
        targetBox.classList.add('show');
        if (mode === 'text') {
            document.querySelectorAll('.mode-select .menu-btn')[0].style.opacity = '1';
            clearImage('q'); clearImage('desc');
        } else {
            document.querySelectorAll('.mode-select .menu-btn')[1].style.opacity = '1';
        }
    }
}

function triggerCamera(type) {
    currentCropType = type;
    const input = document.getElementById('camera-input');
    input.value = '';
    input.click();
}

// ì•„ì´í° ê³ í•´ìƒë„ ëŒ€ì‘
function handleImageFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) return showToast("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", 'error');

    showLoading(true);

    const reader = new FileReader();
    reader.onload = function(event) {
        const tempImg = new Image();
        tempImg.onload = function() {
            const MAX_SIZE = 2048; 
            let width = tempImg.width;
            let height = tempImg.height;

            if (width > MAX_SIZE || height > MAX_SIZE) {
                if (width > height) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                else { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(tempImg, 0, 0, width, height);

            cropImg.src = canvas.toDataURL('image/jpeg', 0.9);
        }
        tempImg.onerror = function() {
            showLoading(false);
            showToast("ì´ë¯¸ì§€ ì½ê¸° ì‹¤íŒ¨", 'error');
        }
        tempImg.src = event.target.result;
    };
    reader.readAsDataURL(file);

    cropImg.onload = function() {
        showLoading(false);
        rotationAngle = 0;
        startCropping();
    };
    cropImg.onerror = function() { showLoading(false); };
    currentCropBlob = file;
}

function startCropping() {
    document.getElementById('crop-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    const cw = Math.min(window.innerWidth * 0.6, cropImg.width * 0.6);
    const ch = cw * 0.6;
    cropRect = { x: 50, y: 50, w: cw, h: ch };
    drawCropCanvas();
}

function drawCropCanvas() {
    const isVertical = rotationAngle % 180 !== 0;
    const w = isVertical ? cropImg.height : cropImg.width;
    const h = isVertical ? cropImg.width : cropImg.height;
    
    const container = document.getElementById('crop-canvas-container');
    const maxWidth = container.clientWidth;
    const maxHeight = window.innerHeight * 0.6;
    let scale = Math.min(maxWidth / w, maxHeight / h);
    
    const dpr = window.devicePixelRatio || 1;
    cropCanvas.width = w * dpr;
    cropCanvas.height = h * dpr;
    cropCanvas.style.width = (w * scale) + 'px';
    cropCanvas.style.height = (h * scale) + 'px';
    
    cropCtx.scale(dpr, dpr);
    cropCtx.clearRect(0, 0, w, h);
    cropCtx.save();
    cropCtx.translate(w/2, h/2);
    cropCtx.rotate(rotationAngle * Math.PI / 180);
    cropCtx.drawImage(cropImg, -cropImg.width/2, -cropImg.height/2);
    cropCtx.restore();

    cropCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    cropCtx.fillRect(0, 0, w, h);

    cropCtx.clearRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
    cropCtx.strokeStyle = '#fff';
    cropCtx.lineWidth = 2;
    cropCtx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
    
    cropCtx.save();
    cropCtx.beginPath();
    cropCtx.rect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
    cropCtx.clip();
    cropCtx.translate(w/2, h/2);
    cropCtx.rotate(rotationAngle * Math.PI / 180);
    cropCtx.drawImage(cropImg, -cropImg.width/2, -cropImg.height/2);
    cropCtx.restore();

    cropCtx.fillStyle = '#ef5350';
    cropCtx.beginPath();
    cropCtx.arc(cropRect.x + cropRect.w, cropRect.y + cropRect.h, 10, 0, Math.PI*2);
    cropCtx.fill();
    cropCtx.strokeStyle = '#fff';
    cropCtx.stroke();
}

function rotateImage() {
    rotationAngle = (rotationAngle + 90) % 360;
    cropRect = {x:50, y:50, w:100, h:100};
    drawCropCanvas();
}

function applyCrop() {
    showLoading(true);
    setTimeout(() => {
        const tempCanvas = document.createElement('canvas');
        const maxDim = 800;
        let rw = cropRect.w;
        let rh = cropRect.h;
        if (rw > maxDim || rh > maxDim) {
            const ratio = Math.min(maxDim / rw, maxDim / rh);
            rw *= ratio; rh *= ratio;
        }
        
        tempCanvas.width = rw;
        tempCanvas.height = rh;
        const tCtx = tempCanvas.getContext('2d');
        
        const isVertical = rotationAngle % 180 !== 0;
        const w = isVertical ? cropImg.height : cropImg.width;
        const h = isVertical ? cropImg.width : cropImg.height;
        
        const sourceCanvas = document.createElement('canvas');
        sourceCanvas.width = w;
        sourceCanvas.height = h;
        const sCtx = sourceCanvas.getContext('2d');
        sCtx.translate(w/2, h/2);
        sCtx.rotate(rotationAngle * Math.PI / 180);
        sCtx.drawImage(cropImg, -cropImg.width/2, -cropImg.height/2);
        
        tCtx.drawImage(sourceCanvas, 
            cropRect.x, cropRect.y, cropRect.w, cropRect.h, 
            0, 0, rw, rh
        );
        
        const base64 = tempCanvas.toDataURL('image/jpeg', 0.7);
        
        if (currentCropType === 'question') {
            document.getElementById('preview-q-img').src = base64;
            document.getElementById('preview-q-img').style.display = 'block';
            document.querySelector('#p-area-q .img-placeholder').style.display = 'none';
            document.querySelector('#p-area-q button').style.display = 'block';
        } else {
            document.getElementById('preview-desc-img').src = base64;
            document.getElementById('preview-desc-img').style.display = 'block';
            document.querySelector('#p-area-desc .img-placeholder').style.display = 'none';
            document.querySelector('#p-area-desc button').style.display = 'block';
        }
        
        closeCrop();
        showLoading(false);
    }, 100);
}

function closeCrop() {
    document.getElementById('crop-modal').style.display = 'none';
    document.body.style.overflow = '';
}

const cropContainer = document.getElementById('crop-canvas-container');

cropContainer.addEventListener('pointerdown', e => {
    const rect = cropCanvas.getBoundingClientRect();
    const scaleX = cropCanvas.width / rect.width / (window.devicePixelRatio||1);
    const scaleY = cropCanvas.height / rect.height / (window.devicePixelRatio||1);
    
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    
    const handleDist = Math.sqrt(Math.pow(x - (cropRect.x + cropRect.w), 2) + Math.pow(y - (cropRect.y + cropRect.h), 2));
    
    if (handleDist < 25 * scaleX) {
        cropDragMode = 'resize';
    } else if (x >= cropRect.x && x <= cropRect.x + cropRect.w && y >= cropRect.y && y <= cropRect.y + cropRect.h) {
        cropDragMode = 'move';
    } else {
        cropDragMode = 'none';
        return;
    }
    
    dragStart = { x: e.clientX, y: e.clientY };
    initialRect = { ...cropRect };
    e.preventDefault();
});

window.addEventListener('pointermove', e => {
    if (cropDragMode === 'none') return;
    
    const rect = cropCanvas.getBoundingClientRect();
    const scaleX = cropCanvas.width / rect.width / (window.devicePixelRatio||1);
    const scaleY = cropCanvas.height / rect.height / (window.devicePixelRatio||1);
    
    const dx = (e.clientX - dragStart.x) * scaleX;
    const dy = (e.clientY - dragStart.y) * scaleY;
    
    const cw = cropCanvas.width / (window.devicePixelRatio||1);
    const ch = cropCanvas.height / (window.devicePixelRatio||1);

    if (cropDragMode === 'move') {
        let nx = initialRect.x + dx;
        let ny = initialRect.y + dy;
        nx = Math.max(0, Math.min(cw - initialRect.w, nx));
        ny = Math.max(0, Math.min(ch - initialRect.h, ny));
        cropRect.x = nx;
        cropRect.y = ny;
    } else if (cropDragMode === 'resize') {
        let nw = initialRect.w + dx;
        let nh = initialRect.h + dy;
        nw = Math.max(50, Math.min(cw - initialRect.x, nw));
        nh = Math.max(50, Math.min(ch - initialRect.y, nh));
        cropRect.w = nw;
        cropRect.h = nh;
    }
    drawCropCanvas();
});
window.addEventListener('pointerup', () => cropDragMode = 'none');

function clearImage(type) {
    if (type === 'q') {
        document.getElementById('preview-q-img').src = "";
        document.getElementById('preview-q-img').style.display = 'none';
        document.querySelector('#p-area-q .img-placeholder').style.display = 'block';
        document.querySelector('#p-area-q button').style.display = 'none';
    } else {
        document.getElementById('preview-desc-img').src = "";
        document.getElementById('preview-desc-img').style.display = 'none';
        document.querySelector('#p-area-desc .img-placeholder').style.display = 'block';
        document.querySelector('#p-area-desc button').style.display = 'none';
    }
}

function addTextWord() {
    const q = document.getElementById('new-q').value.trim();
    const a = document.getElementById('new-a').value.trim();
    const d = document.getElementById('new-desc').value.trim();
    if (q && a) {
        if (isDuplicate(q, a)) return showToast("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.", 'error');
        saveToDB({ type: 'text', q: escapeHtml(q), a: escapeHtml(a), desc: escapeHtml(d), wrongCount: 0 }, () => {
            document.getElementById('new-q').value = "";
            document.getElementById('new-a').value = "";
            document.getElementById('new-desc').value = "";
            showToast("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
        });
    } else showToast("ë¬¸ì œì™€ ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.", 'error');
}

function addImageWord() {
    const imgSrc = document.getElementById('preview-q-img').src;
    const qText = document.getElementById('img-q-text').value.trim();
    const a = document.getElementById('img-a').value.trim();
    const dText = document.getElementById('img-desc-text').value.trim();
    const dImgSrc = document.getElementById('preview-desc-img').src;
    
    if (!imgSrc || imgSrc.length < 100) return showToast("ë¬¸ì œ ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!", 'error');
    if (!a) return showToast("ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!", 'error');
    
    saveToDB({
        type: 'image',
        q: imgSrc,
        qText: escapeHtml(qText),
        a: escapeHtml(a),
        desc: escapeHtml(dText),
        descImg: (dImgSrc && dImgSrc.length > 100) ? dImgSrc : null,
        wrongCount: 0
    }, () => {
        clearImage('q'); clearImage('desc');
        document.getElementById('img-q-text').value = "";
        document.getElementById('img-a').value = "";
        document.getElementById('img-desc-text').value = "";
        showToast("ì´ë¯¸ì§€ ë¬¸ì œ ë“±ë¡ ì™„ë£Œ!", 'success');
    });
}

function isDuplicate(q, a) {
    const nQ = q.replace(/\s/g,"").toUpperCase();
    const nA = a.replace(/\s/g,"").toUpperCase();
    return vocabulary.some(v => v.type === 'text' && v.q.replace(/\s/g,"").toUpperCase() === nQ && v.a.replace(/\s/g,"").toUpperCase() === nA);
}

function renderWordList() {
    const list = document.getElementById('word-list');
    if (vocabulary.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:#888">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    list.innerHTML = vocabulary.map(v => {
        let contentHtml = v.type === 'image' ? 
            `<div style="display:flex;align-items:center"><img src="${v.q}" class="thumb-img"><div><b style="font-size:0.9rem">[ì´ë¯¸ì§€]</b><div style="font-size:0.8rem;color:#555">${v.qText?v.qText.substring(0,10)+'...':''}</div><small>ë‹µ:${v.a}</small></div></div>` : 
            `<div><b>${v.q}</b><br><small>${v.a}</small></div>`;
        return `<div class="word-card"><input type="checkbox" class="chk-box" value="${v.id}" onchange="updateBulkBtn()"><div class="word-content">${contentHtml}${v.wrongCount > 0 ? `<span style="color:var(--danger);font-size:0.7rem;margin-left:5px">ğŸ”¥(${v.wrongCount})</span>` : ''}</div></div>`;
    }).reverse().join('');
    document.getElementById('chk-all').checked = false;
    updateBulkBtn();
}

function updateBulkBtn() {
    const cnt = document.querySelectorAll('.chk-box:checked').length;
    document.getElementById('btn-del-sel').style.display = cnt > 0 ? 'block' : 'none';
    document.getElementById('btn-del-sel').innerText = `ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ (${cnt})`;
}
function toggleSelectAll() {
    const all = document.getElementById('chk-all').checked;
    document.querySelectorAll('.chk-box').forEach(c => c.checked = all);
    updateBulkBtn();
}
function deleteSelected() {
    const chks = document.querySelectorAll('.chk-box:checked');
    if (chks.length === 0) return;
    if (confirm(`${chks.length}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        deleteFromDB(Array.from(chks).map(c => parseInt(c.value)));
    }
}

function exportJSON() {
    if (vocabulary.length === 0) return showToast("ë°ì´í„° ì—†ìŒ", 'error');
    showLoading(true);
    setTimeout(() => {
        try {
            const blob = new Blob([JSON.stringify(vocabulary)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `quiz_backup_v7_5.json`;
            a.click();
            showToast("ë°±ì—… ì™„ë£Œ", 'success');
        } catch(e) { showToast("ë°±ì—… ì‹¤íŒ¨", 'error'); }
        showLoading(false);
    }, 100);
}

function triggerFile(mode) {
    const input = document.getElementById('json-input');
    input.dataset.mode = mode;
    input.value = '';
    input.click();
}

function handleJsonFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    showLoading(true);
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = JSON.parse(ev.target.result);
            if (!Array.isArray(data)) throw new Error("Invalid");
            const mode = document.getElementById('json-input').dataset.mode;
            if (mode === 'import') {
                if (confirm("ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?")) overwriteDB(data);
                else showLoading(false);
            } else {
                let c = 0; data.forEach(i => { delete i.id; saveToDB(i); c++; });
                showLoading(false); showToast(`${c}ê°œ ì¶”ê°€ë¨`, 'success');
            }
        } catch (err) { showLoading(false); showToast("íŒŒì¼ ì˜¤ë¥˜", 'error'); }
    };
    reader.readAsText(file);
}

function toggleExcel() {
    const e = document.getElementById('excel-area');
    e.style.display = e.style.display === 'none' ? 'block' : 'none';
}
function parseExcel() {
    const r = document.getElementById('excel-input').value;
    if(!r.trim()) return showToast("ë‚´ìš© ì—†ìŒ", 'error');
    const rows = r.split('\n');
    let c = 0;
    rows.forEach(w => {
        const s = w.split('\t');
        if(s.length >= 2) {
            const q = s[0].trim(), a = s[1].trim();
            if(q && a && !isDuplicate(q, a)) { saveToDB({type:'text', q, a, wrongCount:0}); c++; }
        }
    });
    document.getElementById('excel-input').value = "";
    showToast(`${c}ê°œ ì¶”ê°€ë¨`, 'success');
    toggleExcel();
}
// ============================================================
// [íŒŒíŠ¸ 5] ê²Œì„ ë¡œì§ (í¼ì¦ + í€´ì¦ˆ + ë³µìŠµ ëª¨ë“œ)
// ============================================================
const SHAPES = [
    [[0,0],[0,1],[1,0],[1,1]], // O
    [[0,0],[1,0],[2,0],[3,0],[4,0]], // I5
    [[0,0],[0,1],[0,2],[0,3],[0,4]], // I5-hor
    [[0,0],[1,0],[2,0]], // I3
    [[0,0],[0,1],[0,2]], // I3-hor
    [[0,0],[1,0],[2,0],[2,1],[2,2]], // L
    [[0,0],[0,1],[0,2],[1,2],[2,2]], // L-rev
    [[0,0],[1,1],[2,2],[3,3]], // Diagonal
    [[0,2],[1,2],[2,0],[2,1],[2,2]], // U
    [[0,1],[1,0],[1,1],[1,2],[2,1]], // +
    [[0,0],[0,1],[1,1],[1,2],[2,2]], // Z
    [[0,0],[1,0],[1,1]], // Small L
    [[0,0],[0,1],[1,0]], // Small L-rev
    [[0,0],[0,1],[0,2],[0,3]], // I4
    [[0,0],[1,0],[2,0],[3,0]], // I4-vert
    [[0,0]] // Dot
];

let score = 0, highScore = localStorage.getItem('puzzleBestV7') || 0;
let grid = Array(64).fill(0);
let trayShapes = [];
let quizDeck = [];
let curQuiz = 0, quizCorrect = 0, sessionQuizzes = [];
let isReviewMode = false;
let isDragging = false, dragShapeIndex = null, ghostIndices = [];
let masterR = 0, masterC = 0;
const TOUCH_OFFSET = 80;

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
    window.scrollTo(0, 0);
    updateScores();
    if (id === 'manage') renderWordList();
    if (id === 'home') updateReviewBtn();
}

function updateScores() {
    document.getElementById('high-score-home').innerText = highScore;
    document.getElementById('high-score-game').innerText = highScore;
    document.getElementById('score').innerText = score;
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function fillDeck() {
    quizDeck = [];
    for (let i = 0; i < vocabulary.length; i++) quizDeck.push(i);
    shuffle(quizDeck);
}

// [ê²Œì„ ëª¨ë“œ] í€´ì¦ˆ ì‹œì‘
function startQuiz() {
    if (vocabulary.length < 1) { refillTray(3); return; }
    
    isReviewMode = false;
    document.getElementById('q-exit-btn').style.display = 'none'; // ê²Œì„ ì¤‘ì—” ë‚˜ê°€ê¸° ìˆ¨ê¹€
    
    curQuiz = 0;
    quizCorrect = 0;
    let f = [];
    
    // ì˜¤ë‹µ ìš°ì„  ì¶œì œ
    let w = vocabulary.map((v, i) => ({ idx: i, wrong: v.wrongCount })).filter(v => v.wrong > 0).map(v => v.idx);
    if (w.length > 0) f.push(w[Math.floor(Math.random() * w.length)]);
    
    while (f.length < 3) {
        if (quizDeck.length === 0) fillDeck();
        const n = quizDeck.pop();
        if (vocabulary[n] && !f.includes(n)) f.push(n);
        if (f.length < 3 && vocabulary.length < 3 && quizDeck.length === 0) break;
    }
    
    shuffle(f);
    sessionQuizzes = f.map(i => vocabulary[i]);
    
    document.getElementById('quiz-modal').style.display = 'flex';
    showQuestion();
}

// [ë³µìŠµ ëª¨ë“œ] ì˜¤ë‹µ ë…¸íŠ¸ ì‹œì‘
function startReviewMode() {
    const wrongItems = vocabulary.filter(v => (v.wrongCount||0) > 0);
    if (wrongItems.length === 0) return showToast("í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!", 'success');
    
    isReviewMode = true;
    document.getElementById('q-exit-btn').style.display = 'block'; // ë‚˜ê°€ê¸° ë²„íŠ¼ í‘œì‹œ
    
    curQuiz = 0;
    quizCorrect = 0;
    sessionQuizzes = shuffle([...wrongItems]);
    
    document.getElementById('quiz-modal').style.display = 'flex';
    showQuestion();
}

// ë³µìŠµ ëª¨ë“œ ë‚˜ê°€ê¸°
function quitReview() {
    document.getElementById('quiz-modal').style.display = 'none';
    showScreen('home');
    updateReviewBtn();
}

function showQuestion() {
    if (!sessionQuizzes[curQuiz]) return;
    const q = sessionQuizzes[curQuiz];
    const total = sessionQuizzes.length;
    
    document.getElementById('q-title').innerText = isReviewMode ? 
        `ì˜¤ë‹µ ë³µìŠµ (${curQuiz + 1}/${total})` : 
        `í€´ì¦ˆ (${curQuiz + 1}/3)`;
    
    const displayArea = document.getElementById('q-display-area');
    const textArea = document.getElementById('q-text-main');
    
    displayArea.innerHTML = "";
    textArea.innerHTML = "";
    
    if (q.type === 'image') {
        const img = document.createElement('img');
        img.src = q.q;
        img.className = 'q-img-main';
        img.onclick = () => showImgView(q.q);
        displayArea.appendChild(img);
        
        const zoomHint = document.createElement('div');
        zoomHint.innerText = "ğŸ” í„°ì¹˜í•˜ì—¬ í™•ëŒ€";
        zoomHint.style.fontSize = "0.8rem";
        zoomHint.style.color = "#888";
        displayArea.appendChild(zoomHint);
        
        if (q.qText) textArea.innerText = q.qText;
        else textArea.style.display = 'none';
    } else {
        textArea.style.display = 'block';
        textArea.innerText = q.q;
    }

    document.getElementById('q-input').value = "";
    document.getElementById('q-feedback').innerText = "";
    document.getElementById('q-desc-area').style.display = "none";
    document.getElementById('q-submit').style.display = "block";
    document.getElementById('q-next').style.display = "none";
}

function checkQuizAnswer() {
    const input = document.getElementById('q-input').value.trim();
    if (!input) return;
    
    const i = input.replace(/\s/g, "").toUpperCase();
    const qData = sessionQuizzes[curQuiz];
    const ra = qData.a.replace(/\s/g, "").toUpperCase();
    let isCorrect = (i === "O" || i === "X") ? (ra.charAt(0) === i) : (i === ra);
    
    const fb = document.getElementById('q-feedback');
    const descArea = document.getElementById('q-desc-area');
    
    if (isCorrect) {
        quizCorrect++;
        playSound('correct');
        if (qData.wrongCount > 0) {
            qData.wrongCount--;
            saveToDB(qData);
        }
        fb.innerHTML = `<span style='color:var(--s)'>ì •ë‹µ! âœ¨<br>${qData.a}</span>`;
    } else {
        playSound('wrong');
        qData.wrongCount = (qData.wrongCount || 0) + 1;
        saveToDB(qData);
        fb.innerHTML = `<span style='color:var(--danger)'>ì˜¤ë‹µ! âŒ<br>${qData.a}</span>`;
    }

    if (qData.desc || qData.descImg) {
        descArea.innerHTML = "";
        descArea.style.display = "block";
        if (qData.descImg) {
            const dImg = document.createElement('img');
            dImg.src = qData.descImg;
            dImg.className = 'desc-img';
            dImg.onclick = () => showImgView(qData.descImg);
            descArea.appendChild(dImg);
        }
        if (qData.desc) {
            const p = document.createElement('p');
            p.innerText = qData.desc;
            p.style.marginTop = "5px";
            descArea.appendChild(p);
        }
    }

    document.getElementById('q-submit').style.display = "none";
    document.getElementById('q-next').style.display = "block";
}

function nextQuestion() {
    curQuiz++;
    if (curQuiz < sessionQuizzes.length) {
        showQuestion();
    } else {
        document.getElementById('quiz-modal').style.display = 'none';
        
        if (isReviewMode) {
            showToast("ë³µìŠµ ì™„ë£Œ! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.", 'success');
            showScreen('home');
            updateReviewBtn();
        } else {
            if (quizCorrect >= 2) refillTray(quizCorrect);
            else {
                showToast("ë¶ˆí•©ê²©! ë‹¤ì‹œ ê³µë¶€í•˜ì„¸ìš”.", 'error');
                setTimeout(startQuiz, 1000);
            }
        }
    }
}

function refillTray(c) {
    trayShapes = [0, 1, 2].map(() => [...SHAPES[Math.floor(Math.random() * SHAPES.length)]]);
    if (c === 3) {
        const b = [[0, 0]]; b.isBonus = true; trayShapes.push(b);
    }
    renderTray();
    checkGameOver();
}

function renderTray() {
    const t = document.getElementById('tray');
    t.innerHTML = "";
    trayShapes.forEach((s, i) => {
        if (!s) return;
        const d = document.createElement('div');
        d.className = 'shape-preview';
        d.id = `shape-${i}`;
        d.addEventListener('touchstart', e => handleStart(e, i), { passive: false });
        d.addEventListener('mousedown', e => handleStart(e, i));
        
        for (let r = 0; r < 5; r++) for (let c = 0; c < 5; c++) {
            const el = document.createElement('div');
            const filled = s.some(p => p[0] === r && p[1] === c);
            el.className = filled ? (s.isBonus ? 'preview-cell filled bonus' : 'preview-cell filled') : 'preview-cell';
            d.appendChild(el);
        }
        t.appendChild(d);
    });
}

function handleStart(e, i) {
    if (e.cancelable) e.preventDefault();
    isDragging = true;
    dragShapeIndex = i;
    const s = trayShapes[i];
    const h = document.getElementById('drag-helper');
    h.innerHTML = "";
    
    const cs = document.querySelector('.cell').getBoundingClientRect().width;
    let minR=5, minC=5, maxR=-1, maxC=-1;
    s.forEach(p => {
        minR = Math.min(minR, p[0]); maxR = Math.max(maxR, p[0]);
        minC = Math.min(minC, p[1]); maxC = Math.max(maxC, p[1]);
    });
    
    let minDist = 999;
    s.forEach(p => {
        if (p[0] === maxR) {
            const dist = Math.abs(p[1] - (minC + maxC) / 2);
            if (dist < minDist) { minDist = dist; masterR = p[0]; masterC = p[1]; }
        }
    });

    h.style.display = "grid";
    h.style.gridTemplateRows = `repeat(${maxR - minR + 1},${cs}px)`;
    h.style.gridTemplateColumns = `repeat(${maxC - minC + 1},${cs}px)`;
    h.style.gap = "1px";
    h.style.width = (maxC - minC + 1) * cs + (maxC - minC) + 'px';
    h.style.height = (maxR - minR + 1) * cs + (maxR - minR) + 'px';

    for (let r = minR; r <= maxR; r++) for (let c = minC; c <= maxC; c++) {
        const el = document.createElement('div');
        const ip = s.some(p => p[0] === r && p[1] === c);
        el.className = ip ? (s.isBonus ? 'preview-cell filled bonus' : 'preview-cell filled') : 'preview-cell';
        if (!ip) el.style.visibility = "hidden";
        h.appendChild(el);
    }
    moveHelper(e);
    document.getElementById(`shape-${i}`).classList.add('dragging');
    playSound('click');
    ghostIndices = [];
}

function handleMove(e) {
    if (!isDragging) return;
    if (e.cancelable) e.preventDefault();
    moveHelper(e);
    updateGhost(e);
}

function handleEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    document.getElementById('drag-helper').style.display = "none";
    document.querySelectorAll('.shape-preview').forEach(el => el.classList.remove('dragging'));
    if (ghostIndices.length > 0) placeBlock(ghostIndices, trayShapes[dragShapeIndex]);
    else clearGhost();
    ghostIndices = [];
    dragShapeIndex = null;
}

function moveHelper(e) {
    const h = document.getElementById('drag-helper');
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const cs = document.querySelector('.cell').getBoundingClientRect().width;
    const s = trayShapes[dragShapeIndex];
    let minR=5, minC=5;
    s.forEach(p => { minR = Math.min(minR, p[0]); minC = Math.min(minC, p[1]); });
    const relX = (masterC - minC) * cs + (cs / 2);
    const relY = (masterR - minR) * cs + (cs / 2);
    h.style.left = (clientX - relX) + 'px';
    h.style.top = (clientY - TOUCH_OFFSET - relY) + 'px';
}

function updateGhost(e) {
    clearGhost();
    ghostIndices = [];
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const el = document.elementFromPoint(clientX, clientY - TOUCH_OFFSET);
    if (!el || !el.classList.contains('cell')) return;
    
    const id = parseInt(el.id.split('-')[1]);
    const tr = Math.floor(id / 8), tc = id % 8;
    const s = trayShapes[dragShapeIndex];
    const sr = tr - masterR, sc = tc - masterC;
    const inds = [];
    
    const fit = s.every(p => {
        const nr = p[0] + sr, nc = p[1] + sc;
        if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && grid[nr * 8 + nc] === 0) {
            inds.push(nr * 8 + nc); return true;
        }
        return false;
    });
    
    if (fit) {
        ghostIndices = inds;
        inds.forEach(i => document.getElementById('cell-' + i).classList.add(s.isBonus ? 'ghost-bonus' : 'ghost'));
    }
}

function clearGhost() {
    document.querySelectorAll('.cell').forEach(c => {
        c.classList.remove('ghost'); c.classList.remove('ghost-bonus');
    });
}

function placeBlock(indices, shape) {
    playSound('place');
    indices.forEach(x => {
        grid[x] = 1;
        document.getElementById('cell-' + x).className = shape.isBonus ? 'cell bonus-filled' : 'cell filled';
    });
    trayShapes[dragShapeIndex] = null;
    renderTray();
    checkLines();
    if (trayShapes.every(v => v === null)) setTimeout(startQuiz, 500);
    else checkGameOver();
}

function checkLines() {
    let r = [], c = [];
    for (let i = 0; i < 8; i++) {
        if (grid.slice(i * 8, i * 8 + 8).every(v => v === 1)) r.push(i);
        let col = [];
        for (let j = 0; j < 8; j++) col.push(grid[j * 8 + i]);
        if (col.every(v => v === 1)) c.push(i);
    }
    if (r.length + c.length > 0) {
        playSound('clear');
        const g = document.getElementById('grid');
        g.classList.remove('shaking'); void g.offsetWidth; g.classList.add('shaking');
        const sc = (r.length + c.length) * 10 * (r.length + c.length);
        score += sc; updateScores();
        const e = document.createElement('div');
        e.className = 'float-score'; e.innerText = `+${sc}`;
        document.getElementById('grid-container').appendChild(e);
        setTimeout(() => e.remove(), 1000);
        if (score > highScore) { highScore = score; localStorage.setItem('puzzleBestV7', highScore); }
    }
    r.forEach(i => { for (let k = 0; k < 8; k++) animateClear(i * 8 + k); });
    c.forEach(i => { for (let k = 0; k < 8; k++) animateClear(k * 8 + i); });
}

function animateClear(i) {
    grid[i] = 0;
    const e = document.getElementById('cell-' + i);
    e.classList.add('clearing');
    setTimeout(() => e.className = 'cell', 300);
}

function checkGameOver() {
    const ok = trayShapes.some(s => {
        if (!s) return false;
        for (let i = 0; i < 64; i++) {
            const r = Math.floor(i / 8), c = i % 8;
            if (s.every(p => {
                const nr = r + p[0], nc = c + p[1];
                return nr < 8 && nc < 8 && grid[nr * 8 + nc] === 0;
            })) return true;
        }
        return false;
    });
    if (!ok && !trayShapes.every(v => v === null)) {
        showToast(`ê²Œì„ ì¢…ë£Œ! ì ìˆ˜: ${score}`, 'info');
        setTimeout(() => showScreen('home'), 2000);
    }
}

function startGame() {
    if(!isDBReady) return showToast("ë°ì´í„° ë¡œë”© ì¤‘...", 'info');
    initAudio();
    if (vocabulary.length < 1) return showToast("ë¬¸ì œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!", 'error');
    showScreen('game');
    initGame();
}

function initGame() {
    score = 0;
    grid.fill(0);
    updateScores();
    const g = document.getElementById('grid');
    g.innerHTML = "";
    for (let i = 0; i < 64; i++) {
        const c = document.createElement('div'); c.className = 'cell'; c.id = 'cell-' + i; g.appendChild(c);
    }
    refillTray(0); fillDeck();
}

function confirmExit() { if (confirm("ë‚˜ê°ˆê¹Œìš”?")) showScreen('home'); }
function showImgView(src) { document.getElementById('img-view-target').src = src; document.getElementById('img-view-modal').style.display = 'flex'; }
function closeImgView() { document.getElementById('img-view-modal').style.display = 'none'; }

// ë¦¬ìŠ¤ë„ˆ í†µí•©
window.addEventListener('touchmove', handleMove, { passive: false });
window.addEventListener('touchend', handleEnd);
window.addEventListener('mousemove', e => { if (isDragging) { moveHelper(e); updateGhost(e); } });
window.addEventListener('mouseup', handleEnd);
</script>
</body>
</html>
